<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>è–›å®šè°”seeçŒ«</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/2.10.0/github-markdown.min.css">
    <meta name="description" content="">
    <meta charset="UTF-8" version="1">
    <meta name="baidu-site-verification" content="code-E5pfjV93p5">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <meta name="Keywords" content="ä¸ªäººåšå®¢, è–›å®šè°”seeçŒ«,ç¨‹åºå‘˜,java">
    
    <link rel="preload" href="/assets/css/0.styles.aea1a24b.css" as="style"><link rel="preload" href="/assets/js/app.b2a9dced.js" as="script"><link rel="preload" href="/assets/js/3.7270c5c5.js" as="script"><link rel="preload" href="/assets/js/1.86f97011.js" as="script"><link rel="preload" href="/assets/js/26.046385b9.js" as="script"><link rel="prefetch" href="/assets/js/10.0188dc47.js"><link rel="prefetch" href="/assets/js/11.274e70b6.js"><link rel="prefetch" href="/assets/js/12.9bb548a2.js"><link rel="prefetch" href="/assets/js/13.ef00f870.js"><link rel="prefetch" href="/assets/js/14.d5fa7e9a.js"><link rel="prefetch" href="/assets/js/15.729d8902.js"><link rel="prefetch" href="/assets/js/16.3658be7c.js"><link rel="prefetch" href="/assets/js/17.9d240430.js"><link rel="prefetch" href="/assets/js/18.90f7e5d0.js"><link rel="prefetch" href="/assets/js/19.e8e4b1ca.js"><link rel="prefetch" href="/assets/js/20.1a2b089f.js"><link rel="prefetch" href="/assets/js/21.0ca11c0b.js"><link rel="prefetch" href="/assets/js/22.7e317cd0.js"><link rel="prefetch" href="/assets/js/23.01922089.js"><link rel="prefetch" href="/assets/js/24.1135bf26.js"><link rel="prefetch" href="/assets/js/25.dd44a13f.js"><link rel="prefetch" href="/assets/js/27.4ca68015.js"><link rel="prefetch" href="/assets/js/28.0749fb47.js"><link rel="prefetch" href="/assets/js/29.1684ac0a.js"><link rel="prefetch" href="/assets/js/30.60cd061a.js"><link rel="prefetch" href="/assets/js/31.5c1442d4.js"><link rel="prefetch" href="/assets/js/32.b587fee5.js"><link rel="prefetch" href="/assets/js/33.3592fa9b.js"><link rel="prefetch" href="/assets/js/34.eddefbb5.js"><link rel="prefetch" href="/assets/js/35.2bfc62ae.js"><link rel="prefetch" href="/assets/js/36.01a0090f.js"><link rel="prefetch" href="/assets/js/37.0d94c8d3.js"><link rel="prefetch" href="/assets/js/38.46d41bba.js"><link rel="prefetch" href="/assets/js/39.476327db.js"><link rel="prefetch" href="/assets/js/4.e4abacbc.js"><link rel="prefetch" href="/assets/js/40.56b1bb90.js"><link rel="prefetch" href="/assets/js/41.4fea4004.js"><link rel="prefetch" href="/assets/js/42.62a34a43.js"><link rel="prefetch" href="/assets/js/43.2598f2a7.js"><link rel="prefetch" href="/assets/js/44.5fc686cc.js"><link rel="prefetch" href="/assets/js/45.77269aa3.js"><link rel="prefetch" href="/assets/js/46.71ad6d0e.js"><link rel="prefetch" href="/assets/js/47.0e8a00c3.js"><link rel="prefetch" href="/assets/js/48.8968248e.js"><link rel="prefetch" href="/assets/js/49.3487ca71.js"><link rel="prefetch" href="/assets/js/5.248a317b.js"><link rel="prefetch" href="/assets/js/50.bc5cb1ef.js"><link rel="prefetch" href="/assets/js/51.741aa8e9.js"><link rel="prefetch" href="/assets/js/52.78b61f4b.js"><link rel="prefetch" href="/assets/js/53.31c6c984.js"><link rel="prefetch" href="/assets/js/54.10aff6e1.js"><link rel="prefetch" href="/assets/js/55.285c807a.js"><link rel="prefetch" href="/assets/js/56.b850e917.js"><link rel="prefetch" href="/assets/js/57.56891f0c.js"><link rel="prefetch" href="/assets/js/58.74203d67.js"><link rel="prefetch" href="/assets/js/59.4e0ac007.js"><link rel="prefetch" href="/assets/js/6.ab70a287.js"><link rel="prefetch" href="/assets/js/7.5d305417.js"><link rel="prefetch" href="/assets/js/8.a8319ccc.js"><link rel="prefetch" href="/assets/js/9.aa723625.js">
    <link rel="stylesheet" href="/assets/css/0.styles.aea1a24b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-1156296a><div data-v-1156296a><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-1156296a data-v-1156296a><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-4e82dffc data-v-1156296a data-v-1156296a><h3 class="title" data-v-4e82dffc data-v-4e82dffc>è–›å®šè°”seeçŒ«</h3> <p class="description" data-v-4e82dffc data-v-4e82dffc></p> <label id="box" class="inputBox" data-v-4e82dffc data-v-4e82dffc><input type="password" value="" data-v-4e82dffc> <span data-v-4e82dffc>Konck! Knock!</span> <button data-v-4e82dffc>OK</button></label> <div class="footer" data-v-4e82dffc data-v-4e82dffc><span data-v-4e82dffc><i class="iconfont reco-theme" data-v-4e82dffc></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4e82dffc>vuePress-theme-reco</a></span> <span data-v-4e82dffc><i class="iconfont reco-copyright" data-v-4e82dffc></i> <a data-v-4e82dffc><span data-v-4e82dffc>è–›å®šè°”seeçŒ«</span>
          Â Â 
          <!---->
          2022
        </a></span></div></div> <div class="hide" data-v-1156296a><header class="navbar" data-v-1156296a><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/assets/img/logo.jpg" alt="è–›å®šè°”seeçŒ«" class="logo"> <span class="site-name">è–›å®šè°”seeçŒ«</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  æ ‡ç­¾
</a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-1156296a></div> <aside class="sidebar" data-v-1156296a><div class="personal-info-wrapper" data-v-828910c6 data-v-1156296a><img src="/assets/img/logo.jpg" alt="author-avatar" class="personal-img" data-v-828910c6> <h3 class="name" data-v-828910c6>
    è–›å®šè°”seeçŒ«
  </h3> <div class="num" data-v-828910c6><div data-v-828910c6><h3 data-v-828910c6>46</h3> <h6 data-v-828910c6>Articles</h6></div> <div data-v-828910c6><h3 data-v-828910c6>27</h3> <h6 data-v-828910c6>Tags</h6></div></div> <ul class="social-links" data-v-828910c6><li class="social-item" data-v-828910c6><i class="iconfont reco-github" style="color:#f8b26a;" data-v-828910c6></i></li><li class="social-item" data-v-828910c6><i class="iconfont reco-bilibili" style="color:#fb9b5f;" data-v-828910c6></i></li></ul> <hr data-v-828910c6></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  æ ‡ç­¾
</a></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-4e82dffc data-v-1156296a><h3 class="title" data-v-4e82dffc data-v-4e82dffc></h3> <!----> <label id="box" class="inputBox" data-v-4e82dffc data-v-4e82dffc><input type="password" value="" data-v-4e82dffc> <span data-v-4e82dffc>Konck! Knock!</span> <button data-v-4e82dffc>OK</button></label> <div class="footer" data-v-4e82dffc data-v-4e82dffc><span data-v-4e82dffc><i class="iconfont reco-theme" data-v-4e82dffc></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4e82dffc>vuePress-theme-reco</a></span> <span data-v-4e82dffc><i class="iconfont reco-copyright" data-v-4e82dffc></i> <a data-v-4e82dffc><span data-v-4e82dffc>è–›å®šè°”seeçŒ«</span>
          Â Â 
          <!---->
          2022
        </a></span></div></div> <div data-v-1156296a><main class="page" style="padding-right:0;"><section><div class="page-title"><h1 class="title"></h1> <div data-v-1ff7123e><i class="iconfont reco-account" data-v-1ff7123e><span data-v-1ff7123e>è–›å®šè°”seeçŒ«</span></i> <!----> <!----> <!----></div></div> <div class="theme-reco-content content__default"><h1 align="center">Redis</h1> <h2 id="_1-åˆå§‹redis"><a href="#_1-åˆå§‹redis" class="header-anchor">#</a> 1. åˆå§‹Redis</h2> <h3 id="_1-1-è®¤è¯†nosql"><a href="#_1-1-è®¤è¯†nosql" class="header-anchor">#</a> 1.1 è®¤è¯†NoSQL</h3> <table><thead><tr><th></th> <th>SQL</th> <th>NoSQL</th></tr></thead> <tbody><tr><td>æ•°æ®ç»“æ„</td> <td>ç»“æ„åŒ–(Structured)</td> <td>éç»“æ„åŒ–</td></tr> <tr><td>æ•°æ®å…³è”</td> <td>å…³è”çš„(Relational)</td> <td>æ— å…³è”çš„</td></tr> <tr><td>æŸ¥è¯¢æ–¹å¼</td> <td>SQLæŸ¥è¯¢</td> <td>éSQL</td></tr> <tr><td>äº‹åŠ¡ç‰¹æ€§</td> <td>ACID</td> <td>BASE</td></tr> <tr><td>å­˜å‚¨æ–¹å¼</td> <td>ç£ç›˜</td> <td>å†…å­˜</td></tr> <tr><td>æ‰©å±•æ€§</td> <td>å‚ç›´</td> <td>æ°´å¹³</td></tr> <tr><td>ä½¿ç”¨åœºæ™¯</td> <td>1.æ•°æ®ç»“æ„å›ºå®š<br>2.ç›¸å…³ä¸šåŠ¡å¯¹æ•°æ®å®‰å…¨æ€§ã€ä¸€è‡´æ€§è¦æ±‚è¾ƒé«˜</td> <td>1.æ•°æ®ç»“æ„ä¸å›ºå®š<br>2.å¯¹ä¸€è‡´æ€§ã€å®‰å…¨æ€§è¦æ±‚ä¸é«˜<br>3.å¯¹æƒ³èƒ½è¦æ±‚é«˜</td></tr></tbody></table> <h3 id="_1-2-è®¤è¯†redis"><a href="#_1-2-è®¤è¯†redis" class="header-anchor">#</a> 1.2 è®¤è¯†Redis</h3> <p><code>Redis</code>è¯ç”Ÿäº2009å¹´å…¨ç§°æ˜¯è¿œç¨‹è¯å…¸æœåŠ¡å™¨(<code>Remote Dictionary Server</code>)ï¼Œæ˜¯ä¸€ä¸ªåŸºäºå†…å­˜çš„é”®å€¼å‹<code>NoSQL</code>æ•°æ®åº“ã€‚</p> <p>ç‰¹ç‚¹ï¼š</p> <ol><li>é”®å€¼å‹<code>key-value</code>ï¼Œ<code>value</code>æ”¯æŒå¤šç§ä¸åŒçš„æ•°æ®ç»“æ„ï¼ŒåŠŸèƒ½ä¸°å¯Œ</li> <li>å•çº¿ç¨‹ï¼Œæ¯ä¸ªå‘½ä»¤å…·å¤‡åŸå­æ€§</li> <li>ä½å»¶è¿Ÿã€é€Ÿåº¦å¿«(åŸºäºå†…å­˜ã€<code>IO</code>å¤šè·¯å¤ç”¨ã€è‰¯å¥½çš„ç¼–ç )</li> <li>æ”¯æŒæ•°æ®æŒä¹…åŒ–</li> <li>æ”¯æŒä¸»ä»é›†ç¾¤ã€åˆ†ç‰‡é›†ç¾¤</li> <li>æ”¯æŒå¤šè¯­è¨€å®¢æˆ·ç«¯</li></ol> <h3 id="_1-3-rediså®‰è£…"><a href="#_1-3-rediså®‰è£…" class="header-anchor">#</a> 1.3 Rediså®‰è£…</h3> <ol><li><p>å®‰è£…<code>Redis</code>ä¾èµ–</p> <p><code>Redis</code>åŸºäº<code>C</code>è¯­è¨€ç¼–å†™ï¼Œé¦–å…ˆéœ€è¦å®‰è£…<code>Redis</code>æ‰€éœ€è¦çš„<code>GCC</code>ä¾èµ–</p> <div class="language-shell extra-class"><pre class="language-shell"><code>yum <span class="token function">install</span> -y gcc tcl
</code></pre></div></li> <li><p>è·å–<code>redis</code>æºç </p> <p><a href="https://redis.io/download/" target="_blank" rel="noopener noreferrer">ä¸‹è½½åœ°å€<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p>è§£å‹</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">tar</span> -zxvf redis-x.x.x.tar.gz
</code></pre></div></li> <li><p>è¿›å…¥è§£å‹ç›®å½•å¹¶æ‰§è¡Œ</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">make</span> <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token function">install</span>
</code></pre></div></li> <li><p>è¿›å…¥å®‰è£…ç›®å½•å¤‡ä»½é…ç½®æ–‡ä»¶</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">cp</span> redis.conf redis.conf.back
</code></pre></div></li> <li><p>ä¿®æ”¹é…ç½®æ–‡ä»¶</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># é»˜è®¤ä¸º127.0.0.1åªèƒ½æœ¬åœ°è®¿é—®</span>
<span class="token builtin class-name">bind</span> <span class="token number">0.0</span>.0.0

<span class="token comment"># å®ˆæŠ¤è¿›ç¨‹çš„æ–¹å¼å¯åŠ¨</span>
daemonize <span class="token function">yes</span>

<span class="token comment"># å¯†ç </span>
requirepass <span class="token number">123456</span>

<span class="token comment"># å½“å‰è¿è¡Œredis-serverçš„å·¥ä½œç›®å½•</span>
<span class="token function">dir</span> /usr/local/src/redis-6.2.7

<span class="token comment"># redisèƒ½å¤Ÿä½¿ç”¨çš„æœ€å¤§å†…å­˜</span>
maxmemory 512mb

<span class="token comment"># æ—¥å¿—æ–‡ä»¶,é»˜è®¤ä¸ºç©º,ä¸è®°å½•æ—¥å¿—,å¯ä»¥æŒ‡å®šæ—¥å¿—æ–‡ä»¶å</span>
logfile <span class="token string">&quot;redis.log&quot;</span>
</code></pre></div></li> <li><p>å¯åŠ¨<code>Redis</code></p> <div class="language-shell extra-class"><pre class="language-shell"><code>redis-server redis.conf
</code></pre></div></li> <li><p>æ³¨å†Œä¸ºç³»ç»ŸæœåŠ¡</p> <p>æ–°å»ºé…ç½®æ–‡ä»¶</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">vi</span> /etc/systemd/system/redis.service
</code></pre></div><p>å†…å®¹å¦‚ä¸‹</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>redis-server
<span class="token assign-left variable">After</span><span class="token operator">=</span>network.target

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">Type</span><span class="token operator">=</span>forking
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/local/bin/redis-server /usr/local/src/redis-6.2.7/redis.conf

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target
</code></pre></div><p>é‡æ–°åŠ è½½æœåŠ¡</p> <div class="language-shell extra-class"><pre class="language-shell"><code>systemctl daemon-reload
</code></pre></div><p>å¯åŠ¨æœåŠ¡</p> <div class="language-shell extra-class"><pre class="language-shell"><code>systemctl start redis
</code></pre></div></li></ol> <h3 id="_1-4-rediså®¢æˆ·ç«¯"><a href="#_1-4-rediså®¢æˆ·ç«¯" class="header-anchor">#</a> 1.4 Rediså®¢æˆ·ç«¯</h3> <h4 id="_1-4-1-rediså‘½ä»¤è¡Œå®¢æˆ·ç«¯"><a href="#_1-4-1-rediså‘½ä»¤è¡Œå®¢æˆ·ç«¯" class="header-anchor">#</a> 1.4.1 Rediså‘½ä»¤è¡Œå®¢æˆ·ç«¯</h4> <p><code>Redis</code>å®‰è£…å®Œæˆåå°±è‡ªå¸¦äº†å‘½ä»¤è¡Œå®¢æˆ·ç«¯ï¼š<code>redis-cli</code>ï¼Œä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š</p> <div class="language-shell extra-class"><pre class="language-shell"><code>redis-cli <span class="token punctuation">[</span>options<span class="token punctuation">]</span><span class="token punctuation">[</span>commonds<span class="token punctuation">]</span>
</code></pre></div><p>å…¶ä¸­å¸¸è§çš„<code>optons</code>æœ‰ï¼š</p> <ul><li><code>-h 127.0.0.1</code>ï¼šæŒ‡å®šè¿æ¥çš„<code>redis</code>èŠ‚ç‚¹çš„<code>IP</code>åœ°å€ï¼Œé»˜è®¤æ˜¯<code>127.0.0.1</code></li> <li><code>-p 6379</code>ï¼šæŒ‡å®šè¦è¿æ¥çš„<code>redis</code>èŠ‚ç‚¹çš„ç«¯å£ï¼Œé»˜è®¤<code>6379</code></li> <li><code>-a 123456</code>ï¼šæŒ‡å®š<code>redis</code>çš„è®¿é—®å¯†ç </li></ul> <p>å…¶ä¸­<code>commonds</code>å°±æ˜¯<code>Redis</code>çš„æ“ä½œå‘½ä»¤ï¼Œä¾‹å¦‚ï¼š</p> <ul><li><code>ping</code>ï¼šä¸<code>redis</code>æœåŠ¡ç«¯åšå¿ƒè·³æµ‹è¯•ï¼ŒæœåŠ¡ç«¯æ­£å¸¸ä¼šè¿”å›<code>pong</code></li></ul> <p>ä¸æŒ‡å®š<code>commond</code>æ—¶ï¼Œä¼šè¿›å…¥<code>redis-cli</code>çš„äº¤äº’æ§åˆ¶å°</p> <h4 id="_1-4-2-rediså›¾å½¢åŒ–å®¢æˆ·ç«¯"><a href="#_1-4-2-rediså›¾å½¢åŒ–å®¢æˆ·ç«¯" class="header-anchor">#</a> 1.4.2 Rediså›¾å½¢åŒ–å®¢æˆ·ç«¯</h4> <ol><li><a href="https://github.com/lework/RedisDesktopManager-Windows/releases" target="_blank" rel="noopener noreferrer">RedisDesktopManager-Windows<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://github.com/qishibo/AnotherRedisDesktopManager/releases" target="_blank" rel="noopener noreferrer">AnotherRedisDesktopManager<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ol> <h2 id="_2-rediså‘½ä»¤"><a href="#_2-rediså‘½ä»¤" class="header-anchor">#</a> 2. Rediså‘½ä»¤</h2> <h3 id="_2-1-redisæ•°æ®ç»“æ„"><a href="#_2-1-redisæ•°æ®ç»“æ„" class="header-anchor">#</a> 2.1 Redisæ•°æ®ç»“æ„</h3> <p><code>Redis</code>æ˜¯ä¸€ä¸ª<code>key-value</code>çš„æ•°æ®åº“ï¼Œ<code>key</code>ä¸€èˆ¬æ˜¯<code>String</code>ç±»å‹ï¼Œä¸è¿‡<code>value</code>çš„ç±»å‹å¤šç§å¤šæ ·</p> <div class="spinner" style="background:rgb(66, 185, 131);" data-v-1bbcb91a></div><h3 id="_2-2-redis-é€šç”¨æŒ‡ä»¤"><a href="#_2-2-redis-é€šç”¨æŒ‡ä»¤" class="header-anchor">#</a> 2.2 Redis é€šç”¨æŒ‡ä»¤</h3> <ul><li><p><code>auth</code>ï¼šæˆæƒ</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># è¾“å…¥redisçš„å¯†ç 123456</span>
AUTH <span class="token number">123456</span>
</code></pre></div></li> <li><p><code>help</code>ï¼šå¸®åŠ©æŒ‡ä»¤</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># æŸ¥çœ‹æ‰€æœ‰å‘½ä»¤</span>
HELP @generic

<span class="token comment"># æŸ¥çœ‹æŸä¸ªå‘½ä»¤</span>
HELP keys
</code></pre></div></li> <li><p><code>key</code>ï¼šæŸ¥çœ‹ç¬¦åˆæ¨¡æ¿çš„æ‰€æœ‰keyï¼Œä¸å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒè®¾å¤‡ä¸Šä½¿ç”¨</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># æŸ¥è¯¢æ‰€æœ‰çš„key</span>
KEYS *
</code></pre></div></li> <li><p><code>DEL</code>ï¼šåˆ é™¤ä¸€ä¸ªæŒ‡å®šçš„key</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># åˆ é™¤name</span>
DEL name
</code></pre></div></li> <li><p><code>exists</code>ï¼šåˆ¤æ–­ä¸€ä¸ªkeyæ˜¯å¦å­˜åœ¨</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># æŸ¥çœ‹nameæ˜¯å¦å­˜åœ¨</span>
EXISTS name
</code></pre></div></li> <li><p><code>expire</code>ï¼šç»™ä¸€ä¸ªkeyè®¾ç½®æœ‰æ•ˆæœŸï¼Œæœ‰æ•ˆæœŸåˆ°æœŸæ—¶è¯¥keyä¼šè¢«è‡ªåŠ¨åˆ é™¤</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># ç»™nameè®¾ç½®è¿‡æœŸæ—¶é—´ä¸º10s</span>
EXPIRE name <span class="token number">10</span>
</code></pre></div></li> <li><p><code>ttl</code>ï¼šæŸ¥çœ‹keyçš„è¿‡æœŸæ—¶é—´</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># æŸ¥çœ‹nameçš„è¿‡æœŸæ—¶é—´ -1è¡¨ç¤ºæ°¸ä¹…æœ‰æ•ˆ -2è¡¨ç¤ºå·²è¿‡æœŸ</span>
TTL name
</code></pre></div></li></ul> <h3 id="_2-3-stringç±»å‹"><a href="#_2-3-stringç±»å‹" class="header-anchor">#</a> 2.3 Stringç±»å‹</h3> <p><code>String</code>ç±»å‹ï¼Œä¹Ÿå°±æ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼Œæ˜¯<code>Redis</code>ä¸­æœ€ç®€å•çš„å­˜å‚¨ç±»å‹ï¼Œå…¶<code>value</code>æ˜¯å­—ç¬¦ä¸²ï¼Œä¸è¿‡æ ¹æ®å­—ç¬¦ä¸²çš„æ ¼å¼ä¸åŒï¼Œåˆå¯ä»¥åˆ†ä¸º3ç±»</p> <table><thead><tr><th>ç±»å‹</th> <th>è¯´æ˜</th> <th>key</th> <th>value</th></tr></thead> <tbody><tr><td>string</td> <td>æ™®é€šå­—ç¬¦ä¸²</td> <td>msg</td> <td>hello world</td></tr> <tr><td>int</td> <td>æ•´æ•°ç±»å‹ï¼Œå¯ä»¥åšè‡ªå¢ã€è‡ªå‡æ“ä½œ</td> <td>num</td> <td>10</td></tr> <tr><td>float</td> <td>æµ®ç‚¹ç±»å‹ï¼Œå¯ä»¥åšè‡ªå¢ã€è‡ªå‡æ“ä½œ</td> <td>score</td> <td>92.5</td></tr></tbody></table> <p>ä¸ç®¡æ˜¯é‚£ç§ç±»å‹ï¼Œåº•å±‚éƒ½æ˜¯å­—èŠ‚æ•°ç»„å½¢å¼å­˜å‚¨ï¼Œåªä¸è¿‡æ˜¯ç¼–ç æ–¹å¼ä¸åŒã€‚å­—ç¬¦ä¸²ç±»å‹çš„æœ€å¤§ç©ºé—´ä¸èƒ½è¶…è¿‡<code>512m</code></p> <ul><li><p><code>set</code>ï¼šæ·»åŠ æˆ–è€…ä¿®æ”¹å·²ç»å­˜åœ¨çš„ä¸€ä¸ªStringç±»å‹çš„é”®å€¼å¯¹</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># è®¾ç½®msgçš„å€¼ä¸ºhello worldæœ‰ç©ºæ ¼ä½¿ç”¨åŒå¼•å·åŒ…è£¹</span>
SET msg <span class="token string">&quot;hello world&quot;</span>
</code></pre></div></li> <li><p><code>get</code>ï¼šæ ¹æ®keyè·å–Stringç±»å‹çš„value</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># è·å–keyä¸ºmsgçš„å€¼</span>
GET msg
</code></pre></div></li> <li><p><code>mset</code>ï¼šæ‰¹é‡æ·»åŠ é”®å€¼å¯¹</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># æ·»åŠ nameçš„å€¼ä¸ºzhangsanï¼Œnumçš„å€¼ä¸º10</span>
MSET msg <span class="token string">&quot;hello world&quot;</span> num <span class="token number">10</span>
</code></pre></div></li> <li><p><code>mget</code>ï¼šæ‰¹é‡è·å–é”®å€¼å¯¹</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># è·å–msgå’Œnumçš„å€¼</span>
MGET msg num
</code></pre></div></li> <li><p><code>incr</code>ï¼šè®©ä¸€ä¸ªæ•´å‹keyè‡ªå¢1</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># numåŠ 1</span>
INCR num
</code></pre></div></li> <li><p><code>incrby</code>ï¼šè®©ä¸€ä¸ªæ•´å‹keyè‡ªå¢å¹¶æŒ‡å®šæ­¥é•¿</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># numåŠ 10</span>
INCRBY num <span class="token number">10</span>
</code></pre></div></li> <li><p><code>decr</code>ï¼šè®©ä¸€ä¸ªæ•´å‹keyè‡ªå‡1</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># numå‡1</span>
DECR num
</code></pre></div></li> <li><p><code>incrbyfloat</code>ï¼šè®©ä¸€ä¸ªæµ®ç‚¹å‹çš„keyè‡ªå¢å¹¶æŒ‡å®šæ­¥é•¿</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># socreåŠ 10</span>
INCRBYFLOAT socre <span class="token number">10</span>
</code></pre></div></li> <li><p><code>setnx</code>ï¼šæ·»åŠ ä¸€ä¸ªStringç±»å‹çš„é”®å€¼å¯¹ï¼Œå‰ææ˜¯è¿™ä¸ªkeyä¸å­˜åœ¨ï¼Œå¦åˆ™ä¸æ‰§è¡Œ</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># è®¾ç½®msgçš„å€¼ä¸ºhello world</span>
SETNX msg <span class="token string">&quot;hello world&quot;</span>
</code></pre></div></li> <li><p><code>setex</code>ï¼šæ·»åŠ ä¸€ä¸ªStringç±»å‹çš„é”®å€¼å¯¹ï¼Œå¹¶ä¸”æŒ‡å®šæœ‰æ•ˆæœŸ</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># è®¾ç½®numçš„å€¼ä¸º300è¿‡æœŸæ—¶é—´ä¸º20s</span>
SETEX num <span class="token number">20</span> <span class="token number">300</span>
</code></pre></div></li></ul> <h3 id="_2-4-hashç±»å‹"><a href="#_2-4-hashç±»å‹" class="header-anchor">#</a> 2.4 Hashç±»å‹</h3> <p><code>Hash</code>ç±»å‹ï¼Œä¹Ÿå«æ•£åˆ—ï¼Œå…¶<code>value</code>æ˜¯ä¸€ä¸ªæ— åºå­—å…¸ï¼Œç±»ä¼¼äº<code>Java</code>ä¸­çš„<code>HashMap</code>ç»“æ„</p> <p><code>String</code>ç»“æ„æ˜¯å°†å¯¹è±¡åºåˆ—åŒ–ä¸º<code>JSON</code>å­—ç¬¦ä¸²åå­˜å‚¨ï¼Œå½“éœ€è¦ä¿®æ”¹å¯¹è±¡æŸä¸ªå­—æ®µæ—¶å¾ˆä¸æ–¹ä¾¿ï¼š</p> <table><thead><tr><th>KEY</th> <th>VALUE</th></tr></thead> <tbody><tr><td>meinil:user:1</td> <td>{name: &quot;Jack&quot;, age: 21}</td></tr> <tr><td>meinil:user:2</td> <td>{name:&quot;Rose&quot;, age:18}</td></tr></tbody></table> <p><code>Hash</code>ç»“æ„å¯ä»¥å°†å¯¹è±¡ä¸­çš„æ¯ä¸ªå­—æ®µç‹¬ç«‹å­˜å‚¨ï¼Œå¯ä»¥é’ˆå¯¹å•ä¸ªå­—æ®µåš<code>CRUD</code>ï¼š</p> <table><tr><th rowspan="2">KEY</th> <th colspan="2">VALUE</th></tr> <tr><td>field</td> <td>value</td></tr> <tr><td rowspan="2">meinil:user:1</td> <td>name</td> <td>Jack</td></tr> <tr><td>age</td> <td>21</td></tr> <tr><td rowspan="2">meinil:user:2</td> <td>name</td> <td>Rose</td></tr> <tr><td>age</td> <td>18</td></tr></table>
- `hset`ï¼šæ·»åŠ æˆ–è€…ä¿®æ”¹hashç±»å‹keyçš„fieldå€¼
<div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># è®¾ç½®meinil:user:1çš„nameå­—æ®µçš„å€¼ä¸ºJack</span>
HSET meinil:user:1 name Jack
</code></pre></div><ul><li><p><code>hget</code>ï¼šè·å–hashç±»å‹æŸä¸€å­—æ®µçš„å€¼</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># è·å–meinil:user:1çš„nameå­—æ®µ</span>
HGET meinil:user:1 name
</code></pre></div></li> <li><p><code>hmset</code>ï¼šæ‰¹é‡è®¾ç½®hashå€¼</p> <div class="language-shell extra-class"><pre class="language-shell"><code>HMSET meinil:user:1 name Jack age <span class="token number">21</span> score <span class="token number">83.2</span>
</code></pre></div></li> <li><p><code>hmget</code>ï¼šæ‰¹é‡è·å–hashçš„å­—æ®µå€¼</p> <div class="language-shell extra-class"><pre class="language-shell"><code>HMGET meinil:user:1 name age score
</code></pre></div></li> <li><p><code>hgetall</code>ï¼šè·å–æŸä¸ªhashç±»å‹æ‰€æœ‰å­—æ®µå€¼</p> <div class="language-shell extra-class"><pre class="language-shell"><code>HGETALL meinil:user:1
</code></pre></div></li> <li><p><code>hkeys</code>ï¼šè·å–ä¸€ä¸ªhashç±»å‹çš„keyä¸­æ‰€æœ‰çš„field</p> <div class="language-shell extra-class"><pre class="language-shell"><code>HKEYS meinil:user:1
</code></pre></div></li> <li><p><code>hvals</code>ï¼šè·å–ä¸€ä¸ªhashç±»å‹çš„keyä¸­çš„æ‰€æœ‰value</p> <div class="language-shell extra-class"><pre class="language-shell"><code>HVALS meinil:user:1
</code></pre></div></li> <li><p><code>hincrby</code>ï¼šè®©ä¸€ä¸ªhashç±»å‹keyçš„å­—æ®µå€¼è‡ªå¢å¹¶æŒ‡å®šæ­¥é•¿</p> <div class="language-shell extra-class"><pre class="language-shell"><code>HINCRBY meinil:user:1 age <span class="token number">10</span>
</code></pre></div></li> <li><p><code>hsetnx</code>ï¼šæ·»åŠ ä¸€ä¸ªhashç±»å‹çš„keyçš„fieldå€¼ï¼Œå‰ææ˜¯è¿™ä¸ªfieldä¸å­˜åœ¨ï¼Œå¦åˆ™ä¸æ‰§è¡Œ</p> <div class="language-shell extra-class"><pre class="language-shell"><code>HSETNX meinil:user:1 sex <span class="token function">man</span>
</code></pre></div></li></ul> <h3 id="_2-5-listç±»å‹"><a href="#_2-5-listç±»å‹" class="header-anchor">#</a> 2.5 Listç±»å‹</h3> <p><code>Redis</code>ä¸­çš„<code>List</code>ç±»å‹ä¸<code>Java</code>ä¸­çš„<code>LinkedList</code>ç±»ä¼¼ï¼Œå¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ç»“æ„ã€‚æ—¢å¯ä»¥æ”¯æŒæ­£å‘æ£€ç´¢ä¹Ÿå¯ä»¥æ”¯æŒåå‘æ£€ç´¢</p> <p>ç‰¹å¾ä¸<code>LinkedList</code>ç±»ä¼¼</p> <ul><li>æœ‰åº</li> <li>å…ƒç´ å¯ä»¥é‡å¤</li> <li>æ’å…¥å’Œåˆ é™¤é€Ÿåº¦å¿«</li> <li>æŸ¥è¯¢é€Ÿåº¦ä¸€èˆ¬</li></ul> <p>å¸¸ç”¨æ¥å­˜å‚¨ä¸€ä¸ªæœ‰åºæ•°æ®ï¼Œä¾‹å¦‚ï¼šæœ‹å‹åœˆç‚¹èµåˆ—è¡¨ï¼Œè¯„è®ºåˆ—è¡¨ç­‰</p> <p><strong>Listå¸¸ç”¨å‘½ä»¤</strong></p> <ul><li><p><code>lpush</code>ï¼šå‘åˆ—è¡¨å·¦ä¾§æ’å…¥ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´ </p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># å‘keyä¸ºuserçš„å·¦ä¾§æ’å…¥jackã€rose</span>
LPUSH user jack rose
</code></pre></div></li> <li><p><code>lpop</code>ï¼šç§»é™¤å¹¶è¿”å›åˆ—è¡¨å·¦ä¾§çš„ç¬¬ä¸€å…ƒç´ ï¼Œæ²¡æœ‰åˆ™è¿”å›nil</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># ä»keyä¸ºuserçš„å·¦ä¾§ç§»é™¤ä¸€ä¸ªå…ƒç´ </span>
LPOP user
</code></pre></div></li> <li><p><code>rpush</code>ï¼šå‘åˆ—è¡¨å³ä¾§æ’å…¥ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´ </p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># å‘keyä¸ºuserçš„å³ä¾§æ’å…¥alice</span>
RPUSH user alice
</code></pre></div></li> <li><p><code>rpop</code>ï¼šç§»é™¤å¹¶è¿”å›åˆ—è¡¨å³ä¾§çš„ç¬¬ä¸€ä¸ªå…ƒç´ </p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># ä»keyä¸ºuserçš„å³ä¾§ç§»é™¤ä¸€ä¸ªå…ƒç´ </span>
RPOP user
</code></pre></div></li> <li><p><code>lrange</code>ï¼šè¿”å›ä¸€æ®µäº¤è¡¨èŒƒå›´å†…çš„æ‰€æœ‰å…ƒç´ ï¼Œä¸‹æ ‡ä»0å¼€å§‹</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># ä»keyä¸ºuserä¸­å–å‡ºèŒƒå›´1åˆ°2å†…çš„å…ƒç´ </span>
LRANGE user <span class="token number">1</span> <span class="token number">2</span>
</code></pre></div></li> <li><p><code>blpop</code>å’Œ<code>brpop</code>ï¼šä¸lpopå’Œrpopç±»ä¼¼ï¼Œåªä¸è¿‡åœ¨æ²¡æœ‰å…ƒç´ æ—¶ç­‰å¾…æŒ‡å®šæ—¶é—´ï¼Œè€Œä¸æ˜¯ç›´æ¥è¿”å›nil</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># ä»keyä¸ºuserçš„å·¦ä¾§ç§»é™¤ä¸€ä¸ªå…ƒç´ ,å¦‚æœæ²¡æœ‰åˆ™ç­‰å¾…100s</span>
BLPOP user <span class="token number">100</span>
</code></pre></div></li></ul> <h3 id="_2-6-setç±»å‹"><a href="#_2-6-setç±»å‹" class="header-anchor">#</a> 2.6 Setç±»å‹</h3> <p><code>Redis</code>çš„<code>Set</code>ç»“æ„ä¸<code>java</code>ä¸­çš„<code>HashSet</code>ç±»ä¼¼ï¼Œå¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ª<code>value</code>ä¸º<code>null</code>çš„<code>HashMap</code>ã€‚å› ä¸ºå®ƒä¹Ÿæ˜¯ä¸€ä¸ª<code>hash</code>è¡¨ï¼Œå› æ­¤å…·å¤‡ä¸<code>HashSet</code>ç±»ä¼¼çš„ç‰¹å¾ï¼š</p> <ul><li>æ— åº</li> <li>å…ƒç´ ä¸å¯é‡å¤</li> <li>æŸ¥æ‰¾å¿«</li> <li>æ”¯æŒäº¤é›†ã€å¹¶é›†ã€å·®é›†ç­‰åŠŸèƒ½</li></ul> <p><strong>Setå¸¸ç”¨å‘½ä»¤</strong></p> <ul><li><p><code>sadd</code>ï¼šå‘setä¸­æ·»åŠ ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´ </p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># ç»™å¼ ä¸‰å’Œæå››æ·»åŠ å¥½å‹</span>
SADD friends:zhangsan lisi wangwu zhaoliu
SADD friends:lisi wangwu mazi ergou
</code></pre></div></li> <li><p><code>srem</code>ï¼šç§»é™¤setä¸­çš„æŒ‡å®šå…ƒç´ </p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># ç§»é™¤å¼ ä¸‰çš„å¥½å‹ç‹äº”</span>
SREM friends:zhangsan wangwu
</code></pre></div></li> <li><p><code>scard</code>ï¼šè¿”å›setä¸­å…ƒç´ çš„ä¸ªæ•°</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># æŸ¥è¯¢å¼ ä¸‰çš„å¥½å‹æ€»æ•°</span>
SCARD friends:zhangsan
</code></pre></div></li> <li><p><code>sismember</code>ï¼šåˆ¤æ–­ä¸€ä¸ªå…ƒç´ æ˜¯å¦å­˜åœ¨äºsetä¸­</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># åˆ¤æ–­æå››æ˜¯å¦å¼ ä¸‰å¥½å‹</span>
SISMEMBER friends:zhangsan lisi
</code></pre></div></li> <li><p><code>smembers</code>ï¼šè·å–setä¸­çš„æ‰€æœ‰å…ƒç´ </p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># æŸ¥è¯¢å¼ ä¸‰çš„æ‰€æœ‰å¥½å‹</span>
SMEMBERS friends:zhangsan
</code></pre></div></li> <li><p><code>sinter</code>ï¼šæ±‚ä¸¤ä¸ªé›†åˆçš„äº¤é›†</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># æŸ¥è¯¢å¼ ä¸‰å’Œæå››çš„å…±åŒå¥½å‹</span>
SINTER friends:zhangsan friends:lisi
</code></pre></div></li> <li><p><code>sdiff</code>ï¼šæ±‚ä¸¤ä¸ªé›†åˆçš„å·®é›†</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># æŸ¥è¯¢æ˜¯å¼ ä¸‰è€Œä¸æ˜¯æå››çš„å¥½å‹</span>
SDIFF friends:zhangsan friends:lisi
</code></pre></div></li> <li><p><code>sunion</code>ï¼šæ±‚ä¸¤ä¸ªé›†åˆçš„å¹¶é›†</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># æŸ¥è¯¢å¼ ä¸‰å’Œæå››çš„æ‰€æœ‰å¥½å‹</span>
SUNION friends:zhangsan friends:lisi
</code></pre></div></li></ul> <h3 id="_2-7-sortedsetç±»å‹"><a href="#_2-7-sortedsetç±»å‹" class="header-anchor">#</a> 2.7 SortedSetç±»å‹</h3> <p><code>Redis</code>çš„<code>SortedSet</code>æ˜¯ä¸€ä¸ªå¯æ’åºçš„<code>set</code>é›†åˆï¼Œä¸<code>Java</code>ä¸­çš„<code>TreeSet</code>æœ‰äº›ç±»ä¼¼ï¼Œä½†åº•å±‚æ•°æ®ç»“æ„å·®åˆ«å¾ˆå¤§ã€‚<code>SortedSet</code>ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ éƒ½å¸¦æœ‰ä¸€ä¸ª<code>score</code>å±æ€§ï¼Œå¯ä»¥åŸºäº<code>score</code>å±æ€§å¯¹å…ƒç´ æ’åºï¼Œåº•å±‚çš„å®ç°æ˜¯ä¸€ä¸ªè·³è¡¨<code>SkipList</code>åŠ <code>hash</code>è¡¨</p> <p><code>SortedSet</code>å…·å¤‡å¦‚ä¸‹ç‰¹æ€§ï¼š</p> <ul><li>å¯æ’åº</li> <li>å…ƒç´ ä¸é‡å¤</li> <li>æŸ¥è¯¢é€Ÿåº¦å¿«</li></ul> <p>å› ä¸º<code>SortedSet</code>çš„å¯æ’åºç‰¹æ€§ï¼Œç»å¸¸è¢«ç”¨æ¥å®ç°æ’è¡Œæ¦œè¿™æ ·çš„åŠŸèƒ½</p> <p><strong>SortedSetå‘½ä»¤</strong></p> <ul><li><p><code>zadd</code>ï¼šæ·»åŠ ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´ åˆ°SortedSetï¼Œå¦‚æœå·²ç»å­˜åœ¨åˆ™æ›´æ–°å…¶scoreå€¼</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># å‘studentä¸­æ·»åŠ å…ƒç´ å¹¶æŒ‡å®šscoreå€¼</span>
ZADD student <span class="token number">85</span> Jack <span class="token number">89</span> Lucy <span class="token number">82</span> Rose <span class="token number">95</span> Tom <span class="token number">78</span> Jerry <span class="token number">92</span> Amy <span class="token number">76</span> Miles
</code></pre></div></li> <li><p><code>zrem</code>ï¼šåˆ é™¤SortedSetä¸­çš„ä¸€ä¸ªæŒ‡å®šå…ƒç´ </p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># åˆ é™¤studentä¸­çš„Tom</span>
ZREM student Tom
</code></pre></div></li> <li><p><code>zscore</code>ï¼šè·å–SortedSetä¸­çš„æŒ‡å®šå…ƒç´ çš„scoreå€¼</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># è·å–Roseçš„scoreå€¼</span>
ZSCORE student Rose
</code></pre></div></li> <li><p><code>zrank</code>ï¼šè·å–SortedSetä¸­çš„æŒ‡å®šå…ƒç´ çš„æ’å</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># è·å–Roseçš„æ’å</span>
 ZRANK student Rose
</code></pre></div></li> <li><p><code>zcard</code>ï¼šè·å–SortedSetä¸­çš„å…ƒç´ ä¸ªæ•°</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># è·å–studentä¸­çš„å…ƒç´ ä¸ªæ•°</span>
ZCARD student
</code></pre></div></li> <li><p><code>zcount</code>ï¼šç»Ÿè®¡scoreå€¼åœ¨ç»™å®šèŒƒå›´å†…çš„æ‰€æœ‰å…ƒç´ çš„ä¸ªæ•°</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># ç»Ÿè®¡studentä¸­scoreåœ¨0~80çš„ä¸ªæ•°</span>
ZCOUNT student <span class="token number">0</span> <span class="token number">80</span>
</code></pre></div></li> <li><p><code>zincrby</code>ï¼šè®©SortedSetzä¸­çš„æŒ‡å®šå…ƒç´ è‡ªå¢ï¼Œæ­¥é•¿ä¸ºæŒ‡å®šçš„incrementå€¼</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># ç»™RoseåŒå­¦çš„socreåŠ 2åˆ†</span>
ZINCRBY student <span class="token number">2</span> Rose
</code></pre></div></li> <li><p><code>zrange</code>ï¼šæŒ‰ç…§scoreæ’åºåï¼Œè·å–æŒ‡å®šæ’åèŒƒå›´å†…çš„å…ƒç´ </p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># æŸ¥æ‰¾å‰ä¸‰å</span>
ZREVRANGE student <span class="token number">0</span> <span class="token number">2</span>
</code></pre></div></li> <li><p><code>zrangebyscore</code>ï¼šæŒ‰ç…§scoreæ’åºåï¼Œè·å–æŒ‡å®šsocreèŒƒå›´å†…çš„å…ƒç´ </p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># æŸ¥è¯¢80åˆ†ä»¥ä¸‹çš„åŒå­¦</span>
ZRANGEBYSCORE student <span class="token number">0</span> <span class="token number">80</span>
</code></pre></div></li> <li><p><code>zdiff</code>ã€<code>zinter</code>ã€<code>zunion</code>ï¼šæ±‚å·®é›†ã€äº¤é›†ã€å¹¶é›†</p></li></ul> <p>ğŸŒŸæ‰€æœ‰çš„æ’åé»˜è®¤éƒ½æ˜¯å‡åºï¼Œå¦‚æœè¦é™åºåˆ™åœ¨å‘½ä»¤çš„<code>Z</code>åé¢æ·»åŠ <code>REV</code>å³å¯</p> <h2 id="_3-javaå®¢æˆ·ç«¯"><a href="#_3-javaå®¢æˆ·ç«¯" class="header-anchor">#</a> 3. Javaå®¢æˆ·ç«¯</h2> <ol><li><code>Jedis</code>ï¼šä»¥Rediså‘½ä»¤ä½œä¸ºæ–¹æ³•åç§°ï¼Œå­¦ä¹ æˆæœ¬ä½ï¼Œç®€å•å®ç”¨ã€‚ä½†æ˜¯Jediså®ä¾‹æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼Œå¤šçº¿ç¨‹ç¯å¢ƒä¸‹éœ€è¦åŸºäºè¿æ¥æ± æ¥ä½¿ç”¨</li> <li><code>Lettuce</code>ï¼šLettuceæ˜¯åŸºäºNettyå®ç°çš„ï¼Œæ”¯æŒåŒæ­¥ã€ä¸€æ­¥å’Œå“åº”å¼ç¼–ç¨‹æ–¹å¼ï¼Œå¹¶ä¸”æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚æ”¯æŒRedisçš„å“¨å…µæ¨¡å¼ã€é›†ç¾¤æ¨¡å¼å’Œç®¡é“æ¨¡å¼</li> <li><code>Redisson</code>ï¼šRedissonæ˜¯ä¸€ä¸ªåŸºäºRediså®ç°çš„åˆ†å¸ƒå¼ã€å¯ä¼¸ç¼©çš„Javaæ•°æ®ç»“æ„é›†åˆã€‚åŒ…å«äº†è¯¸å¦‚Mapã€Queueã€Lockã€Semaphoreã€AtomicLongç­‰å¼ºå¤§åŠŸèƒ½</li></ol> <h3 id="_3-1-jedis"><a href="#_3-1-jedis" class="header-anchor">#</a> 3.1 Jedis</h3> <h4 id="_3-1-1-ç®€å•ä½¿ç”¨"><a href="#_3-1-1-ç®€å•ä½¿ç”¨" class="header-anchor">#</a> 3.1.1 ç®€å•ä½¿ç”¨</h4> <ol><li><p>å¼•å…¥ä¾èµ–</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token comment">&lt;!-- jedis--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>redis.clients<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jedis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.7.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!--å•å…ƒæµ‹è¯•--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.junit.jupiter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>junit-jupiter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>5.8.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li> <li><p>ç®€å•ä½¿ç”¨</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JedisTest</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">Jedis</span> jedis<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@BeforeEach</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">before</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1. å»ºç«‹è¿æ¥</span>
        jedis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Jedis</span><span class="token punctuation">(</span><span class="token string">&quot;192.168.3.157&quot;</span><span class="token punctuation">,</span> <span class="token number">6379</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 2. è®¾ç½®å¯†ç </span>
        jedis<span class="token punctuation">.</span><span class="token function">auth</span><span class="token punctuation">(</span><span class="token string">&quot;123456&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3. é€‰æ‹©åº“</span>
        jedis<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@AfterEach</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">after</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å…³é—­è¿æ¥</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>jedis <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            jedis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        jedis<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;å¼ ä¸‰&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>jedis<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        jedis<span class="token punctuation">.</span><span class="token function">hset</span><span class="token punctuation">(</span><span class="token string">&quot;user:1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Jack&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> name <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">hget</span><span class="token punctuation">(</span><span class="token string">&quot;user:1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ol> <h4 id="_3-1-2-jedisè¿æ¥æ± "><a href="#_3-1-2-jedisè¿æ¥æ± " class="header-anchor">#</a> 3.1.2 Jedisè¿æ¥æ± </h4> <p><code>Jedis</code>æœ¬èº«æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼Œå¹¶ä¸”é¢‘ç¹çš„åˆ›å»ºå’Œé”€æ¯è¿æ¥ä¼šæœ‰æ€§èƒ½æŸè€—ï¼Œå› æ­¤ä¸€èˆ¬ä½¿ç”¨<code>Jedis</code>è¿æ¥æ± æ¥ä»£æ›¿<code>Jedis</code>çš„ç›´è¿æ–¹å¼</p> <ol><li><p>åˆ›å»ºè¿æ¥æ± å·¥å…·ç±»</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JedisConnectionFactory</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">JedisPool</span> JEDIS_POOL<span class="token punctuation">;</span>

    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        <span class="token class-name">JedisPoolConfig</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JedisPoolConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// æœ€å¤§è¿æ¥</span>
        config<span class="token punctuation">.</span><span class="token function">setMaxTotal</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// æœ€å¤§ç©ºé—²è¿æ¥</span>
        config<span class="token punctuation">.</span><span class="token function">setMaxIdle</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// æœ€å°ç©ºé—²è¿æ¥</span>
        config<span class="token punctuation">.</span><span class="token function">setMinIdle</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è®¾ç½®æœ€é•¿çš„ç­‰å¾…æ—¶é—´ ms</span>
        config<span class="token punctuation">.</span><span class="token function">setMaxWaitMillis</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        JEDIS_POOL <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JedisPool</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> <span class="token string">&quot;192.168.3.157&quot;</span><span class="token punctuation">,</span> <span class="token number">6379</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token string">&quot;123456&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Jedis</span> <span class="token function">getJedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> JEDIS_POOL<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>ä½¿ç”¨</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JedisTest</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">Jedis</span> jedis<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@BeforeEach</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">before</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1. å»ºç«‹è¿æ¥</span>
        jedis <span class="token operator">=</span> <span class="token class-name">JedisConnectionFactory</span><span class="token punctuation">.</span><span class="token function">getJedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 2. é€‰æ‹©åº“</span>
        jedis<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@AfterEach</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">after</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å…³é—­è¿æ¥</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>jedis <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            jedis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        jedis<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;å¼ ä¸‰&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>jedis<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre></div></li></ol> <h3 id="_3-2-springdataredis"><a href="#_3-2-springdataredis" class="header-anchor">#</a> 3.2 SpringDataRedis</h3> <h4 id="_3-2-1-ä»‹ç»"><a href="#_3-2-1-ä»‹ç»" class="header-anchor">#</a> 3.2.1 ä»‹ç»</h4> <p><code>SpringData</code>æ˜¯<code>Spring</code>ä¸­æ•°æ®æ“ä½œçš„æ¨¡å—ï¼ŒåŒ…å«å¯¹å„ç§æ•°æ®åº“çš„é›†æˆï¼Œå…¶ä¸­å¯¹<code>Redis</code>çš„é›†æˆæ¨¡å—å°±å«åš<code>SpringDataRedis</code></p> <ul><li>æä¾›äº†å¯¹ä¸åŒ<code>Redis</code>å®¢æˆ·ç«¯çš„æ•´åˆ(<code>Lettuce</code>å’Œ<code>Jedis</code>)</li> <li>æä¾›äº†æ›´<code>RedisTemplate</code>ç»Ÿä¸€<code>API</code>æ¥æ“ä½œ<code>Redis</code></li> <li>æ”¯æŒ<code>Redis</code>çš„å‘å¸ƒè®¢é˜…æ¨¡å‹</li> <li>æ”¯æŒ<code>Redis</code>å“¨å…µå’Œ<code>Redis</code>é›†ç¾¤</li> <li>æ”¯æŒåŸºäº<code>Lettuce</code>çš„å“åº”å¼ç¼–ç¨‹</li> <li>æ”¯æŒåŸºäº<code>JDK</code>ã€<code>JSON</code>ã€å­—ç¬¦ä¸²ã€<code>Spring</code>å¯¹è±¡çš„æ•°æ®åºåˆ—åŒ–åŠååºåˆ—åŒ–</li> <li>æ”¯æŒåŸºäº<code>Redis</code>çš„<code>JDKCollection</code>çš„å®ç°</li></ul> <p><code>SpringDataRedis</code>ä¸­æä¾›äº†<code>RedisTemplate</code>å·¥å…·ç±»ï¼Œå…¶ä¸­å°è£…äº†å„ç§å¯¹<code>Redis</code>çš„æ“ä½œã€‚å¹¶ä¸”å°†ä¸åŒæ•°æ®ç±»å‹çš„æ“ä½œ<code>API</code>å°è£…åˆ°äº†ä¸åŒçš„ç±»å‹ä¸­ï¼š</p> <table><thead><tr><th>API</th> <th>è¿”å›å€¼ç±»å‹</th> <th>è¯´æ˜</th></tr></thead> <tbody><tr><td>redisTemplate.opsForValue()</td> <td>ValueOperations</td> <td>æ“ä½œStringç±»å‹æ•°æ®</td></tr> <tr><td>redisTemplate.opsForHash()</td> <td>HashOperations</td> <td>æ“ä½œHashç±»å‹æ•°æ®</td></tr> <tr><td>redisTemplate.opsForList()</td> <td>ListOperations</td> <td>æ“ä½œListç±»å‹æ•°æ®</td></tr> <tr><td>redisTemplate.opsForSet()</td> <td>SetOperations</td> <td>æ“ä½œSetç±»å‹æ•°æ®</td></tr> <tr><td>redisTemplate.opsForZset()</td> <td>ZsetOperations</td> <td>æ“ä½œSortedSetç±»å‹æ•°æ®</td></tr> <tr><td>redisTemplate</td> <td></td> <td>é€šç”¨çš„å‘½ä»¤</td></tr></tbody></table> <h4 id="_3-2-2-å¿«é€Ÿå…¥é—¨"><a href="#_3-2-2-å¿«é€Ÿå…¥é—¨" class="header-anchor">#</a> 3.2.2 å¿«é€Ÿå…¥é—¨</h4> <ol><li><p>æ–°å»ºSpringBooté¡¹ç›®</p></li> <li><p>å¼•å…¥ä¾èµ–</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token comment">&lt;!--Redisä¾èµ–--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!--è¿æ¥æ± --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.commons<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>commons-pool2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!--jacksonä¾èµ–ä¸€èˆ¬ä¸éœ€è¦å¼•å…¥--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.fasterxml.jackson.core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jackson-databind<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li> <li><p>ä¿®æ”¹é…ç½®æ–‡ä»¶</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">redis</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> 192.168.3.158
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">6379</span>
    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token number">123456</span>
    <span class="token key atrule">lettuce</span><span class="token punctuation">:</span>
      <span class="token key atrule">pool</span><span class="token punctuation">:</span>
        <span class="token key atrule">max-active</span><span class="token punctuation">:</span> <span class="token number">8</span> <span class="token comment"># æœ€å¤§è¿æ¥</span>
        <span class="token key atrule">max-idle</span><span class="token punctuation">:</span> <span class="token number">8</span>   <span class="token comment"># æœ€å¤§ç©ºé—²è¿æ¥</span>
        <span class="token key atrule">min-idle</span><span class="token punctuation">:</span> <span class="token number">0</span>   <span class="token comment"># æœ€å°ç©ºé—²è¿æ¥</span>
        <span class="token key atrule">max-wait</span><span class="token punctuation">:</span> <span class="token number">100</span> <span class="token comment"># è¿æ¥ç­‰å¾…æ—¶é—´</span>
</code></pre></div></li> <li><p>æµ‹è¯•ä½¿ç”¨</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">class</span> <span class="token class-name">RedisTest</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> redisTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;redisTemplate&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;SpringData&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Object</span> value <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;redisTemplate&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ol> <h4 id="_3-2-3-åºåˆ—åŒ–"><a href="#_3-2-3-åºåˆ—åŒ–" class="header-anchor">#</a> 3.2.3 åºåˆ—åŒ–</h4> <p><code>RedisTemplate</code>å¯ä»¥æ¥æ”¶ä»»æ„<code>Object</code>ä½œä¸ºå€¼å†™å…¥<code>Redis</code>ï¼Œåªä¸è¿‡å†™å…¥å‰ä¼šæŠŠ<code>Object</code>åºåˆ—åŒ–ä¸ºå­—èŠ‚å½¢å¼ï¼Œé»˜è®¤æ˜¯<code>JDK</code>çš„åºåˆ—åŒ–æ–¹å¼ï¼Œä»¥ä¸Šè¿°ä¸ºä¾‹<code>redis</code>ä¸­å­˜å‚¨çš„ç»“æœä¸º</p> <div class="language- extra-class"><pre class="language-text"><code># key
\xac\xed\x00\x05t\x00\x0dredisTemplate

# value
\xac\xed\x00\x05t\x00\x0aSpringData
</code></pre></div><p>é…ç½®<code>RedisTemplate</code>çš„åºåˆ—åŒ–æ–¹å¼ï¼š<code>key</code>é‡‡ç”¨<code>String</code>ï¼Œå€¼åºåˆ—åŒ–ä¸º<code>String</code>æˆ–è€…<code>JSON</code></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisConfig</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">redisTemplate</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span> connectionFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// åˆ›å»ºRedisTemplate</span>
        <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> redisTemplate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è®¾ç½®è¿æ¥å·¥å‚</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">setConnectionFactory</span><span class="token punctuation">(</span>connectionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// è®¾ç½®åºåˆ—åŒ–å·¥å…·</span>
        <span class="token class-name">GenericJackson2JsonRedisSerializer</span> serializer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GenericJackson2JsonRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// keyå’ŒhashKeyé‡‡ç”¨Stringåºåˆ—åŒ–</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">setKeySerializer</span><span class="token punctuation">(</span><span class="token class-name">RedisSerializer</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">setHashKeySerializer</span><span class="token punctuation">(</span><span class="token class-name">RedisSerializer</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// valueå’ŒhashValueé‡‡ç”¨JSONåºåˆ—åŒ–</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">setValueSerializer</span><span class="token punctuation">(</span>serializer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">setHashValueSerializer</span><span class="token punctuation">(</span>serializer<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> redisTemplate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æµ‹è¯•</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">class</span> <span class="token class-name">RedisTest</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> redisTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">&quot;äºŒç‹—&quot;</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;user:100&quot;</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">User</span> o <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">)</span>redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;user:100&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> age<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ä¸ºäº†åœ¨ååºåˆ—åŒ–æ—¶çŸ¥é“å¯¹è±¡çš„ç±»å‹ï¼Œ<code>JSON</code>åºåˆ—åŒ–å™¨ä¼šå°†ç±»çš„å…¨ç±»åå†™å…¥<code>json</code>ç»“æœå¹¶å­˜å…¥<code>Redis</code>ä¸­ï¼Œä¼šå¸¦æ¥é¢å¤–çš„å†…å­˜å¼€é”€</p> <div class="language-json extra-class"><pre class="language-json"><code># key
user<span class="token operator">:</span><span class="token number">100</span>

# value
<span class="token punctuation">{</span>
    <span class="token property">&quot;@class&quot;</span><span class="token operator">:</span> <span class="token string">&quot;com.meinil.redis.User&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;äºŒç‹—&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;age&quot;</span><span class="token operator">:</span> <span class="token number">30</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ä¸ºäº†èŠ‚çœå†…å­˜ç©ºé—´ï¼Œæˆ‘ä»¬å¹¶ä¸ä¼šä½¿ç”¨<code>JSON</code>åºåˆ—åŒ–å™¨æ¥å¤„ç†<code>value</code>ï¼Œè€Œæ˜¯ç»Ÿä¸€ä½¿ç”¨<code>String</code>åºåˆ—åŒ–å™¨ï¼Œè¦æ±‚åªèƒ½å­˜å‚¨<code>String</code>ç±»å‹çš„<code>key</code>å’Œ<code>value</code>ã€‚å½“éœ€è¦å­˜å‚¨<code>Java</code>å¯¹è±¡æ—¶ï¼Œæ‰‹åŠ¨å®Œæˆå¯¹è±¡çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–</p> <p><code>Spring</code>é»˜è®¤æä¾›äº†ä¸€ä¸ª<code>StringRedisTemplate</code>ç±»ï¼Œå®ƒçš„<code>key</code>å’Œ<code>value</code>çš„åºåˆ—åŒ–æ–¹å¼é»˜è®¤å°±æ˜¯<code>String</code>æ–¹å¼ã€‚</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">class</span> <span class="token class-name">RedisTest</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testStringRedisTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">JsonProcessingException</span> <span class="token punctuation">{</span>
        <span class="token class-name">ObjectMapper</span> mapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">&quot;äºŒç‹—&quot;</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// å°†å¯¹è±¡åºåˆ—åŒ–ä¸ºJSONå­—ç¬¦ä¸²åå­˜å…¥</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;user:200&quot;</span><span class="token punctuation">,</span> mapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> value <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;user:200&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// ååºåˆ—åŒ–</span>
        <span class="token class-name">User</span> user1 <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">readValue</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>user1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> age<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_4-é¡¹ç›®å®æˆ˜"><a href="#_4-é¡¹ç›®å®æˆ˜" class="header-anchor">#</a> 4. é¡¹ç›®å®æˆ˜</h2> <h3 id="_4-1-åŸºäºsessionçš„çŸ­ä¿¡ç™»å½•"><a href="#_4-1-åŸºäºsessionçš„çŸ­ä¿¡ç™»å½•" class="header-anchor">#</a> 4.1 åŸºäºSessionçš„çŸ­ä¿¡ç™»å½•</h3> <h4 id="_4-1-1-ç™»å½•æµç¨‹"><a href="#_4-1-1-ç™»å½•æµç¨‹" class="header-anchor">#</a> 4.1.1 ç™»å½•æµç¨‹</h4> <ol><li><p>å‘é€çŸ­ä¿¡éªŒè¯ç </p> <div class="language-flow extra-class"><pre class="language-flow"><code>st<span class="token operator">=&gt;</span>start<span class="token operator">:</span> å¼€å§‹
submitPhone<span class="token operator">=&gt;</span>operation<span class="token operator">:</span> æäº¤æ‰‹æœºå·ç 
checkPhone<span class="token operator">=&gt;</span>condition<span class="token operator">:</span> æ ¡éªŒæ‰‹æœºå·
generateCode<span class="token operator">=&gt;</span>operation<span class="token operator">:</span> ç”ŸæˆéªŒè¯ç 
saveCode<span class="token operator">=&gt;</span>operation<span class="token operator">:</span> ä¿å­˜éªŒè¯ç åˆ°session
sendCode<span class="token operator">=&gt;</span>operation<span class="token operator">:</span> å‘é€éªŒè¯ç 
e<span class="token operator">=&gt;</span>end<span class="token operator">:</span> ç»“æŸæ¡†
st<span class="token operator">-</span><span class="token operator">&gt;</span>submitPhone<span class="token operator">-</span><span class="token operator">&gt;</span>checkPhone
<span class="token function">checkPhone</span><span class="token punctuation">(</span>yes<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>generateCode<span class="token operator">-</span><span class="token operator">&gt;</span>saveCode<span class="token operator">-</span><span class="token operator">&gt;</span>sendCode<span class="token operator">-</span><span class="token operator">&gt;</span>e
<span class="token function">checkPhone</span><span class="token punctuation">(</span>no<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>submitPhone
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendCode</span><span class="token punctuation">(</span><span class="token class-name">String</span> phone<span class="token punctuation">,</span> <span class="token class-name">HttpSession</span> session<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. æ ¡éªŒæ‰‹æœºå·</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">RegexUtils</span><span class="token punctuation">.</span><span class="token function">isPhoneInvalid</span><span class="token punctuation">(</span>phone<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 2. å¦‚æœä¸ç¬¦åˆ,è¿”å›é”™è¯¯ä¿¡æ¯</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;æ‰‹æœºå·ä¸åˆæ³•&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 3. ç”ŸæˆéªŒè¯ç </span>
    <span class="token class-name">String</span> code <span class="token operator">=</span> <span class="token class-name">RandomUtil</span><span class="token punctuation">.</span><span class="token function">randomNumbers</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 4. ä¿å­˜åˆ°session</span>
    session<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 5. å‘é€éªŒè¯ç </span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;å‘é€éªŒè¯ç æˆåŠŸ: {}&quot;</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>çŸ­ä¿¡éªŒè¯ç ç™»å½•ã€æ³¨å†Œ</p> <div class="language-flow extra-class"><pre class="language-flow"><code>st<span class="token operator">=&gt;</span>start<span class="token operator">:</span> å¼€å§‹
submitPhone<span class="token operator">=&gt;</span>operation<span class="token operator">:</span> æäº¤æ‰‹æœºå·å’ŒéªŒè¯ç 
checkCode<span class="token operator">=&gt;</span>condition<span class="token operator">:</span> æ ¡éªŒéªŒè¯ç 
queryUser<span class="token operator">=&gt;</span>operation<span class="token operator">:</span> æ ¹æ®æ‰‹æœºå·æŸ¥è¯¢ç”¨æˆ·
checkUser<span class="token operator">=&gt;</span>condition<span class="token operator">:</span> ç”¨æˆ·æ˜¯å¦å­˜åœ¨
saveUserToSession<span class="token operator">=&gt;</span>operation<span class="token operator">:</span> ä¿å­˜ç”¨æˆ·åˆ°session
createUser<span class="token operator">=&gt;</span>operation<span class="token operator">:</span> åˆ›å»ºæ–°ç”¨æˆ·
saveUserToData<span class="token operator">=&gt;</span>operation<span class="token operator">:</span> ä¿å­˜æ–°ç”¨æˆ·åˆ°æ•°æ®åº“
sendCode<span class="token operator">=&gt;</span>operation<span class="token operator">:</span> å‘é€éªŒè¯ç 
e<span class="token operator">=&gt;</span>end<span class="token operator">:</span> ç»“æŸæ¡†
st<span class="token operator">-</span><span class="token operator">&gt;</span>submitPhone<span class="token operator">-</span><span class="token operator">&gt;</span>checkCode
<span class="token function">checkCode</span><span class="token punctuation">(</span>yes<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>queryUser<span class="token operator">-</span><span class="token operator">&gt;</span>checkUser
<span class="token function">checkCode</span><span class="token punctuation">(</span>no<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>submitPhone
<span class="token function">checkUser</span><span class="token punctuation">(</span>yes<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>saveUserToSession<span class="token operator">-</span><span class="token operator">&gt;</span>e
<span class="token function">checkUser</span><span class="token punctuation">(</span>no<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>createUser<span class="token operator">-</span><span class="token operator">&gt;</span>saveUserToData<span class="token operator">-</span><span class="token operator">&gt;</span>saveUserToSession
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token class-name">LoginFormDTO</span> loginForm<span class="token punctuation">,</span> <span class="token class-name">HttpSession</span> session<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. æ ¡éªŒæ‰‹æœºå·</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">RegexUtils</span><span class="token punctuation">.</span><span class="token function">isPhoneInvalid</span><span class="token punctuation">(</span>loginForm<span class="token punctuation">.</span><span class="token function">getPhone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;æ‰‹æœºå·ä¸åˆæ³•&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 2. æ ¡éªŒéªŒè¯ç </span>
    <span class="token class-name">String</span> code <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span>session<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>loginForm<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>code<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>loginForm<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;éªŒè¯ç ä¸æ­£ç¡®&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 3. æ ¹æ®æ‰‹æœºå·æŸ¥è¯¢ç”¨æˆ·</span>
    <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token function">lambdaQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token operator">::</span><span class="token function">getPhone</span><span class="token punctuation">,</span> loginForm<span class="token punctuation">.</span><span class="token function">getPhone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment">// 4. ç”¨æˆ·ä¸å­˜åœ¨åˆ›å»ºæ–°ç”¨æˆ·</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        user<span class="token punctuation">.</span><span class="token function">setPhone</span><span class="token punctuation">(</span>loginForm<span class="token punctuation">.</span><span class="token function">getPhone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        user<span class="token punctuation">.</span><span class="token function">setNickName</span><span class="token punctuation">(</span><span class="token class-name">RandomUtil</span><span class="token punctuation">.</span><span class="token function">randomString</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        baseMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 5. å°†ç”¨æˆ·ä¿¡æ¯å­˜å…¥session</span>
    session<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token class-name">UserDTO</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>æ ¡éªŒç™»å½•çŠ¶æ€</p> <div class="language-flow extra-class"><pre class="language-flow"><code>st<span class="token operator">=&gt;</span>start<span class="token operator">:</span> å¼€å§‹
request<span class="token operator">=&gt;</span>operation<span class="token operator">:</span> è¯·æ±‚å¹¶æºå¸¦cookie
checkUser<span class="token operator">=&gt;</span>condition<span class="token operator">:</span> åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨
intercept<span class="token operator">=&gt;</span>operation<span class="token operator">:</span> æ‹¦æˆª
getUserBySession<span class="token operator">=&gt;</span>operation<span class="token operator">:</span> ä»sessionè·å–ç”¨æˆ·
saveUser<span class="token operator">=&gt;</span>operation<span class="token operator">:</span> ä¿å­˜ç”¨æˆ·åˆ°ThreadLocal
pass<span class="token operator">=&gt;</span>operation<span class="token operator">:</span> æ”¾è¡Œ
e<span class="token operator">=&gt;</span>end<span class="token operator">:</span> ç»“æŸæ¡†
st<span class="token operator">-</span><span class="token operator">&gt;</span>request<span class="token operator">-</span><span class="token operator">&gt;</span>checkUser
<span class="token function">checkUser</span><span class="token punctuation">(</span>yes<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>getUserBySession<span class="token operator">-</span><span class="token operator">&gt;</span>saveUser<span class="token operator">-</span><span class="token operator">&gt;</span>e
<span class="token function">checkUser</span><span class="token punctuation">(</span>no<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>intercept<span class="token operator">-</span><span class="token operator">&gt;</span>e
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerInterceptor</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1. è·å–session</span>
        <span class="token class-name">HttpSession</span> session <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 2. è·å–user</span>
        <span class="token class-name">Object</span> user <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// ä¸å­˜åœ¨æ‹¦æˆª</span>
            response<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 4. å°†ç”¨æˆ·å­˜å…¥ThreadLocal</span>
        <span class="token class-name">UserDTO</span> userDTO <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserDTO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> userDTO<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">saveUser</span><span class="token punctuation">(</span>userDTO<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 5. æ”¾è¡Œ</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterCompletion</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">,</span> <span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// ç§»é™¤ç”¨æˆ·</span>
        <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">removeUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebConfig</span> <span class="token keyword">implements</span> <span class="token class-name">WebMvcConfigurer</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addInterceptors</span><span class="token punctuation">(</span><span class="token class-name">InterceptorRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        registry<span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LoginInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">excludePathPatterns</span><span class="token punctuation">(</span>
                        <span class="token string">&quot;/user/code&quot;</span><span class="token punctuation">,</span>
                        <span class="token string">&quot;/user/login&quot;</span><span class="token punctuation">,</span>
                        <span class="token string">&quot;/blog/hot&quot;</span><span class="token punctuation">,</span>
                        <span class="token string">&quot;/shop/**&quot;</span><span class="token punctuation">,</span>
                        <span class="token string">&quot;/shop-type/**&quot;</span><span class="token punctuation">,</span>
                        <span class="token string">&quot;/voucher/**&quot;</span>
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ol> <h4 id="_4-1-2-é›†ç¾¤sessionå…±äº«é—®é¢˜"><a href="#_4-1-2-é›†ç¾¤sessionå…±äº«é—®é¢˜" class="header-anchor">#</a> 4.1.2 é›†ç¾¤Sessionå…±äº«é—®é¢˜</h4> <p>å¤šå°<code>Timcat</code>ä¸èƒ½å¤Ÿå…±äº«<code>session</code>çš„å­˜å‚¨ç©ºé—´ï¼Œå½“è¯·æ±‚åˆ‡æ¢åˆ°ä¸åŒ<code>tomcat</code>æœåŠ¡æ—¶ä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±</p> <div class="spinner" style="background:rgb(66, 185, 131);" data-v-1bbcb91a></div><h4 id="_4-1-3-åŸºäºredisçš„sessionå…±äº«"><a href="#_4-1-3-åŸºäºredisçš„sessionå…±äº«" class="header-anchor">#</a> 4.1.3 åŸºäºRedisçš„Sessionå…±äº«</h4> <ol><li><p>å‘é€çŸ­ä¿¡éªŒè¯ç </p> <div class="language-flow extra-class"><pre class="language-flow"><code>st<span class="token operator">=&gt;</span>start<span class="token operator">:</span> å¼€å§‹
submitPhone<span class="token operator">=&gt;</span>operation<span class="token operator">:</span> æäº¤æ‰‹æœºå·ç 
checkPhone<span class="token operator">=&gt;</span>condition<span class="token operator">:</span> æ ¡éªŒæ‰‹æœºå·
generateCode<span class="token operator">=&gt;</span>operation<span class="token operator">:</span> ç”ŸæˆéªŒè¯ç 
saveCode<span class="token operator">=&gt;</span>operation<span class="token operator">:</span> ä¿å­˜éªŒè¯ç åˆ°Redis
sendCode<span class="token operator">=&gt;</span>operation<span class="token operator">:</span> å‘é€éªŒè¯ç 
e<span class="token operator">=&gt;</span>end<span class="token operator">:</span> ç»“æŸæ¡†
st<span class="token operator">-</span><span class="token operator">&gt;</span>submitPhone<span class="token operator">-</span><span class="token operator">&gt;</span>checkPhone
<span class="token function">checkPhone</span><span class="token punctuation">(</span>yes<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>generateCode<span class="token operator">-</span><span class="token operator">&gt;</span>saveCode<span class="token operator">-</span><span class="token operator">&gt;</span>sendCode<span class="token operator">-</span><span class="token operator">&gt;</span>e
<span class="token function">checkPhone</span><span class="token punctuation">(</span>no<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>submitPhone
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendCode</span><span class="token punctuation">(</span><span class="token class-name">String</span> phone<span class="token punctuation">,</span> <span class="token class-name">HttpSession</span> session<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. æ ¡éªŒæ‰‹æœºå·</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">RegexUtils</span><span class="token punctuation">.</span><span class="token function">isPhoneInvalid</span><span class="token punctuation">(</span>phone<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 2. å¦‚æœä¸ç¬¦åˆ,è¿”å›é”™è¯¯ä¿¡æ¯</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;æ‰‹æœºå·ä¸åˆæ³•&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 3. ç”ŸæˆéªŒè¯ç </span>
    <span class="token class-name">String</span> code <span class="token operator">=</span> <span class="token class-name">RandomUtil</span><span class="token punctuation">.</span><span class="token function">randomNumbers</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 4. ä¿å­˜åˆ°redis</span>
    redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>
        <span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>LOGIN_CODE_KEY <span class="token operator">+</span> phone<span class="token punctuation">,</span>
        code<span class="token punctuation">,</span>
        <span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>LOGIN_CODE_TTL<span class="token punctuation">,</span>
        <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MINUTES
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 5. å‘é€éªŒè¯ç </span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;å‘é€éªŒè¯ç æˆåŠŸ: {}&quot;</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>â€‹</p></li> <li><p>çŸ­ä¿¡éªŒè¯ç ç™»å½•æ³¨å†Œ</p> <div class="language-flow extra-class"><pre class="language-flow"><code>st<span class="token operator">=&gt;</span>start<span class="token operator">:</span> å¼€å§‹
submitPhone<span class="token operator">=&gt;</span>operation<span class="token operator">:</span> æäº¤æ‰‹æœºå·å’ŒéªŒè¯ç 
checkCode<span class="token operator">=&gt;</span>condition<span class="token operator">:</span> æ ¡éªŒéªŒè¯ç 
queryUser<span class="token operator">=&gt;</span>operation<span class="token operator">:</span> æ ¹æ®æ‰‹æœºå·æŸ¥è¯¢ç”¨æˆ·
checkUser<span class="token operator">=&gt;</span>condition<span class="token operator">:</span> ç”¨æˆ·æ˜¯å¦å­˜åœ¨
saveUserToSession<span class="token operator">=&gt;</span>operation<span class="token operator">:</span> ä¿å­˜ç”¨æˆ·åˆ°redis
sendToken<span class="token operator">=&gt;</span>operation<span class="token operator">:</span> è¿”å›tokenç»™å®¢æˆ·ç«¯
createUser<span class="token operator">=&gt;</span>operation<span class="token operator">:</span> åˆ›å»ºæ–°ç”¨æˆ·
saveUserToData<span class="token operator">=&gt;</span>operation<span class="token operator">:</span> ä¿å­˜æ–°ç”¨æˆ·åˆ°æ•°æ®åº“
sendCode<span class="token operator">=&gt;</span>operation<span class="token operator">:</span> å‘é€éªŒè¯ç 
e<span class="token operator">=&gt;</span>end<span class="token operator">:</span> ç»“æŸæ¡†
st<span class="token operator">-</span><span class="token operator">&gt;</span>submitPhone<span class="token operator">-</span><span class="token operator">&gt;</span>checkCode
<span class="token function">checkCode</span><span class="token punctuation">(</span>yes<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>queryUser<span class="token operator">-</span><span class="token operator">&gt;</span>checkUser
<span class="token function">checkCode</span><span class="token punctuation">(</span>no<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>submitPhone
<span class="token function">checkUser</span><span class="token punctuation">(</span>yes<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>saveUserToSession<span class="token operator">-</span><span class="token operator">&gt;</span>sendToken<span class="token operator">-</span><span class="token operator">&gt;</span>e
<span class="token function">checkUser</span><span class="token punctuation">(</span>no<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>createUser<span class="token operator">-</span><span class="token operator">&gt;</span>saveUserToData<span class="token operator">-</span><span class="token operator">&gt;</span>saveUserToSession
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token class-name">LoginFormDTO</span> loginForm<span class="token punctuation">,</span> <span class="token class-name">HttpSession</span> session<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// 1. æ ¡éªŒæ‰‹æœºå·</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">RegexUtils</span><span class="token punctuation">.</span><span class="token function">isPhoneInvalid</span><span class="token punctuation">(</span>loginForm<span class="token punctuation">.</span><span class="token function">getPhone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;æ‰‹æœºå·ä¸åˆæ³•&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>

 <span class="token comment">// 2. æ ¡éªŒéªŒè¯ç </span>
 <span class="token class-name">String</span> code <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>LOGIN_CODE_KEY <span class="token operator">+</span> loginForm<span class="token punctuation">.</span><span class="token function">getPhone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>loginForm<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>code<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>loginForm<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;éªŒè¯ç ä¸æ­£ç¡®æˆ–å·²è¿‡æœŸ&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>

 <span class="token comment">// 3. æ ¹æ®æ‰‹æœºå·æŸ¥è¯¢ç”¨æˆ·</span>
 <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token function">lambdaQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
     <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token operator">::</span><span class="token function">getPhone</span><span class="token punctuation">,</span> loginForm<span class="token punctuation">.</span><span class="token function">getPhone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">.</span><span class="token function">one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


 <span class="token comment">// 4. ç”¨æˆ·ä¸å­˜åœ¨åˆ›å»ºæ–°ç”¨æˆ·</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     user<span class="token punctuation">.</span><span class="token function">setPhone</span><span class="token punctuation">(</span>loginForm<span class="token punctuation">.</span><span class="token function">getPhone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     user<span class="token punctuation">.</span><span class="token function">setNickName</span><span class="token punctuation">(</span><span class="token class-name">RandomUtil</span><span class="token punctuation">.</span><span class="token function">randomString</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     baseMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>

 <span class="token comment">// 5. å°†ç”¨æˆ·ä¿¡æ¯å­˜å…¥redis</span>
 <span class="token class-name">UserDTO</span> userDTO <span class="token operator">=</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token class-name">UserDTO</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token class-name">String</span> token <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>
     <span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>LOGIN_USER_KEY <span class="token operator">+</span> token<span class="token punctuation">,</span>
     <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">beanToMap</span><span class="token punctuation">(</span>
         userDTO<span class="token punctuation">,</span>
         <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
         <span class="token class-name">CopyOptions</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
         <span class="token punctuation">.</span><span class="token function">setIgnoreNullValue</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
         <span class="token punctuation">.</span><span class="token function">setFieldValueEditor</span><span class="token punctuation">(</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> value<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">)</span>
 <span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// è®¾ç½®è¿‡æœŸæ—¶é—´</span>
 redisTemplate<span class="token punctuation">.</span><span class="token function">expire</span><span class="token punctuation">(</span>
     <span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>LOGIN_USER_KEY <span class="token operator">+</span> token<span class="token punctuation">,</span>
     <span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>LOGIN_USER_TTL<span class="token punctuation">,</span>
     <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MINUTES
 <span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token keyword">return</span> token<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>æ ¡éªŒç™»å½•çŠ¶æ€</p> <div class="language-flow extra-class"><pre class="language-flow"><code>st<span class="token operator">=&gt;</span>start<span class="token operator">:</span> å¼€å§‹
request<span class="token operator">=&gt;</span>operation<span class="token operator">:</span> è¯·æ±‚å¹¶æºå¸¦cookie
checkUser<span class="token operator">=&gt;</span>condition<span class="token operator">:</span> åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨
intercept<span class="token operator">=&gt;</span>operation<span class="token operator">:</span> æ‹¦æˆª
getUserBySession<span class="token operator">=&gt;</span>operation<span class="token operator">:</span> ä»Redisä¸­è·å–ç”¨æˆ·
saveUser<span class="token operator">=&gt;</span>operation<span class="token operator">:</span> ä¿å­˜ç”¨æˆ·åˆ°ThreadLocal
pass<span class="token operator">=&gt;</span>operation<span class="token operator">:</span> æ”¾è¡Œ
e<span class="token operator">=&gt;</span>end<span class="token operator">:</span> ç»“æŸæ¡†
st<span class="token operator">-</span><span class="token operator">&gt;</span>request<span class="token operator">-</span><span class="token operator">&gt;</span>checkUser
<span class="token function">checkUser</span><span class="token punctuation">(</span>yes<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>getUserBySession<span class="token operator">-</span><span class="token operator">&gt;</span>saveUser<span class="token operator">-</span><span class="token operator">&gt;</span>e
<span class="token function">checkUser</span><span class="token punctuation">(</span>no<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>intercept<span class="token operator">-</span><span class="token operator">&gt;</span>e
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerInterceptor</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1. è·å–è¯·æ±‚å¤´ä¸­çš„token</span>
        <span class="token class-name">String</span> token <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">&quot;authorization&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            response<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 2. ä»redisä¸­è·å–ç”¨æˆ·</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> entries <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span><span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>LOGIN_USER_KEY <span class="token operator">+</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>entries<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            response<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">UserDTO</span> user <span class="token operator">=</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">fillBeanWithMap</span><span class="token punctuation">(</span>entries<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">UserDTO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 4. å°†ç”¨æˆ·å­˜å…¥ThreadLocal</span>
        <span class="token class-name">UserDTO</span> userDTO <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserDTO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> userDTO<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">saveUser</span><span class="token punctuation">(</span>userDTO<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 5. tokenç»­æœŸ</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">expire</span><span class="token punctuation">(</span><span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>LOGIN_USER_KEY <span class="token operator">+</span> token<span class="token punctuation">,</span> <span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>LOGIN_USER_TTL<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MINUTES<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 6. æ”¾è¡Œ</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterCompletion</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">,</span> <span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// ç§»é™¤ç”¨æˆ·</span>
        <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">removeUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ol> <h4 id="_4-1-4-æ‹¦æˆªå™¨ä¼˜åŒ–"><a href="#_4-1-4-æ‹¦æˆªå™¨ä¼˜åŒ–" class="header-anchor">#</a> 4.1.4 æ‹¦æˆªå™¨ä¼˜åŒ–</h4> <p>ä¸Šè¿°ä¾‹å­ä¸­ï¼Œåˆ·æ–°tokenæœ‰æ•ˆæœŸè¿™ä¸€æ“ä½œåªä¼šåœ¨ç”¨æˆ·è®¿é—®è¢«æ‹¦æˆªå™¨æ‹¦æˆªçš„æ¥å£æ—¶æ‰ä¼šåˆ·æ–°ï¼Œå¯¹äºæ²¡æœ‰è¢«æ‹¦æˆªçš„æ¥å£åˆ™ä¸ä¼šåˆ·çº¿tokenæœ‰æ•ˆæœŸ</p> <ol><li><p>æ–°å»º<code>RefreshTokenInterceptor</code>ï¼Œä¸»è¦è´Ÿè´£åˆ·æ–°tokenæœ‰æ•ˆæœŸï¼Œä¸åšæ‹¦æˆª</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RefreshTokenInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerInterceptor</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1. è·å–è¯·æ±‚å¤´ä¸­çš„token</span>
        <span class="token class-name">String</span> token <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">&quot;authorization&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 2. ä»redisä¸­è·å–ç”¨æˆ·</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> entries <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span><span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>LOGIN_USER_KEY <span class="token operator">+</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>entries<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">UserDTO</span> user <span class="token operator">=</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">fillBeanWithMap</span><span class="token punctuation">(</span>entries<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">UserDTO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 4. å°†ç”¨æˆ·å­˜å…¥ThreadLocal</span>
        <span class="token class-name">UserDTO</span> userDTO <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserDTO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> userDTO<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">saveUser</span><span class="token punctuation">(</span>userDTO<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 5. tokenç»­æœŸ</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">expire</span><span class="token punctuation">(</span><span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>LOGIN_USER_KEY <span class="token operator">+</span> token<span class="token punctuation">,</span> <span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>LOGIN_USER_TTL<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MINUTES<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 6. æ”¾è¡Œ</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterCompletion</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">,</span> <span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// ç§»é™¤ç”¨æˆ·</span>
        <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">removeUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p><code>LoginInterceptor</code>ï¼Œæ‹¦æˆªç”¨æˆ·è¯·æ±‚</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerInterceptor</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span><span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            response<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>é…ç½®æ‹¦æˆªå™¨</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebConfig</span> <span class="token keyword">implements</span> <span class="token class-name">WebMvcConfigurer</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addInterceptors</span><span class="token punctuation">(</span><span class="token class-name">InterceptorRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        registry<span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RefreshTokenInterceptor</span><span class="token punctuation">(</span>redisTemplate<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">addPathPatterns</span><span class="token punctuation">(</span><span class="token string">&quot;/**&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">order</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        registry<span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LoginInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">excludePathPatterns</span><span class="token punctuation">(</span>
                        <span class="token string">&quot;/user/code&quot;</span><span class="token punctuation">,</span>
                        <span class="token string">&quot;/user/login&quot;</span><span class="token punctuation">,</span>
                        <span class="token string">&quot;/blog/hot&quot;</span><span class="token punctuation">,</span>
                        <span class="token string">&quot;/shop/**&quot;</span><span class="token punctuation">,</span>
                        <span class="token string">&quot;/shop-type/**&quot;</span><span class="token punctuation">,</span>
                        <span class="token string">&quot;/voucher/**&quot;</span>
                <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">order</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ol> <h3 id="_4-2-å•†æˆ·æŸ¥è¯¢ç¼“å­˜"><a href="#_4-2-å•†æˆ·æŸ¥è¯¢ç¼“å­˜" class="header-anchor">#</a> 4.2  å•†æˆ·æŸ¥è¯¢ç¼“å­˜</h3> <h4 id="_4-2-1-æŸ¥è¯¢å•†é“ºç¼“å­˜æµç¨‹"><a href="#_4-2-1-æŸ¥è¯¢å•†é“ºç¼“å­˜æµç¨‹" class="header-anchor">#</a> 4.2.1 æŸ¥è¯¢å•†é“ºç¼“å­˜æµç¨‹</h4> <div class="language-flow extra-class"><pre class="language-flow"><code>st<span class="token operator">=&gt;</span>start<span class="token operator">:</span> å¼€å§‹
submitShop<span class="token operator">=&gt;</span>operation<span class="token operator">:</span> æäº¤å•†é“ºid
queryRedis<span class="token operator">=&gt;</span>operation<span class="token operator">:</span> ä»Redisä¸­æŸ¥è¯¢å•†é“ºç¼“å­˜
checkCache<span class="token operator">=&gt;</span>condition<span class="token operator">:</span> åˆ¤æ–­ç¼“å­˜æ˜¯å¦å‘½ä¸­
returnShopInfo<span class="token operator">=&gt;</span>operation<span class="token operator">:</span> è¿”å›å•†é“ºä¿¡æ¯
queryDataBase<span class="token operator">=&gt;</span>operation<span class="token operator">:</span> ä»æ•°æ®åº“ä¸­æŸ¥è¯¢å•†é“ºä¿¡æ¯
checkShop<span class="token operator">=&gt;</span>condition<span class="token operator">:</span> åˆ¤æ–­å•†æˆ·æ˜¯å¦å­˜åœ¨
saveShopToRedis<span class="token operator">=&gt;</span>operation<span class="token operator">:</span> å°†å•†æˆ·ä¿¡æ¯å­˜å…¥Redis
returnNotFound<span class="token operator">=&gt;</span>operation<span class="token operator">:</span> è¿”å›<span class="token number">404</span>
e<span class="token operator">=&gt;</span>end<span class="token operator">:</span> ç»“æŸæ¡†
st<span class="token operator">-</span><span class="token operator">&gt;</span>submitShop<span class="token operator">-</span><span class="token operator">&gt;</span>queryRedis<span class="token operator">-</span><span class="token operator">&gt;</span>checkCache
<span class="token function">checkCache</span><span class="token punctuation">(</span>yes<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>returnShopInfo<span class="token operator">-</span><span class="token operator">&gt;</span>e
<span class="token function">checkCache</span><span class="token punctuation">(</span>no<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>queryDataBase<span class="token operator">-</span><span class="token operator">&gt;</span>checkShop
<span class="token function">checkShop</span><span class="token punctuation">(</span>yes<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>saveShopToRedis<span class="token operator">-</span><span class="token operator">&gt;</span>returnShopInfo<span class="token operator">-</span><span class="token operator">&gt;</span>e
<span class="token function">checkShop</span><span class="token punctuation">(</span>no<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>returnNotFound<span class="token operator">-</span><span class="token operator">&gt;</span>e
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Shop</span> <span class="token function">queryShopById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. ä»Redisä¸­æŸ¥è¯¢ç¼“å­˜</span>
    <span class="token class-name">String</span> shopJson <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>CACHE_SHOP_KEY <span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>shopJson<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>shopJson<span class="token punctuation">,</span> <span class="token class-name">Shop</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 2. æŸ¥è¯¢æ•°æ®åº“</span>
    <span class="token class-name">Shop</span> shop <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;å•†æˆ·ä¸å­˜åœ¨&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 3. å­˜å…¥Redis</span>
    redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>CACHE_SHOP_KEY  <span class="token operator">+</span> id<span class="token punctuation">,</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> shop<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_4-2-2-ç¼“å­˜æ›´æ–°ç­–ç•¥"><a href="#_4-2-2-ç¼“å­˜æ›´æ–°ç­–ç•¥" class="header-anchor">#</a> 4.2.2 ç¼“å­˜æ›´æ–°ç­–ç•¥</h4> <table><thead><tr><th></th> <th>å†…å­˜æ·˜æ±°</th> <th>è¶…æ—¶å‰”é™¤</th> <th>ä¸»åŠ¨æ›´æ–°</th></tr></thead> <tbody><tr><td>è¯´æ˜</td> <td>ä¸ç”¨è‡ªå·±ç»´æŠ¤ï¼Œåˆ©ç”¨Redisçš„å†…å­˜æ·˜æ±°æœºåˆ¶ï¼Œå½“å†…å­˜ä¸è¶³æ—¶è‡ªåŠ¨æ·˜æ±°éƒ¨åˆ†æ•°æ®ã€‚ä¸‹æ¬¡æŸ¥è¯¢æ—¶æ›´æ–°ç¼“å­˜</td> <td>ç»™ç¼“å­˜æ•°æ®æ·»åŠ TTLæ—¶é—´ï¼Œåˆ°æœŸåè‡ªåŠ¨åˆ é™¤ç¼“å­˜ã€‚ä¸‹æ¬¡æŸ¥è¯¢æ—¶æ›´æ–°ç¼“å­˜</td> <td>ç¼–å†™ä¸šåŠ¡é€»è¾‘ï¼Œåœ¨ä¿®æ”¹æ•°æ®åº“çš„åŒæ—¶ï¼Œæ›´æ–°ç¼“å­˜</td></tr> <tr><td>ä¸€è‡´æ€§</td> <td>å·®</td> <td>ä¸€èˆ¬</td> <td>å¥½</td></tr> <tr><td>ç»´æŠ¤æˆæœ¬</td> <td>æ— </td> <td>ä½</td> <td>é«˜</td></tr></tbody></table> <ul><li>ä½ä¸€è‡´æ€§éœ€æ±‚ï¼šä½¿ç”¨å†…å­˜æ·˜æ±°æœºåˆ¶ã€‚ä¾‹å¦‚åº—é“ºç±»å‹çš„æŸ¥è¯¢ç¼“å­˜</li> <li>é«˜ä¸€è‡´æ€§éœ€æ±‚ï¼šä¸»åŠ¨æ›´æ–°ï¼Œå¹¶ä»¥è¶…æ—¶å‰”é™¤ä½œä¸ºå…œåº•æ–¹æ¡ˆã€‚ä¾‹å¦‚åº—é“ºè¯¦æƒ…æŸ¥è¯¢çš„ç¼“å­˜</li></ul> <p><strong>ä¸»åŠ¨æ›´æ–°ç­–ç•¥</strong></p> <ol><li><p>ç”±ç¼“å­˜çš„è°ƒç”¨è€…ï¼Œåœ¨æ›´æ–°æ•°æ®åº“çš„åŒæ—¶æ›´æ–°ç¼“å­˜</p> <ul><li><p>åˆ é™¤ç¼“å­˜è¿˜æ˜¯æ›´æ–°ç¼“å­˜</p> <p>æ›´æ–°ç¼“å­˜ï¼šæ¯æ¬¡æ›´æ–°æ•°æ®åº“éƒ½æ›´æ–°ç¼“å­˜ï¼Œæ— æ•ˆå†™æ“ä½œè¾ƒå¤š</p> <p>åˆ é™¤ç¼“å­˜ğŸŒŸï¼šæ›´æ–°æ•°æ®åº“æ—¶è®©ç¼“å­˜å¤±æ•ˆï¼ŒæŸ¥è¯¢æ—¶å†æ›´æ–°ç¼“å­˜</p></li> <li><p>å¦‚ä½•ä¿è¯ç¼“å­˜ä¸æ•°æ®åº“çš„æ“ä½œçš„åŒæ—¶æˆåŠŸæˆ–å¤±è´¥</p> <p>å•ä½“ç³»ç»Ÿï¼Œå°†ç¼“å­˜ä¸æ•°æ®åº“æ“ä½œæ”¾åœ¨ä¸€ä¸ªäº‹åŠ¡</p> <p>åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œåˆ©ç”¨TCCç­‰åˆ†å¸ƒå¼äº‹åŠ¡æ–¹æ¡ˆ</p></li> <li><p>å…ˆæ“ä½œç¼“å­˜è¿˜æ˜¯å…ˆæ“ä½œæ•°æ®åº“</p> <p>å…ˆåˆ é™¤ç¼“å­˜ï¼Œå†æ“ä½œæ•°æ®åº“</p> <p>ğŸŒŸå…ˆæ“ä½œæ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜</p></li></ul></li> <li><p>ç¼“å­˜ä¸æ•°æ®åº“æ•´åˆä¸ºä¸€ä¸ªæœåŠ¡ï¼Œç”±æœåŠ¡æ¥ç»´æŠ¤ä¸€è‡´æ€§ã€‚è°ƒç”¨è€…è°ƒç”¨æ”¹æœåŠ¡ï¼Œæ— åºå…³å¿ƒç¼“å­˜ä¸€è‡´æ€§é—®é¢˜</p></li> <li><p>è°ƒç”¨è€…åªæ“ä½œç¼“å­˜ï¼Œç”±å…¶ä»–çº¿ç¨‹å¼‚æ­¥çš„å°†ç¼“å­˜æŒä¹…åŒ–åˆ°æ•°æ®åº“ï¼Œä¿è¯æœ€ç»ˆä¸€è‡´</p></li></ol> <h4 id="_4-2-3-ç¼“å­˜æ›´æ–°å®æˆ˜"><a href="#_4-2-3-ç¼“å­˜æ›´æ–°å®æˆ˜" class="header-anchor">#</a> 4.2.3 ç¼“å­˜æ›´æ–°å®æˆ˜</h4> <p>ç»™æŸ¥è¯¢å•†é“ºçš„ç¼“å­˜æ·»åŠ è¶…æ—¶å‰”é™¤å’Œä¸»åŠ¨æ›´æ–°ç­–ç•¥</p> <ol><li><p>æ ¹æ®idæŸ¥è¯¢åº—é“ºæ—¶ï¼Œå¦‚æœç¼“å­˜æœªå‘½ä¸­ï¼Œåˆ™æŸ¥è¯¢æ•°æ®åº“ï¼Œå°†æ•°æ®åº“ç»“æœå†™å…¥ç¼“å­˜ï¼Œå¹¶è®¾ç½®è¶…æ—¶æ—¶é—´</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Shop</span> <span class="token function">queryShopById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. ä»Redisä¸­æŸ¥è¯¢ç¼“å­˜</span>
    <span class="token class-name">String</span> shopJson <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>CACHE_SHOP_KEY <span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>shopJson<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>shopJson<span class="token punctuation">,</span> <span class="token class-name">Shop</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 2. æŸ¥è¯¢æ•°æ®åº“</span>
    <span class="token class-name">Shop</span> shop <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;å•†æˆ·ä¸å­˜åœ¨&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 3. å­˜å…¥Redis</span>
    redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>CACHE_SHOP_KEY  <span class="token operator">+</span> id<span class="token punctuation">,</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">30L</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MINUTES<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> shop<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>æ ¹æ®idä¿®æ”¹åº—é“ºæ—¶ï¼Œå…ˆä¿®æ”¹æ•°æ®åº“å†åˆ é™¤ç¼“å­˜</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Override</span>
<span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateShop</span><span class="token punctuation">(</span><span class="token class-name">Shop</span> shop<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>shop<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;idä¸èƒ½ä¸ºç©º&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 1. æ›´æ–°åº—é“ºä¿¡æ¯</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">lambdaUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>shop<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Shop</span><span class="token operator">::</span><span class="token function">getName</span><span class="token punctuation">,</span> shop<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">Shop</span><span class="token operator">::</span><span class="token function">getId</span><span class="token punctuation">,</span> shop<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 2. åˆ é™¤ç¼“å­˜</span>
    redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>CACHE_SHOP_KEY  <span class="token operator">+</span> shop<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ol> <h4 id="_4-2-4-ç¼“å­˜ç©¿é€"><a href="#_4-2-4-ç¼“å­˜ç©¿é€" class="header-anchor">#</a> 4.2.4 ç¼“å­˜ç©¿é€</h4> <p>ç¼“å­˜ç©¿é€æ˜¯æŒ‡å®¢æˆ·ç«¯è¯·æ±‚çš„æ•°æ®åœ¨ç¼“å­˜ä¸­å’Œæ•°æ®åº“ä¸­éƒ½ä¸å­˜åœ¨ï¼Œè¿™æ ·ç¼“å­˜æ°¸è¿œä¸ä¼šç”Ÿæ•ˆï¼Œè¿™äº›è¯·æ±‚éƒ½ä¼šç›´æ¥æ‰“åˆ°æ•°æ®åº“</p> <div class="spinner" style="background:rgb(66, 185, 131);" data-v-1bbcb91a></div><p>å¸¸è§çš„è§£å†³æ–¹æ¡ˆæœ‰ä¸¤ç§ï¼š</p> <ul><li><p>ç¼“å­˜ç©ºå¯¹è±¡ï¼ŒæŸ¥è¯¢åˆ°æ•°æ®æ—¶ï¼Œå½“æ•°æ®åº“æ²¡æœ‰å¯¹åº”çš„æ•°æ®ï¼Œç¼“å­˜ä¸€ä¸ªç©ºæ•°æ®åˆ°Redisä¸­</p> <p>ä¼˜ç‚¹ï¼šå®ç°ç®€å•ï¼Œç»´æŠ¤æ–¹ä¾¿</p> <p>ç¼ºç‚¹ï¼šé¢å¤–çš„å†…å­˜æ¶ˆè€—ï¼ˆè®¾ç½®TTLï¼‰ï¼Œå¯èƒ½é€ æˆçŸ­æœŸçš„æ•°æ®ä¸ä¸€è‡´</p></li> <li><p>å¸ƒéš†è¿‡æ»¤</p> <div class="spinner" style="background:rgb(66, 185, 131);" data-v-1bbcb91a></div><p>â€‹	ä¼˜ç‚¹ï¼šå†…å­˜å ç”¨è¾ƒå°‘ï¼Œæ²¡æœ‰å¤šä½™çš„key</p> <p>â€‹	ç¼ºç‚¹ï¼šå­˜åœ¨è¯¯åˆ¤çš„å¯èƒ½</p></li> <li><p>å¢å¼ºidçš„å¤æ‚åº¦ï¼Œé¿å…è¢«çŒœæµ‹idè§„å¾‹</p></li> <li><p>åšå¥½æ•°æ®çš„åŸºç¡€æ ¼å¼æ ¡éªŒ</p></li> <li><p>åŠ å¼ºç”¨æˆ·æƒé™æ ¡éªŒ</p></li> <li><p>åšå¥½çƒ­ç‚¹å‚æ•°çš„é™æµ</p></li></ul> <h4 id="_4-2-5-ç¼“å­˜ç©¿é€å®æˆ˜"><a href="#_4-2-5-ç¼“å­˜ç©¿é€å®æˆ˜" class="header-anchor">#</a> 4.2.5 ç¼“å­˜ç©¿é€å®æˆ˜</h4> <div class="language-flow extra-class"><pre class="language-flow"><code>st<span class="token operator">=&gt;</span>start<span class="token operator">:</span> å¼€å§‹
submitShop<span class="token operator">=&gt;</span>operation<span class="token operator">:</span> æäº¤å•†é“ºid
queryRedis<span class="token operator">=&gt;</span>operation<span class="token operator">:</span> ä»Redisä¸­æŸ¥è¯¢å•†é“ºç¼“å­˜
checkCache<span class="token operator">=&gt;</span>condition<span class="token operator">:</span> åˆ¤æ–­ç¼“å­˜æ˜¯å¦å‘½ä¸­
returnShopInfo<span class="token operator">=&gt;</span>operation<span class="token operator">:</span> è¿”å›å•†é“ºä¿¡æ¯
queryDataBase<span class="token operator">=&gt;</span>operation<span class="token operator">:</span> ä»æ•°æ®åº“ä¸­æŸ¥è¯¢å•†é“ºä¿¡æ¯
checkShop<span class="token operator">=&gt;</span>condition<span class="token operator">:</span> åˆ¤æ–­å•†æˆ·æ˜¯å¦å­˜åœ¨
saveShopToRedis<span class="token operator">=&gt;</span>operation<span class="token operator">:</span> å°†å•†æˆ·ä¿¡æ¯å­˜å…¥Redis
saveNullToRedis<span class="token operator">=&gt;</span>operation<span class="token operator">:</span> å°†ç©ºå¯¹è±¡å­˜å…¥Redis
e<span class="token operator">=&gt;</span>end<span class="token operator">:</span> ç»“æŸæ¡†
st<span class="token operator">-</span><span class="token operator">&gt;</span>submitShop<span class="token operator">-</span><span class="token operator">&gt;</span>queryRedis<span class="token operator">-</span><span class="token operator">&gt;</span>checkCache
<span class="token function">checkCache</span><span class="token punctuation">(</span>yes<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>returnShopInfo<span class="token operator">-</span><span class="token operator">&gt;</span>e
<span class="token function">checkCache</span><span class="token punctuation">(</span>no<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>queryDataBase<span class="token operator">-</span><span class="token operator">&gt;</span>checkShop
<span class="token function">checkShop</span><span class="token punctuation">(</span>yes<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>saveShopToRedis<span class="token operator">-</span><span class="token operator">&gt;</span>returnShopInfo<span class="token operator">-</span><span class="token operator">&gt;</span>e
<span class="token function">checkShop</span><span class="token punctuation">(</span>no<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>saveNullToRedis<span class="token operator">-</span><span class="token operator">&gt;</span>e
</code></pre></div><p>ç¼“å­˜ç©ºå¯¹è±¡çš„æ–¹å¼</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Shop</span> <span class="token function">queryShopById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. ä»Redisä¸­æŸ¥è¯¢ç¼“å­˜</span>
    <span class="token class-name">String</span> shopJson <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>CACHE_SHOP_KEY <span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>shopJson<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>shopJson<span class="token punctuation">,</span> <span class="token class-name">Shop</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 2. åˆ¤æ–­å‘½ä¸­çš„æ˜¯å¦æ˜¯ç©ºå­—ç¬¦ä¸² (&quot;&quot;)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>shopJson <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;å•†æˆ·ä¸å­˜åœ¨&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 3. æŸ¥è¯¢æ•°æ®åº“</span>
    <span class="token class-name">Shop</span> shop <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>CACHE_SHOP_KEY  <span class="token operator">+</span> id<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>CACHE_NULL_TTL<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MINUTES<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;å•†æˆ·ä¸å­˜åœ¨&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 4. å­˜å…¥Redis</span>
    redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>CACHE_SHOP_KEY  <span class="token operator">+</span> id<span class="token punctuation">,</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>CACHE_SHOP_TTL<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MINUTES<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> shop<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_4-2-6-ç¼“å­˜é›ªå´©"><a href="#_4-2-6-ç¼“å­˜é›ªå´©" class="header-anchor">#</a> 4.2.6 ç¼“å­˜é›ªå´©</h4> <p>ç¼“å­˜é›ªå´©æ˜¯æŒ‡åœ¨åŒä¸€æ—¶é—´æ®µå†…å¤§é‡çš„ç¼“å­˜keyåŒæ—¶å¤±æ•ˆæˆ–è€…RedisæœåŠ¡å®•æœºï¼Œå¯¼è‡´å¤§é‡è¯·æ±‚åˆ°è¾¾æ•°æ®åº“ï¼Œå¸¦æ¥å·¨å¤§å‹åŠ›</p> <p>è§£å†³æ–¹æ¡ˆï¼š</p> <ul><li>ç»™ä¸åŒçš„Keyçš„TTLæ·»åŠ éšæœºå€¼</li> <li>åˆ©ç”¨Redisé›†ç¾¤æé«˜æœåŠ¡çš„å¯ç”¨æ€§</li> <li>ç»™ç¼“å­˜ä¸šåŠ¡æ·»åŠ é™çº§é™æµç­–ç•¥</li> <li>ç»™ä¸šåŠ¡æ·»åŠ å¤šçº§ç¼“å­˜</li></ul> <h4 id="_4-2-7-ç¼“å­˜å‡»ç©¿"><a href="#_4-2-7-ç¼“å­˜å‡»ç©¿" class="header-anchor">#</a> 4.2.7 ç¼“å­˜å‡»ç©¿</h4> <p>ç¼“å­˜å‡»ç©¿é—®é¢˜ä¹Ÿå«çƒ­ç‚¹keyé—®é¢˜ï¼Œå°±æ˜¯ä¸€ä¸ªè¢«é«˜å¹¶å‘è®¿é—®å¹¶ä¸”ç¼“å­˜é‡å»ºä¸šåŠ¡è¾ƒå¤æ‚çš„keyçªç„¶å¤±æ•ˆäº†ï¼Œæ— æ•°çš„è¯·æ±‚è®¿é—®ä¼šåœ¨ç¬é—´ç»™æ•°æ®åº“å¸¦æ¥å·¨å¤§çš„å†²å‡»</p> <p>è§£å†³æ–¹æ¡ˆï¼š</p> <ul><li>äº’æ–¥é”</li> <li>é€»è¾‘è¿‡æœŸ</li></ul> <table><thead><tr><th>è§£å†³æ–¹æ¡ˆ</th> <th>ä¼˜ç‚¹</th> <th>ç¼ºç‚¹</th></tr></thead> <tbody><tr><td>äº’æ–¥é”</td> <td>æ²¡æœ‰é¢å¤–çš„å†…å­˜æ¶ˆè€—<br>ä¿è¯ä¸€è‡´æ€§<br>å®ç°ç®€å•</td> <td>çº¿ç¨‹éœ€è¦ç­‰å¾…ï¼Œæ€§èƒ½å—å½±å“<br>å¯èƒ½æœ‰æ­»é”é£é™©</td></tr> <tr><td>é€»è¾‘è¿‡æœŸ</td> <td>çº¿ç¨‹æ— éœ€ç­‰å¾…ï¼Œæ€§èƒ½è¾ƒå¥½</td> <td>ä¸ä¿è¯ä¸€è‡´æ€§<br>æœ‰é¢å¤–å†…å­˜æ¶ˆè€—<br>å®ç°å¤æ‚</td></tr></tbody></table> <h4 id="_4-2-8-ç¼“å­˜å‡»ç©¿å®æˆ˜"><a href="#_4-2-8-ç¼“å­˜å‡»ç©¿å®æˆ˜" class="header-anchor">#</a> 4.2.8 ç¼“å­˜å‡»ç©¿å®æˆ˜</h4> <ol><li><p>åˆ©ç”¨äº’æ–¥é”</p> <div class="spinner" style="background:rgb(66, 185, 131);" data-v-1bbcb91a></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * è·å–é”
 * @param key é”çš„key
 * @param expire è¿‡æœŸæ—¶é—´
 * @return æ˜¯å¦è·å–æˆåŠŸ
 */</span>
<span class="token keyword">private</span> <span class="token class-name">Boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Long</span> expire<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Boolean</span> flag <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span> expire<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">BooleanUtil</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * é‡Šæ”¾é”
 * @param key
 */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * äº’æ–¥é”è§£å†³ç¼“å­˜å‡»ç©¿
 * @param id å•†é“ºid
 * @return å•†é“ºä¿¡æ¯
 */</span>
<span class="token keyword">public</span> <span class="token class-name">Shop</span> <span class="token function">queryWithMutex</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. ä»Redisä¸­æŸ¥è¯¢ç¼“å­˜</span>
    <span class="token class-name">String</span> shopJson <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>CACHE_SHOP_KEY <span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>shopJson<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>shopJson<span class="token punctuation">,</span> <span class="token class-name">Shop</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 2. åˆ¤æ–­å‘½ä¸­çš„æ˜¯å¦æ˜¯ç©ºå­—ç¬¦ä¸² (&quot;&quot;)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>shopJson <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;å•†æˆ·ä¸å­˜åœ¨&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 3. è·å–äº’æ–¥é”</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>LOCK_SHOP_KEY <span class="token operator">+</span> id<span class="token punctuation">,</span> <span class="token number">10L</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">queryWithMutex</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 4. åŒé‡æ£€æµ‹ç¼“å­˜</span>
        shopJson <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>CACHE_SHOP_KEY <span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>shopJson<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>shopJson<span class="token punctuation">,</span> <span class="token class-name">Shop</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>shopJson<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 5. æŸ¥è¯¢æ•°æ®åº“</span>
        <span class="token comment">// æ¨¡æ‹ŸæŸ¥è¯¢è€—æ—¶</span>
        <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Shop</span> shop <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>CACHE_SHOP_KEY  <span class="token operator">+</span> id<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>CACHE_NULL_TTL<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MINUTES<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;å•†æˆ·ä¸å­˜åœ¨&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 6. å­˜å…¥Redis</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>CACHE_SHOP_KEY  <span class="token operator">+</span> id<span class="token punctuation">,</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>CACHE_SHOP_TTL<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MINUTES<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> shop<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token comment">// é‡Šæ”¾é”</span>
        <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>LOCK_SHOP_KEY <span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>é€»è¾‘è¿‡æœŸ</p> <div class="spinner" style="background:rgb(66, 185, 131);" data-v-1bbcb91a></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">Executor</span> executor<span class="token punctuation">;</span>

<span class="token comment">/**
 * è·å–é”
 * @param key é”çš„key
 * @param expire è¿‡æœŸæ—¶é—´
 * @return æ˜¯å¦è·å–æˆåŠŸ
 */</span>
<span class="token keyword">private</span> <span class="token class-name">Boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Long</span> expire<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Boolean</span> flag <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span> expire<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">BooleanUtil</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * é‡Šæ”¾é”
 * @param key
 */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * é€»è¾‘è¿‡æœŸ-ç¼“å­˜å‡»ç©¿
 * @param id å•†æˆ·id
 * @return å•†æˆ·ä¿¡æ¯
 */</span>
<span class="token keyword">public</span> <span class="token class-name">Shop</span> <span class="token function">queryWithLogicExpire</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. ä»Redisä¸­æŸ¥è¯¢ç¼“å­˜</span>
    <span class="token class-name">String</span> shopJson <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>CACHE_SHOP_KEY <span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>shopJson<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 2. æ ¡éªŒæ•°æ®æ˜¯å¦è¿‡æœŸ</span>
    <span class="token class-name">RedisData</span> redisData <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>shopJson<span class="token punctuation">,</span> <span class="token class-name">RedisData</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>redisData<span class="token punctuation">.</span><span class="token function">getExpireTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAfter</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// æœªè¿‡æœŸç›´æ¥è¿”å›</span>
        <span class="token keyword">return</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">JSONObject</span><span class="token punctuation">)</span> redisData<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Shop</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 3. å°è¯•è·å–é”</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>LOCK_SHOP_KEY <span class="token operator">+</span> id<span class="token punctuation">,</span> <span class="token number">10L</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è·å–é”æˆåŠŸ é‡å»ºç¼“å­˜</span>
        <span class="token comment">// åŒé‡æ£€æµ‹ æ˜¯å¦è¿‡æœŸ</span>
        redisData <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>shopJson<span class="token punctuation">,</span> <span class="token class-name">RedisData</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>redisData<span class="token punctuation">.</span><span class="token function">getExpireTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isBefore</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// é‡å»ºç¼“å­˜</span>
            executor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment">// æŸ¥è¯¢æ•°æ®åº“</span>
                    <span class="token class-name">Shop</span> shop <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">200L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token class-name">RedisData</span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    data<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    data<span class="token punctuation">.</span><span class="token function">setExpireTime</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">plusMinutes</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">// å­˜å…¥Redis</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>CACHE_SHOP_KEY <span class="token operator">+</span> id<span class="token punctuation">,</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>LOCK_SHOP_KEY <span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// è·å–é”å¤±è´¥ è¿”å›æ—§æ•°æ®</span>
    <span class="token keyword">return</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">JSONObject</span><span class="token punctuation">)</span> redisData<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Shop</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ol> <h4 id="_4-2-9-ç¼“å­˜å·¥å…·ç±»"><a href="#_4-2-9-ç¼“å­˜å·¥å…·ç±»" class="header-anchor">#</a> 4.2.9 ç¼“å­˜å·¥å…·ç±»</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CacheClient</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Executor</span> executor<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">,</span> <span class="token class-name">Long</span> time<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span> time<span class="token punctuation">,</span> unit<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setWithLogicExpire</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">,</span> <span class="token class-name">Long</span> time<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">RedisData</span> redisData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        redisData<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        redisData<span class="token punctuation">.</span><span class="token function">setExpireTime</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">plusSeconds</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>redisData<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * å¤„ç†ç¼“å­˜ç©¿é€
     * @param id æŸ¥è¯¢çš„å”¯ä¸€å‡­è¯
     * @return æŸ¥è¯¢ä¿¡æ¯
     */</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">,</span> <span class="token class-name">D</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">R</span> <span class="token function">queryWithPassThrough</span><span class="token punctuation">(</span><span class="token class-name">String</span> keyPrefix<span class="token punctuation">,</span> <span class="token class-name">D</span> id<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> type<span class="token punctuation">,</span> <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">D</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> function<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> keyPrefix <span class="token operator">+</span> id<span class="token punctuation">;</span>
        <span class="token comment">// 1. ä»Redisä¸­æŸ¥è¯¢ç¼“å­˜</span>
        <span class="token class-name">String</span> json <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 2. åˆ¤æ–­å‘½ä¸­çš„æ˜¯å¦æ˜¯ç©ºå­—ç¬¦ä¸² (&quot;&quot;)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>json <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 3. æŸ¥è¯¢æ•°æ®åº“</span>
        <span class="token class-name">R</span> result <span class="token operator">=</span> function<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>CACHE_NULL_TTL<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MINUTES<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 4. å­˜å…¥Redis</span>
            redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>CACHE_SHOP_TTL<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MINUTES<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment">/**
     * é€»è¾‘è¿‡æœŸ-ç¼“å­˜å‡»ç©¿
     * @param id æŸ¥è¯¢çš„å”¯ä¸€å‡­è¯
     * @return æŸ¥è¯¢ä¿¡æ¯
     */</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">,</span> <span class="token class-name">D</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">R</span> <span class="token function">queryWithLogicExpire</span><span class="token punctuation">(</span><span class="token class-name">String</span> keyPrefix<span class="token punctuation">,</span> <span class="token class-name">D</span> id<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> type<span class="token punctuation">,</span> <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">D</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> function<span class="token punctuation">,</span> <span class="token class-name">Long</span> time<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> keyPrefix <span class="token operator">+</span> id<span class="token punctuation">;</span>
        <span class="token class-name">String</span> lockKey <span class="token operator">=</span> <span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>LOCK_SHOP_KEY <span class="token operator">+</span> id<span class="token punctuation">;</span>
        <span class="token comment">// 1. ä»Redisä¸­æŸ¥è¯¢ç¼“å­˜</span>
        <span class="token class-name">String</span> json <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 2. æ ¡éªŒæ•°æ®æ˜¯å¦è¿‡æœŸ</span>
        <span class="token class-name">RedisData</span> redisData <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">RedisData</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>redisData<span class="token punctuation">.</span><span class="token function">getExpireTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAfter</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// æœªè¿‡æœŸç›´æ¥è¿”å›</span>
            <span class="token keyword">return</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">JSONObject</span><span class="token punctuation">)</span> redisData<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 3. å°è¯•è·å–é”</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tryLock</span><span class="token punctuation">(</span>lockKey<span class="token punctuation">,</span> <span class="token number">10L</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// è·å–é”æˆåŠŸ é‡å»ºç¼“å­˜</span>
            <span class="token comment">// åŒé‡æ£€æµ‹ æ˜¯å¦è¿‡æœŸ</span>
            redisData <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">RedisData</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>redisData<span class="token punctuation">.</span><span class="token function">getExpireTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isBefore</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// é‡å»ºç¼“å­˜</span>
                executor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token comment">// æŸ¥è¯¢æ•°æ®åº“</span>
                        <span class="token class-name">R</span> result <span class="token operator">=</span> function<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">200L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token comment">// å­˜å…¥Redis</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setWithLogicExpire</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> result<span class="token punctuation">,</span> time<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                        <span class="token function">unlock</span><span class="token punctuation">(</span>lockKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// è·å–é”å¤±è´¥ è¿”å›æ—§æ•°æ®</span>
        <span class="token keyword">return</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">JSONObject</span><span class="token punctuation">)</span> redisData<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment">/**
     * è·å–é”
     * @param key é”çš„key
     * @param expire è¿‡æœŸæ—¶é—´
     * @return æ˜¯å¦è·å–æˆåŠŸ
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Long</span> expire<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Boolean</span> flag <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span> expire<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">BooleanUtil</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * é‡Šæ”¾é”
     * @param key
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_4-3-ä¼˜æƒ åˆ¸ç§’æ€"><a href="#_4-3-ä¼˜æƒ åˆ¸ç§’æ€" class="header-anchor">#</a> 4.3  ä¼˜æƒ åˆ¸ç§’æ€</h3> <h4 id="_4-3-1-å…¨å±€å”¯ä¸€id"><a href="#_4-3-1-å…¨å±€å”¯ä¸€id" class="header-anchor">#</a> 4.3.1 å…¨å±€å”¯ä¸€ID</h4> <p>å½“ç”¨æˆ·æŠ¢è´­æ—¶ï¼Œå°±ä¼šç”Ÿæˆè®¢å•å¹¶ä¿å­˜åˆ°<code>tb_vocher_order</code>è¿™å¼ è¡¨ä¸­ï¼Œè€Œè®¢å•è¡¨å¦‚æœä½¿ç”¨æ•°æ®åº“è‡ªå¢IDå°±å­˜åœ¨ä¸€äº›é—®é¢˜</p> <ul><li>idçš„è§„å¾‹æ€§å¤ªæ˜æ˜¾</li> <li>å—å•è¡¨æ•°æ®é‡çš„é™åˆ¶</li></ul> <p>å…¨å±€IDç”Ÿæˆå™¨ï¼Œæ˜¯ä¸€ç§åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸‹ç”¨æ¥ç”Ÿæˆå…¨å±€å”¯ä¸€IDçš„å·¥å…·ï¼Œä¸€èˆ¬è¦æ»¡è¶³ä¸‹åˆ—ç‰¹æ€§</p> <div class="spinner" style="background:rgb(66, 185, 131);" data-v-1bbcb91a></div><p>IDçš„ç»„æˆéƒ¨åˆ†</p> <ul><li>ç¬¦å·ä½ï¼š1bitï¼Œæ°¸è¿œä¸º0</li> <li>æ—¶é—´æˆ³ï¼š31bitï¼Œå¯ä»¥ä½¿ç”¨69å¹´</li> <li>åºåˆ—å·ï¼š32bitï¼Œç§’å†…çš„è®¡æ•°å™¨ï¼Œæ”¯æŒæ¯ç§’äº§ç”Ÿ2^32ä¸ªä¸åŒçš„ID</li></ul> <div class="spinner" style="background:rgb(66, 185, 131);" data-v-1bbcb91a></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisIdWorker</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * å¼€å§‹æ—¶é—´æˆ³
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token keyword">long</span> BEGIN_TIMESTAMP <span class="token operator">=</span> <span class="token number">1640995200L</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * åºåˆ—å·ä½æ•°
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token keyword">int</span> COUNT_BITS <span class="token operator">=</span> <span class="token number">32</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">DateTimeFormatter</span> DATE_TIME_FORMATTER <span class="token operator">=</span> <span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span><span class="token function">ofPattern</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy:MM:dd&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">nextId</span><span class="token punctuation">(</span><span class="token class-name">String</span> keyPrefix<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1. ç”Ÿæˆæ—¶é—´æˆ³</span>
        <span class="token class-name">LocalDateTime</span> now <span class="token operator">=</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">long</span> nowSecond <span class="token operator">=</span> now<span class="token punctuation">.</span><span class="token function">toEpochSecond</span><span class="token punctuation">(</span><span class="token class-name">ZoneOffset</span><span class="token punctuation">.</span>UTC<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> timestamp <span class="token operator">=</span> nowSecond <span class="token operator">-</span> BEGIN_TIMESTAMP<span class="token punctuation">;</span>

        <span class="token comment">// 2. ç”Ÿæˆåºåˆ—å·</span>
        <span class="token keyword">long</span> count <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token string">&quot;icr:&quot;</span> <span class="token operator">+</span> keyPrefix <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> now<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>DATE_TIME_FORMATTER<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3. æ‹¼æ¥å¹¶è¿”å›</span>
        <span class="token keyword">return</span> timestamp <span class="token operator">&lt;&lt;</span> COUNT_BITS <span class="token operator">|</span> count<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å…¨å±€å”¯ä¸€Idçš„ç”Ÿæˆç­–ç•¥</p> <ul><li>UUID</li> <li>Redisè‡ªå¢</li> <li>é›ªèŠ±ç®—æ³•</li> <li>æ•°æ®åº“è‡ªå¢</li></ul> <h4 id="_4-3-2-æ·»åŠ ä¼˜æƒ åˆ¸"><a href="#_4-3-2-æ·»åŠ ä¼˜æƒ åˆ¸" class="header-anchor">#</a> 4.3.2 æ·»åŠ ä¼˜æƒ åˆ¸</h4> <p>æ¯ä¸ªåº—é“ºéƒ½å¯ä»¥å‘å¸ƒä¼˜æƒ åˆ¸ï¼Œåˆ†ä¸ºå¹³ä»·åˆ¸å’Œç‰¹ä»·åˆ¸ã€‚å¹³ä»·åˆ¸å¯ä»¥ä»»æ„è´­ä¹°ï¼Œè€Œç‰¹ä»·åˆ¸éœ€è¦ç§’æ€æŠ¢è´­</p> <p>è¡¨å…³ç³»å¦‚ä¸‹</p> <ul><li>tb_voucherï¼šä¼˜æƒ åˆ¸çš„åŸºæœ¬ä¿¡æ¯ï¼Œä¼˜æƒ é‡‘é¢ã€ä½¿ç”¨è§„åˆ™ç­‰ï¼Œæ‰€æœ‰åˆ¸å‡æœ‰è¿™äº›å±æ€§</li> <li>tb_seckill_voucherï¼šä¼˜æƒ åˆ¸çš„åº“å­˜ã€å¼€å§‹æŠ¢è´­æ—¶é—´ï¼Œç»“æŸæŠ¢è´­æ—¶é—´ï¼Œç‰¹ä»·åˆ¸æ‰æœ‰çš„å±æ€§</li></ul> <p>æ·»åŠ ç§’æ€åˆ¸çš„æ¥å£ <code>http://localhost:8081/voucher/seckill</code></p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;shopId&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;100å…ƒä»£é‡‘åˆ¸&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;subTitle&quot;</span><span class="token operator">:</span> <span class="token string">&quot;å‘¨ä¸€åˆ°å‘¨äº”å‡å¯ä»¥ä½¿ç”¨&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;rules&quot;</span><span class="token operator">:</span> <span class="token string">&quot;å…¨åœºé€šç”¨\\næ— éœ€é¢„çº¦\\nå¯æ— é™å åŠ \\nä¸å…‘ç°ã€ä¸æ‰¾é›¶\\nä»…é™å ‚é£Ÿ&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;payValue&quot;</span><span class="token operator">:</span> <span class="token number">8000</span><span class="token punctuation">,</span>
    <span class="token property">&quot;actualValue&quot;</span><span class="token operator">:</span> <span class="token number">10000</span><span class="token punctuation">,</span>
    <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token property">&quot;stock&quot;</span><span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
    <span class="token property">&quot;beginTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2022-10-10T10:00:00&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;endTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2022-10-20T10:00:00&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_4-3-3-å®ç°ä¼˜æƒ åˆ¸ä¸‹å•-è¶…å–é—®é¢˜"><a href="#_4-3-3-å®ç°ä¼˜æƒ åˆ¸ä¸‹å•-è¶…å–é—®é¢˜" class="header-anchor">#</a> 4.3.3 å®ç°ä¼˜æƒ åˆ¸ä¸‹å•(è¶…å–é—®é¢˜)</h4> <p>ä¸‹å•æ—¶éœ€è¦åˆ¤æ–­ä¸¤ç‚¹ï¼š</p> <ul><li>ç§’æ€æ˜¯å¦å¼€å§‹æˆ–ç»“æŸï¼Œå¦‚æœå°šæœªå¼€å§‹æˆ–å·²ç»ç»“æŸåˆ™æ— æ³•ä¸‹å•</li> <li>åº“å­˜æ˜¯å¦å……è¶³ï¼Œä¸è¶³åˆ™æ— æ³•ä¸‹å•</li></ul> <div class="spinner" style="background:rgb(66, 185, 131);" data-v-1bbcb91a></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">ISeckillVoucherService</span> seckillVoucherService<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">RedisIdWorker</span> idWorker<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Override</span>
<span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">seckillVoucher</span><span class="token punctuation">(</span><span class="token class-name">Long</span> voucherId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. æŸ¥è¯¢ä¼˜æƒ åˆ¸ä¿¡æ¯</span>
    <span class="token class-name">SeckillVoucher</span> voucher <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">lambdaQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">SeckillVoucher</span><span class="token operator">::</span><span class="token function">getVoucherId</span><span class="token punctuation">,</span> voucherId<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>voucher<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;ä¼˜æƒ åˆ¸ä¸å­˜åœ¨&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 2. åˆ¤æ–­æ˜¯å¦å¼€å§‹</span>
    <span class="token class-name">LocalDateTime</span> now <span class="token operator">=</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getBeginTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAfter</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;æŠ¢è´­æ—¶é—´å°šæœªå¼€å§‹&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 3. åˆ¤æ–­æ˜¯å¦ç»“æŸ</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isBefore</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;æŠ¢è´­æ—¶é—´å·²ç»ç»“æŸ&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 4. åˆ¤æ–­åº“å­˜</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;ä¼˜æƒ åˆ¸å·²ç»è¢«æŠ¢å…‰äº†&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 5. æ‰£å‡åº“å­˜</span>
    voucher<span class="token punctuation">.</span><span class="token function">setStock</span><span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> success <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">lambdaUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">SeckillVoucher</span><span class="token operator">::</span><span class="token function">getStock</span><span class="token punctuation">,</span> voucher<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">SeckillVoucher</span><span class="token operator">::</span><span class="token function">getVoucherId</span><span class="token punctuation">,</span> voucherId<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;æœåŠ¡å™¨å¼‚å¸¸&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 6. ç”Ÿæˆè®¢å•</span>
    <span class="token class-name">VoucherOrder</span> voucherOrder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VoucherOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    voucherOrder<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>idWorker<span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token string">&quot;order&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    voucherOrder<span class="token punctuation">.</span><span class="token function">setVoucherId</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    voucherOrder<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span><span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    baseMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>voucherOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> voucherOrder<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_4-3-4-è§£å†³è¶…å–é—®é¢˜"><a href="#_4-3-4-è§£å†³è¶…å–é—®é¢˜" class="header-anchor">#</a> 4.3.4 è§£å†³è¶…å–é—®é¢˜</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">ISeckillVoucherService</span> seckillVoucherService<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">RedisIdWorker</span> idWorker<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Override</span>
<span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">seckillVoucher</span><span class="token punctuation">(</span><span class="token class-name">Long</span> voucherId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. æŸ¥è¯¢ä¼˜æƒ åˆ¸ä¿¡æ¯</span>
    <span class="token class-name">SeckillVoucher</span> voucher <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">lambdaQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">SeckillVoucher</span><span class="token operator">::</span><span class="token function">getVoucherId</span><span class="token punctuation">,</span> voucherId<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>voucher<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;ä¼˜æƒ åˆ¸ä¸å­˜åœ¨&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 2. åˆ¤æ–­æ˜¯å¦å¼€å§‹</span>
    <span class="token class-name">LocalDateTime</span> now <span class="token operator">=</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getBeginTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAfter</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;æŠ¢è´­æ—¶é—´å°šæœªå¼€å§‹&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 3. åˆ¤æ–­æ˜¯å¦ç»“æŸ</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isBefore</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;æŠ¢è´­æ—¶é—´å·²ç»ç»“æŸ&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 4. åˆ¤æ–­åº“å­˜</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;ä¼˜æƒ åˆ¸å·²ç»è¢«æŠ¢å…‰äº†&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 5. æ‰£å‡åº“å­˜</span>
    <span class="token keyword">boolean</span> success <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">lambdaUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">SeckillVoucher</span><span class="token operator">::</span><span class="token function">getStock</span><span class="token punctuation">,</span> voucher<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">SeckillVoucher</span><span class="token operator">::</span><span class="token function">getVoucherId</span><span class="token punctuation">,</span> voucherId<span class="token punctuation">)</span>
        <span class="token comment">//                .eq(SeckillVoucher::getStock, voucher.getStock())       // ä¹è§‚é”CAS</span>
        <span class="token punctuation">.</span><span class="token function">gt</span><span class="token punctuation">(</span><span class="token class-name">SeckillVoucher</span><span class="token operator">::</span><span class="token function">getStock</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>                      <span class="token comment">// ä¹è§‚é”CAS(æ”¹è¿›)</span>
        <span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;æœåŠ¡å™¨å¼‚å¸¸&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 6. ç”Ÿæˆè®¢å•</span>
    <span class="token class-name">VoucherOrder</span> voucherOrder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VoucherOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    voucherOrder<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>idWorker<span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token string">&quot;order&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    voucherOrder<span class="token punctuation">.</span><span class="token function">setVoucherId</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    voucherOrder<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span><span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    baseMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>voucherOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> voucherOrder<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>è¶…å–é—®é¢˜çš„è§£å†³æ–¹æ¡ˆ</p> <ol><li>æ‚²è§‚é”ï¼šæ·»åŠ åŒæ­¥é”ï¼Œè®©çº¿ç¨‹ä¸²è¡Œæ‰§è¡Œ
<ul><li>ä¼˜ç‚¹ï¼šç®€å•ç²—æš´</li> <li>ç¼ºç‚¹ï¼šæ€§èƒ½ä¸€èˆ¬</li></ul></li> <li>ä¹è§‚é”ï¼šä¸åŠ é”ï¼Œåœ¨æ›´æ–°æ—¶åˆ¤æ–­æ˜¯å¦æœ‰å…¶ä»–çº¿ç¨‹å·²ä¿®æ”¹
<ul><li>ä¼˜ç‚¹ï¼šæ€§èƒ½å¥½</li> <li>ç¼ºç‚¹ï¼šå­˜åœ¨æˆåŠŸç‡ä½çš„é—®é¢˜</li></ul></li></ol> <h4 id="_4-3-5-ä¸€äººä¸€å•"><a href="#_4-3-5-ä¸€äººä¸€å•" class="header-anchor">#</a> 4.3.5 ä¸€äººä¸€å•</h4> <p>ä¼˜æƒ åˆ¸ä¸€ä¸ªäººåªå…è®¸æŠ¢ä¸€å•</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">VoucherOrderServiceImpl</span> <span class="token keyword">extends</span> <span class="token class-name">ServiceImpl</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">VoucherOrderMapper</span><span class="token punctuation">,</span> <span class="token class-name">VoucherOrder</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">IVoucherOrderService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">ISeckillVoucherService</span> seckillVoucherService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisIdWorker</span> idWorker<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">seckillVoucher</span><span class="token punctuation">(</span><span class="token class-name">Long</span> voucherId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1. æŸ¥è¯¢ä¼˜æƒ åˆ¸ä¿¡æ¯</span>
        <span class="token class-name">SeckillVoucher</span> voucher <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">lambdaQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">SeckillVoucher</span><span class="token operator">::</span><span class="token function">getVoucherId</span><span class="token punctuation">,</span> voucherId<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>voucher<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;ä¼˜æƒ åˆ¸ä¸å­˜åœ¨&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 2. åˆ¤æ–­æ˜¯å¦å¼€å§‹</span>
        <span class="token class-name">LocalDateTime</span> now <span class="token operator">=</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getBeginTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAfter</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;æŠ¢è´­æ—¶é—´å°šæœªå¼€å§‹&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 3. åˆ¤æ–­æ˜¯å¦ç»“æŸ</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isBefore</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;æŠ¢è´­æ—¶é—´å·²ç»ç»“æŸ&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>userId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">IVoucherOrderService</span> proxyOrderService <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">IVoucherOrderService</span><span class="token punctuation">)</span><span class="token class-name">AopContext</span><span class="token punctuation">.</span><span class="token function">currentProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> proxyOrderService<span class="token punctuation">.</span><span class="token function">createOrder</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">,</span> voucher<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">createOrder</span><span class="token punctuation">(</span><span class="token class-name">Long</span> voucherId<span class="token punctuation">,</span> <span class="token class-name">SeckillVoucher</span> voucher<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">VoucherOrder</span> voucherOrder <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token comment">// 4. åˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯å¦å·²ç»æœ‰åˆ¸</span>
        <span class="token class-name">Integer</span> count <span class="token operator">=</span> baseMapper<span class="token punctuation">.</span><span class="token function">selectCount</span><span class="token punctuation">(</span>
                <span class="token class-name">Wrappers</span><span class="token punctuation">.</span><span class="token function">lambdaQuery</span><span class="token punctuation">(</span><span class="token class-name">VoucherOrder</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">VoucherOrder</span><span class="token operator">::</span><span class="token function">getVoucherId</span><span class="token punctuation">,</span> voucherId<span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">VoucherOrder</span><span class="token operator">::</span><span class="token function">getUserId</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;ä½ å·²æŠ¢è¿‡æ­¤åˆ¸&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 5. åˆ¤æ–­åº“å­˜</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;ä¼˜æƒ åˆ¸å·²ç»è¢«æŠ¢å…‰äº†&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 6. æ‰£å‡åº“å­˜</span>
        <span class="token keyword">boolean</span> success <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">lambdaUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">SeckillVoucher</span><span class="token operator">::</span><span class="token function">getStock</span><span class="token punctuation">,</span> voucher<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">SeckillVoucher</span><span class="token operator">::</span><span class="token function">getVoucherId</span><span class="token punctuation">,</span> voucherId<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">gt</span><span class="token punctuation">(</span><span class="token class-name">SeckillVoucher</span><span class="token operator">::</span><span class="token function">getStock</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;æœåŠ¡å™¨å¼‚å¸¸&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 7. ç”Ÿæˆè®¢å•</span>
        voucherOrder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VoucherOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        voucherOrder<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>idWorker<span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token string">&quot;order&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        voucherOrder<span class="token punctuation">.</span><span class="token function">setVoucherId</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        voucherOrder<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        baseMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>voucherOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> voucherOrder<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ä»¥ä¸‹è¿™æ®µåŠ é”çš„ä»£ç ä¸èƒ½æ”¾åœ¨createOrderå†…éƒ¨ï¼Œå› ä¸ºå¦‚æœåœ¨createOrderå†…éƒ¨åŠ é”ï¼Œåˆ™æ˜¯å…ˆé‡Šæ”¾é”å†æäº¤äº‹åŠ¡ï¼Œä¼šæœ‰å¹¶å‘å®‰å…¨é—®é¢˜</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">synchronized</span> <span class="token punctuation">(</span>userId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">createOrder</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">,</span> voucher<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_4-3-6-ä¸€äººä¸€å•-é›†ç¾¤é—®é¢˜"><a href="#_4-3-6-ä¸€äººä¸€å•-é›†ç¾¤é—®é¢˜" class="header-anchor">#</a> 4.3.6 ä¸€äººä¸€å•(é›†ç¾¤é—®é¢˜)</h4> <p>é€šè¿‡åŠ é”å¯ä»¥è§£å†³åœ¨æ·¡å­£æƒ…å†µä¸‹çš„ä¸€äººä¸€å•çš„å®‰å…¨é—®é¢˜ï¼Œä½†æ˜¯åœ¨é›†ç¾¤æ¨¡å¼ä¸‹å°±ä¸è¡Œäº†</p> <ol><li><p>å¯åŠ¨ä¸¤ä¸ªæœåŠ¡ï¼Œç«¯å£åˆ†åˆ«ä¸º8081å’Œ8082</p></li> <li><p>ä¿®æ”¹nginxçš„confçš„nginx.confæ–‡ä»¶ï¼Œé…ç½®åå‘ä»£ç†å’Œè´Ÿè½½å‡è¡¡</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">upstream</span> backend <span class="token punctuation">{</span>
	<span class="token keyword">server</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">8081</span> max_fails<span class="token operator">=</span><span class="token number">5</span> fail_timeout<span class="token operator">=</span><span class="token number">10</span>s weight<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">server</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">8082</span> max_fails<span class="token operator">=</span><span class="token number">5</span> fail_timeout<span class="token operator">=</span><span class="token number">10</span>s weight<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>ä¸¤ä¸ªè¯·æ±‚(ç›¸åŒçš„token)åŒæ—¶å»æŠ¢åˆ¸ï¼Œéƒ½ä¼šæ­£å¸¸è·å–é”ï¼Œå› ä¸ºè™½ç„¶å½“å‰çš„é”æ˜¯ç”¨æˆ·idï¼Œä½†å´åˆ†å‘åˆ°äº†ä¸åŒçš„æœåŠ¡ä¸Š</p></li></ol> <h4 id="_4-3-7-åˆ†å¸ƒå¼é”"><a href="#_4-3-7-åˆ†å¸ƒå¼é”" class="header-anchor">#</a> 4.3.7 åˆ†å¸ƒå¼é”</h4> <p>åˆ†å¸ƒå¼é”ï¼šæ»¡è¶³åˆ†å¸ƒå¼ç³»ç»Ÿæˆ–é›†ç¾¤æ¨¡å¼ä¸‹å¤šè¿›ç¨‹å¯è§å¹¶ä¸”äº’æ–¥çš„é”</p> <div class="spinner" style="background:rgb(66, 185, 131);" data-v-1bbcb91a></div><p>åˆ†å¸ƒå¼é”çš„å®ç°ï¼šåˆ†å¸ƒå¼é”çš„æ ¸å¿ƒæ˜¯å®ç°å¤šè¿›ç¨‹ä¹‹é—´äº’æ–¥ï¼Œè€Œæ»¡è¶³è¿™ä¸€ç‚¹çš„æ–¹å¼æœ‰å¾ˆå¤š</p> <table><thead><tr><th></th> <th>MySQL</th> <th>Redis</th> <th>Zookeeper</th></tr></thead> <tbody><tr><td>äº’æ–¥</td> <td>åˆ©ç”¨mysqlæœ¬èº«çš„äº’æ–¥é”æœºåˆ¶</td> <td>åˆ©ç”¨setnxè¿™æ ·çš„äº’æ–¥å‘½ä»¤</td> <td>åˆ©ç”¨èŠ‚ç‚¹çš„å”¯ä¸€æ€§å’Œæœ‰åºæ€§å®ç°äº’æ–¥</td></tr> <tr><td>é«˜å¯ç”¨</td> <td>å¥½</td> <td>å¥½</td> <td>å¥½</td></tr> <tr><td>é«˜æ€§èƒ½</td> <td>ä¸€èˆ¬</td> <td>å¥½</td> <td>ä¸€èˆ¬</td></tr> <tr><td>å®‰å…¨æ€§</td> <td>æ–­å¼€è¿æ¥ï¼Œè‡ªåŠ¨é‡Šæ”¾é”</td> <td>åˆ©ç”¨é”è¶…æ—¶æ—¶é—´ï¼Œåˆ°æœŸé‡Šæ”¾</td> <td>ä¸´æ—¶èŠ‚ç‚¹ï¼Œæ–­å¼€è¿æ¥è‡ªåŠ¨é‡Šæ”¾</td></tr></tbody></table> <h4 id="_4-3-8-åŸºäºredisçš„åˆ†å¸ƒå¼é”"><a href="#_4-3-8-åŸºäºredisçš„åˆ†å¸ƒå¼é”" class="header-anchor">#</a> 4.3.8 åŸºäºRedisçš„åˆ†å¸ƒå¼é”</h4> <p>å®ç°åˆ†å¸ƒå¼é”æ—¶éœ€è¦å®ç°çš„ä¸¤ä¸ªåŸºæœ¬æ–¹æ³•</p> <ul><li><p>è·å–é”ï¼š</p> <p>äº’æ–¥ï¼šåˆ©ç”¨<code>setnx</code>å‘½ä»¤ï¼Œç¡®ä¿åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è·å–é”</p> <div class="language-redis extra-class"><pre class="language-text"><code>SETNX test:lock:1 1

# æ·»åŠ è¿‡æœŸæ—¶é—´
EXPIRE test:lock:1 5

# ä¿è¯åŸå­æ“ä½œ NXäº’æ–¥ã€EXè¿‡æœŸæ—¶é—´
SET test:lock:1 1 NX EX 10
</code></pre></div></li> <li><p>é‡Šæ”¾é”</p> <p>æ‰‹åŠ¨é‡Šæ”¾</p> <div class="language-redis extra-class"><pre class="language-text"><code>DEL test:lock:1
</code></pre></div><p>è¶…æ—¶é‡Šæ”¾ï¼šåœ¨è·å–é”æ—¶æ·»åŠ ä¸€ä¸ªè¶…æ—¶æ—¶é—´</p></li></ul> <p>å®ç°ï¼š</p> <ol><li><p>å®šä¹‰æ¥å£</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ILock</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * å°è¯•è·å–é”
     * @param timeout è¶…æ—¶æ—¶é—´
     * @return æ˜¯å¦è·å–é”æˆåŠŸ
     */</span>
    <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * é‡Šæ”¾é”
     */</span>
    <span class="token keyword">void</span> <span class="token function">unLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>å®ç°</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SimpleRedisLock</span> <span class="token keyword">implements</span> <span class="token class-name">ILock</span><span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> KEY_PREFIX <span class="token operator">=</span> <span class="token string">&quot;lock:&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">SimpleRedisLock</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>redisTemplate <span class="token operator">=</span> redisTemplate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è·å–çº¿ç¨‹id</span>
        <span class="token keyword">long</span> threadId <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// è·å–é”</span>
        <span class="token class-name">Boolean</span> success <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span>KEY_PREFIX <span class="token operator">+</span> name<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>threadId<span class="token punctuation">)</span><span class="token punctuation">,</span> timeout<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">BooleanUtil</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span>success<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// é‡Šæ”¾é”</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>KEY_PREFIX <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>åº”ç”¨</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">VoucherOrderServiceImpl</span> <span class="token keyword">extends</span> <span class="token class-name">ServiceImpl</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">VoucherOrderMapper</span><span class="token punctuation">,</span> <span class="token class-name">VoucherOrder</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">IVoucherOrderService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">ISeckillVoucherService</span> seckillVoucherService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisIdWorker</span> idWorker<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">seckillVoucher</span><span class="token punctuation">(</span><span class="token class-name">Long</span> voucherId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1. æŸ¥è¯¢ä¼˜æƒ åˆ¸ä¿¡æ¯</span>
        <span class="token class-name">SeckillVoucher</span> voucher <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">lambdaQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">SeckillVoucher</span><span class="token operator">::</span><span class="token function">getVoucherId</span><span class="token punctuation">,</span> voucherId<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>voucher<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;ä¼˜æƒ åˆ¸ä¸å­˜åœ¨&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 2. åˆ¤æ–­æ˜¯å¦å¼€å§‹</span>
        <span class="token class-name">LocalDateTime</span> now <span class="token operator">=</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getBeginTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAfter</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;æŠ¢è´­æ—¶é—´å°šæœªå¼€å§‹&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 3. åˆ¤æ–­æ˜¯å¦ç»“æŸ</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isBefore</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;æŠ¢è´­æ—¶é—´å·²ç»ç»“æŸ&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Redisé”è§£å†³ä¸€äººä¸€å•é—®é¢˜</span>
        <span class="token class-name">ILock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleRedisLock</span><span class="token punctuation">(</span><span class="token string">&quot;order:&quot;</span> <span class="token operator">+</span> userId<span class="token punctuation">,</span> redisTemplate<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> success <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;ä½ æ­£åœ¨æŠ¢è´­ä¸­,è¯·ä¸è¦é‡å¤ä¸‹å•&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">IVoucherOrderService</span> proxyOrderService <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">IVoucherOrderService</span><span class="token punctuation">)</span><span class="token class-name">AopContext</span><span class="token punctuation">.</span><span class="token function">currentProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> proxyOrderService<span class="token punctuation">.</span><span class="token function">createOrder</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">,</span> voucher<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            lock<span class="token punctuation">.</span><span class="token function">unLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">createOrder</span><span class="token punctuation">(</span><span class="token class-name">Long</span> voucherId<span class="token punctuation">,</span> <span class="token class-name">SeckillVoucher</span> voucher<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">VoucherOrder</span> voucherOrder <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token comment">// 4. åˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯å¦å·²ç»æœ‰åˆ¸</span>
        <span class="token class-name">Integer</span> count <span class="token operator">=</span> baseMapper<span class="token punctuation">.</span><span class="token function">selectCount</span><span class="token punctuation">(</span>
                <span class="token class-name">Wrappers</span><span class="token punctuation">.</span><span class="token function">lambdaQuery</span><span class="token punctuation">(</span><span class="token class-name">VoucherOrder</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">VoucherOrder</span><span class="token operator">::</span><span class="token function">getVoucherId</span><span class="token punctuation">,</span> voucherId<span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">VoucherOrder</span><span class="token operator">::</span><span class="token function">getUserId</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;ä½ å·²æŠ¢è¿‡æ­¤åˆ¸&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 5. åˆ¤æ–­åº“å­˜</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;ä¼˜æƒ åˆ¸å·²ç»è¢«æŠ¢å…‰äº†&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 6. æ‰£å‡åº“å­˜</span>
        <span class="token keyword">boolean</span> success <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">lambdaUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">SeckillVoucher</span><span class="token operator">::</span><span class="token function">getStock</span><span class="token punctuation">,</span> voucher<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">SeckillVoucher</span><span class="token operator">::</span><span class="token function">getVoucherId</span><span class="token punctuation">,</span> voucherId<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">gt</span><span class="token punctuation">(</span><span class="token class-name">SeckillVoucher</span><span class="token operator">::</span><span class="token function">getStock</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;æœåŠ¡å™¨å¼‚å¸¸&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 7. ç”Ÿæˆè®¢å•</span>
        voucherOrder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VoucherOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        voucherOrder<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>idWorker<span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token string">&quot;order&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        voucherOrder<span class="token punctuation">.</span><span class="token function">setVoucherId</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        voucherOrder<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        baseMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>voucherOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> voucherOrder<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ol> <h4 id="_4-3-9-redisé”è¯¯åˆ é—®é¢˜"><a href="#_4-3-9-redisé”è¯¯åˆ é—®é¢˜" class="header-anchor">#</a> 4.3.9 Redisé”è¯¯åˆ é—®é¢˜</h4> <p>å‡è®¾ç°åœ¨æŸä¸€ä¸ªçº¿ç¨‹ï¼ˆçº¿ç¨‹1ï¼‰è·å–åˆ°äº†é”ï¼Œä½†æ˜¯ç”±äºå®ƒçš„ä¸šåŠ¡é€»è¾‘è¿‡äºå¤æ‚ï¼Œå°±æœ‰å¯èƒ½åœ¨ä¸šåŠ¡é€»è¾‘è¿˜æœªå®Œæˆæ—¶ï¼Œé”å°±è¿‡æœŸäº†(æå‰é‡Šæ”¾äº†)ï¼Œè¿™æ—¶å€™å°±å…¶ä»–çº¿ç¨‹ï¼ˆçº¿ç¨‹2ï¼‰å°±å¯ä»¥å»æŠ¢å è¿™ä¸ªé”ï¼Œå½“çº¿ç¨‹1ä¸šåŠ¡é€»è¾‘åæ‰§è¡Œé‡Šæ”¾é”çš„é€»è¾‘ï¼Œä¼šå¯¼è‡´çº¿ç¨‹2çš„é”è¢«é‡Šæ”¾ï¼Œé€ æˆå®‰å…¨é—®é¢˜</p> <p>è§£å†³æ–¹æ¡ˆï¼šåœ¨è·å–é”æ—¶ï¼Œå­˜å…¥å½“å‰é”çš„ä¸€ä¸ªæ ‡è¯†(UUIDå®ç°)ï¼Œå½“è§¦å‘é‡Šæ”¾é”çš„æ“ä½œæ—¶ï¼Œå…ˆåˆ¤æ–­å½“å‰é”æ˜¯å¦æ˜¯è‡ªå·±çš„é”ï¼Œå¦‚æœæ˜¯åˆ™é‡Šæ”¾ï¼Œå¦åˆ™ä¸åšä»»ä½•å¤„ç†</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SimpleRedisLock</span> <span class="token keyword">implements</span> <span class="token class-name">ILock</span><span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> KEY_PREFIX <span class="token operator">=</span> <span class="token string">&quot;lock:&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> ID_PREFIX <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;-&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">SimpleRedisLock</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>redisTemplate <span class="token operator">=</span> redisTemplate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è·å–çº¿ç¨‹æ ‡è¯†</span>
        <span class="token class-name">String</span> threadId <span class="token operator">=</span> ID_PREFIX <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// è·å–é”</span>
        <span class="token class-name">Boolean</span> success <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span>KEY_PREFIX <span class="token operator">+</span> name<span class="token punctuation">,</span> threadId<span class="token punctuation">,</span> timeout<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">BooleanUtil</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span>success<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è·å–çº¿ç¨‹æ ‡è¯†</span>
        <span class="token class-name">String</span> threadId <span class="token operator">=</span> ID_PREFIX <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> lock <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>KEY_PREFIX <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>threadId<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>lock<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// é‡Šæ”¾é”</span>
            redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>KEY_PREFIX <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_4-3-10-redisé‡Šæ”¾é”åŸå­æ€§é—®é¢˜"><a href="#_4-3-10-redisé‡Šæ”¾é”åŸå­æ€§é—®é¢˜" class="header-anchor">#</a> 4.3.10 Redisé‡Šæ”¾é”åŸå­æ€§é—®é¢˜</h4> <p>åœ¨ä¸Šè¿°ä¾‹å­ä¸­ï¼Œä¸€ä¸ªçº¿ç¨‹(çº¿ç¨‹A)æ˜¯å…ˆåˆ¤æ–­é”æ˜¯å¦æ˜¯è‡ªå·±çš„ï¼Œç„¶åå†å»é‡Šæ”¾é”ï¼Œè¿™æ—¶å€™ä¼šäº§ç”Ÿä¸€ä¸ªæƒ…å†µï¼Œå¦‚æœå½“åˆ¤æ–­æ˜¯å¦æ˜¯è‡ªå·±ä¸ºtrueåï¼Œé”ç«‹åˆ»è¿‡æœŸäº†ï¼Œè¿™æ—¶å€™åˆ«çš„çº¿ç¨‹(çº¿ç¨‹B)å°±å¯ä»¥è·å–åˆ°é”ï¼Œçº¿ç¨‹Aå†å»æ‰§è¡Œé‡Šæ”¾é”çš„æ“ä½œï¼Œæ­¤æ—¶çº¿ç¨‹Aé‡Šæ”¾çš„é”å¹¶ä¸æ˜¯è‡ªå·±çš„é”ï¼Œé€ æˆäº†é”çš„è¯¯åˆ </p> <p>è§£å†³æ–¹æ¡ˆï¼šLuaè„šæœ¬ï¼ŒRedisæä¾›äº†å¯¹Luaè„šæœ¬çš„æ”¯æŒï¼Œåœ¨ä¸€ä¸ªè„šæœ¬ä¸­ç¼–å†™å¤šæ¡RedisæŒ‡ä»¤ï¼Œä»¥ç¡®ä¿å¤šæ¡å‘½ä»¤æ‰§è¡Œæ—¶çš„åŸå­æ€§</p> <div class="language-lua extra-class"><pre class="language-lua"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">,</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">then</span> 
	<span class="token keyword">return</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'del'</span><span class="token punctuation">,</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>
<span class="token keyword">return</span> <span class="token number">0</span>
</code></pre></div><p>æ”¹è¿›åˆ†å¸ƒå¼é”</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SimpleRedisLock</span> <span class="token keyword">implements</span> <span class="token class-name">ILock</span><span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> KEY_PREFIX <span class="token operator">=</span> <span class="token string">&quot;lock:&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> ID_PREFIX <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;-&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">DefaultRedisScript</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> UNLOCK_SCRIPT<span class="token punctuation">;</span>

    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        UNLOCK_SCRIPT <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultRedisScript</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        UNLOCK_SCRIPT<span class="token punctuation">.</span><span class="token function">setLocation</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClassPathResource</span><span class="token punctuation">(</span><span class="token string">&quot;lua/unlock.lua&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        UNLOCK_SCRIPT<span class="token punctuation">.</span><span class="token function">setResultType</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">SimpleRedisLock</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>redisTemplate <span class="token operator">=</span> redisTemplate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è·å–çº¿ç¨‹æ ‡è¯†</span>
        <span class="token class-name">String</span> threadId <span class="token operator">=</span> ID_PREFIX <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// è·å–é”</span>
        <span class="token class-name">Boolean</span> success <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span>KEY_PREFIX <span class="token operator">+</span> name<span class="token punctuation">,</span> threadId<span class="token punctuation">,</span> timeout<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">BooleanUtil</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span>success<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>
                UNLOCK_SCRIPT<span class="token punctuation">,</span>
                <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span>KEY_PREFIX <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">,</span>
                ID_PREFIX <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_4-3-11-åˆ†å¸ƒå¼é”ä¼˜åŒ–é—®é¢˜"><a href="#_4-3-11-åˆ†å¸ƒå¼é”ä¼˜åŒ–é—®é¢˜" class="header-anchor">#</a> 4.3.11 åˆ†å¸ƒå¼é”ä¼˜åŒ–é—®é¢˜</h4> <p>åŸºäº<code>setnx</code>å®ç°çš„åˆ†å¸ƒå¼é”å­˜åœ¨ä¸‹é¢çš„é—®é¢˜ï¼š</p> <ol><li><p>ä¸å¯é‡å…¥</p> <p>ç”¨ä¸€ä¸ªçº¿ç¨‹æ— æ³•å¤šæ¬¡è·å–åŒä¸€æŠŠé”</p></li> <li><p>ä¸å¯é‡è¯•</p> <p>è·å–é”åªå°è¯•ä¸€æ¬¡å°±è¿”å›fasleï¼Œæ²¡æœ‰é‡è¯•æœºåˆ¶</p></li> <li><p>è¶…æ—¶é‡Šæ”¾</p> <p>é”è¶…æ—¶é‡Šæ”¾è™½ç„¶å¯ä»¥é¿å…æ­»é”ï¼Œä½†å¦‚æœæ˜¯ä¸šåŠ¡æ‰§è¡Œè€—æ—¶è¾ƒé•¿ï¼Œä¹Ÿä¼šå¯¼è‡´é”é‡Šæ”¾ï¼Œå­˜åœ¨å®‰å…¨éšæ‚£</p></li> <li><p>ä¸»ä»ä¸€è‡´æ€§</p> <p>å¦‚æœRedisæä¾›äº†ä¸»ä»é›†ç¾¤ï¼Œä¸»ä»åŒæ­¥å­˜åœ¨å»¶è¿Ÿï¼Œå½“ä¸»å®•æœºæ—¶ï¼Œå¦‚æœä»æ²¡æœ‰åŒæ­¥å·²ç»å®•æœºçš„é”çš„æ•°æ®ï¼Œåˆ™ä¼šå‡ºç°é‡å¤è·å–é”çš„å®‰å…¨é—®é¢˜</p></li></ol> <h2 id="_5-redisson"><a href="#_5-redisson" class="header-anchor">#</a> 5. Redisson</h2> <h3 id="_5-1-redissonä»‹ç»"><a href="#_5-1-redissonä»‹ç»" class="header-anchor">#</a> 5.1 Redissonä»‹ç»</h3> <p>Redissonæ˜¯ä¸€ä¸ªåœ¨Redisçš„åŸºç¡€ä¸Šå®ç°çš„Javaé©»å†…å­˜æ•°æ®ç½‘æ ¼(In-Memory Data Grid)ã€‚å®ƒä¸ä»…æä¾›äº†ä¸€ç³»åˆ—çš„åˆ†å¸ƒå¼çš„Javaå¸¸ç”¨å¯¹è±¡ï¼Œè¿˜æä¾›äº†è®¸å¤šåˆ†å¸ƒå¼æœåŠ¡ï¼Œå…¶ä¸­å°±åŒ…å«äº†å„ç§åˆ†å¸ƒå¼é”çš„å®ç°</p> <ul><li>å¯é‡å…¥é”(ReentrantLock)</li> <li>å…¬å¹³é”(FairLock)</li> <li>è”é”(MultiLock)</li> <li>çº¢é”(RedLock)</li> <li>è¯»å†™é”(ReadWriteLock)</li> <li>ä¿¡å·é‡(Semaphore)</li> <li>å¯è¿‡æœŸæ€§ä¿¡å·é‡(PermitExpirableSemaphore)</li> <li>é—­é”(CountDownLatch)</li></ul> <h3 id="_5-2-å¿«é€Ÿå…¥é—¨"><a href="#_5-2-å¿«é€Ÿå…¥é—¨" class="header-anchor">#</a> 5.2 å¿«é€Ÿå…¥é—¨</h3> <ol><li><p>å¼•å…¥ä¾èµ–</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.redisson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>redisson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.13.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li> <li><p>é…ç½®Redissonå®¢æˆ·ç«¯</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisConfig</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RedissonClient</span> <span class="token function">redissonClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Config</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        config<span class="token punctuation">.</span><span class="token function">useSingleServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAddress</span><span class="token punctuation">(</span><span class="token string">&quot;redis://192.168.3.216:6379&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">&quot;123456&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token class-name">Redisson</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>ä½¿ç”¨</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">VoucherOrderServiceImpl</span> <span class="token keyword">extends</span> <span class="token class-name">ServiceImpl</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">VoucherOrderMapper</span><span class="token punctuation">,</span> <span class="token class-name">VoucherOrder</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">IVoucherOrderService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">ISeckillVoucherService</span> seckillVoucherService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisIdWorker</span> idWorker<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RedissonClient</span> redissonClient<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">seckillVoucher</span><span class="token punctuation">(</span><span class="token class-name">Long</span> voucherId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1. æŸ¥è¯¢ä¼˜æƒ åˆ¸ä¿¡æ¯</span>
        <span class="token class-name">SeckillVoucher</span> voucher <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">lambdaQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">SeckillVoucher</span><span class="token operator">::</span><span class="token function">getVoucherId</span><span class="token punctuation">,</span> voucherId<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>voucher<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;ä¼˜æƒ åˆ¸ä¸å­˜åœ¨&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 2. åˆ¤æ–­æ˜¯å¦å¼€å§‹</span>
        <span class="token class-name">LocalDateTime</span> now <span class="token operator">=</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getBeginTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAfter</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;æŠ¢è´­æ—¶é—´å°šæœªå¼€å§‹&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 3. åˆ¤æ–­æ˜¯å¦ç»“æŸ</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isBefore</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;æŠ¢è´­æ—¶é—´å·²ç»ç»“æŸ&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Redisson è§£å†³ä¸€äººä¸€å•é—®é¢˜</span>
        <span class="token class-name">RLock</span> lock <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">&quot;order:&quot;</span> <span class="token operator">+</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 5L é”è·å–å¤±è´¥æœ€å¤§é‡è¯•ç­‰å¾…æ—¶é—´</span>
            <span class="token comment">// 10L é”è¶…æ—¶è‡ªåŠ¨é‡Šæ”¾æ—¶é—´</span>
            <span class="token comment">// æ— å‚ é»˜è®¤-1 30</span>
            <span class="token keyword">boolean</span> success <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token number">5L</span><span class="token punctuation">,</span> <span class="token number">10L</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;ä½ æ­£åœ¨æŠ¢è´­ä¸­,è¯·ä¸è¦é‡å¤ä¸‹å•&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token class-name">IVoucherOrderService</span> proxyOrderService <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">IVoucherOrderService</span><span class="token punctuation">)</span><span class="token class-name">AopContext</span><span class="token punctuation">.</span><span class="token function">currentProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> proxyOrderService<span class="token punctuation">.</span><span class="token function">createOrder</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">,</span> voucher<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">createOrder</span><span class="token punctuation">(</span><span class="token class-name">Long</span> voucherId<span class="token punctuation">,</span> <span class="token class-name">SeckillVoucher</span> voucher<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">VoucherOrder</span> voucherOrder <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token comment">// 4. åˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯å¦å·²ç»æœ‰åˆ¸</span>
        <span class="token class-name">Integer</span> count <span class="token operator">=</span> baseMapper<span class="token punctuation">.</span><span class="token function">selectCount</span><span class="token punctuation">(</span>
                <span class="token class-name">Wrappers</span><span class="token punctuation">.</span><span class="token function">lambdaQuery</span><span class="token punctuation">(</span><span class="token class-name">VoucherOrder</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">VoucherOrder</span><span class="token operator">::</span><span class="token function">getVoucherId</span><span class="token punctuation">,</span> voucherId<span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">VoucherOrder</span><span class="token operator">::</span><span class="token function">getUserId</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;ä½ å·²æŠ¢è¿‡æ­¤åˆ¸&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 5. åˆ¤æ–­åº“å­˜</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;ä¼˜æƒ åˆ¸å·²ç»è¢«æŠ¢å…‰äº†&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 6. æ‰£å‡åº“å­˜</span>
        <span class="token keyword">boolean</span> success <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">lambdaUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">SeckillVoucher</span><span class="token operator">::</span><span class="token function">getStock</span><span class="token punctuation">,</span> voucher<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">SeckillVoucher</span><span class="token operator">::</span><span class="token function">getVoucherId</span><span class="token punctuation">,</span> voucherId<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">gt</span><span class="token punctuation">(</span><span class="token class-name">SeckillVoucher</span><span class="token operator">::</span><span class="token function">getStock</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;æœåŠ¡å™¨å¼‚å¸¸&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 7. ç”Ÿæˆè®¢å•</span>
        voucherOrder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VoucherOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        voucherOrder<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>idWorker<span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token string">&quot;order&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        voucherOrder<span class="token punctuation">.</span><span class="token function">setVoucherId</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        voucherOrder<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        baseMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>voucherOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> voucherOrder<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ol> <h3 id="_5-3-å¯é‡å…¥é”åŸç†"><a href="#_5-3-å¯é‡å…¥é”åŸç†" class="header-anchor">#</a> 5.3 å¯é‡å…¥é”åŸç†</h3> <p>Redissonåœ¨ç¬¬ä¸€æ¬¡è·å–é”æ—¶ä¼šè¿›è¡Œæ·»åŠ æ“ä½œï¼Œå¦‚æœæ˜¯ç¬¬äºŒæ¬¡è·å–é”ï¼Œåˆ™æ˜¯åœ¨åŸæ¥çš„åŸºç¡€ä¸Šè‡ªå¢1ï¼ŒåŒæ—¶é‡ç½®é”çš„æœ‰æ•ˆæœŸï¼Œé‡Šæ”¾é”æ—¶å¹¶éçœŸæ­£é‡Šæ”¾é”ï¼Œè€Œæ˜¯å°†å½“å‰å€¼å‡ä¸€ä¹‹ååˆ¤æ–­æ˜¯å¦ç­‰äº0ï¼Œç­‰äº0åˆ™é‡Šæ”¾é”</p> <div class="spinner" style="background:rgb(66, 185, 131);" data-v-1bbcb91a></div><ol><li><p>è·å–é”Luaè„šæœ¬</p> <div class="language-lua extra-class"><pre class="language-lua"><code><span class="token comment">-- é”çš„key</span>
<span class="token keyword">local</span> key <span class="token operator">=</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token comment">-- çº¿ç¨‹çš„å”¯ä¸€æ ‡è¯†</span>
<span class="token keyword">local</span> threadId <span class="token operator">=</span> ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token comment">-- é”çš„è‡ªåŠ¨é‡Šæ”¾æ—¶é—´</span>
<span class="token keyword">local</span> releaseTime <span class="token operator">=</span> ARGV<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
<span class="token comment">-- åˆ¤æ–­é”æ˜¯å¦å­˜åœ¨</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'exists'</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">then</span>
    <span class="token comment">-- ä¸å­˜åœ¨,è·å–é”</span>
    redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'hset'</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> threadId<span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">)</span>
    <span class="token comment">-- è®¾ç½®æœ‰æ•ˆæœŸ</span>
    redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'expire'</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> releaseTime<span class="token punctuation">)</span>
    <span class="token comment">-- è¿”å›ç»“æœ</span>
    <span class="token keyword">return</span> <span class="token number">1</span>
<span class="token keyword">end</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'hexists'</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> threadId<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">then</span>
    <span class="token comment">-- ä¸å­˜åœ¨,è·å–é”,é‡å…¥æ¬¡æ•°+1</span>
    redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'hincrby'</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> threadId<span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">)</span>
    <span class="token comment">-- è®¾ç½®æœ‰æ•ˆæœŸ</span>
    redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'expire'</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> releaseTime<span class="token punctuation">)</span>
    <span class="token comment">-- è¿”å›ç»“æœ</span>
    <span class="token keyword">return</span> <span class="token number">1</span>
<span class="token keyword">end</span>

<span class="token comment">-- ä»£ç èµ°åˆ°è¿™é‡Œ,è¯´æ˜è·å–é”çš„ä¸æ˜¯è‡ªå·±,è·å–é”å¤±è´¥</span>
<span class="token keyword">return</span> <span class="token number">0</span>
</code></pre></div></li> <li><p>é‡Šæ”¾é”è„šæœ¬</p> <div class="language-lua extra-class"><pre class="language-lua"><code><span class="token comment">-- é”çš„key</span>
<span class="token keyword">local</span> key <span class="token operator">=</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token comment">-- çº¿ç¨‹çš„å”¯ä¸€æ ‡è¯†</span>
<span class="token keyword">local</span> threadId <span class="token operator">=</span> ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token comment">-- é”çš„è‡ªåŠ¨é‡Šæ”¾æ—¶é—´</span>
<span class="token keyword">local</span> releaseTime <span class="token operator">=</span> ARGV<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
<span class="token comment">-- åˆ¤æ–­å½“å‰é”æ˜¯å¦è¿˜è¢«è‡ªå·±æŒæœ‰</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'hexists'</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> threadId<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">then</span>
    <span class="token comment">-- å½“å‰é”ä¸æ˜¯è‡ªå·±çš„é”,ç›´æ¥è¿”å›</span>
    <span class="token keyword">return</span> <span class="token keyword">nil</span>
<span class="token keyword">end</span>

<span class="token comment">-- æ˜¯è‡ªå·±çš„é”,åˆ™é‡å…¥æ¬¡æ•°-1</span>
<span class="token keyword">local</span> count <span class="token operator">=</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'hincrby'</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> threadId<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">then</span>
    <span class="token comment">-- å¤§äº0è¯´æ˜ä¸èƒ½é‡Šæ”¾é”,é‡ç½®æœ‰æ•ˆæœŸè¿”å›</span>
    redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'expire'</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> releaseTime<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token keyword">nil</span>
<span class="token keyword">else</span>
    <span class="token comment">-- ç­‰äº0è¯´æ˜å¯ä»¥é‡Šæ”¾é”,ç›´æ¥åˆ é™¤</span>
    redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'del'</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token keyword">nil</span>
<span class="token keyword">end</span>
</code></pre></div></li></ol> <p>ğŸŒŸåˆ†å¸ƒå¼é”åŸç†</p> <ol><li>å¯é‡å…¥ï¼šåˆ©ç”¨hashç»“æ„è®°å½•çº¿ç¨‹idå’Œé‡å…¥æ¬¡æ•°</li> <li>å¯é‡è¯•ï¼šåˆ©ç”¨ä¿¡å·é‡å’Œå‘å¸ƒ/è®¢é˜…åŠŸèƒ½å®ç°ç­‰å¾…ã€å”¤é†’ã€è·å–é”å¤±è´¥çš„é‡è¯•æœºåˆ¶</li> <li>è¶…æ—¶ç»­çº¦ï¼šåˆ©ç”¨watchDogï¼Œæ¯éš”ä¸€æ®µæ—¶é—´(releaseTime/3)ï¼Œé‡ç½®è¶…æ—¶æ—¶é—´</li></ol> <h3 id="_5-4-è”é”åŸç†"><a href="#_5-4-è”é”åŸç†" class="header-anchor">#</a> 5.4 è”é”åŸç†</h3> <p>å¦‚æœåœ¨Redisé›†ç¾¤çš„æ¨¡å¼ä¸‹ï¼Œå­˜åœ¨ä¸»ä»åŒæ­¥ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹è·å–é”åï¼Œä¸»Rediså®•æœºï¼Œè€Œé”è¿˜æœªåŒæ­¥è‡³ä»æœºï¼Œåˆ™ä¼šå¯¼è‡´é”ä¸¢å¤±ï¼Œå¼•èµ·å¹¶å‘é—®é¢˜</p> <div class="spinner" style="background:rgb(66, 185, 131);" data-v-1bbcb91a></div><p>Redissonçš„è¿é”å°†ä¸»ä»å…³ç³»å»é™¤ï¼Œåªæœ‰å½“åœ¨æ‰€æœ‰çš„èŠ‚ç‚¹ä¸Šè·å–åˆ°é”åæ‰ç®—æˆåŠŸï¼Œå¦‚æœæœ‰ä¸€å°å¤±è´¥ï¼Œåˆ™è·å–é”å¤±è´¥</p> <div class="spinner" style="background:rgb(66, 185, 131);" data-v-1bbcb91a></div><p>å¿«é€Ÿå…¥é—¨</p> <ol><li><p>æ³¨å†Œå¤šä¸ªRedissonClient</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisConfig</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RedissonClient</span> <span class="token function">redissonClient1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Config</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        config<span class="token punctuation">.</span><span class="token function">useSingleServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAddress</span><span class="token punctuation">(</span><span class="token string">&quot;redis://192.168.3.216:6379&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">&quot;123456&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token class-name">Redisson</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RedissonClient</span> <span class="token function">redissonClient2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Config</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        config<span class="token punctuation">.</span><span class="token function">useSingleServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAddress</span><span class="token punctuation">(</span><span class="token string">&quot;redis://192.168.3.216:6380&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">&quot;123456&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token class-name">Redisson</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RedissonClient</span> <span class="token function">redissonClient3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Config</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        config<span class="token punctuation">.</span><span class="token function">useSingleServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAddress</span><span class="token punctuation">(</span><span class="token string">&quot;redis://192.168.3.216:6381&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">&quot;123456&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token class-name">Redisson</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>ä½¿ç”¨</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">RLock</span> lock1 <span class="token operator">=</span> redissonClient1<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">&quot;order:&quot;</span> <span class="token operator">+</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">RLock</span> lock2 <span class="token operator">=</span> redissonClient2<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">&quot;order:&quot;</span> <span class="token operator">+</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">RLock</span> lock3 <span class="token operator">=</span> redissonClient3<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">&quot;order:&quot;</span> <span class="token operator">+</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">RLock</span> lock <span class="token operator">=</span> redissonClient1<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span>lock1<span class="token punctuation">,</span> lock2<span class="token punctuation">,</span> lock3<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li></ol> <h2 id="_6-redisç§’æ€"><a href="#_6-redisç§’æ€" class="header-anchor">#</a> 6. Redisç§’æ€</h2> <ol><li>æ–°å¢ç§’æ€ä¼˜æƒ åˆ¸çš„åŒæ—¶ï¼Œå°†ä¼˜æƒ åˆ¸ä¿¡æ¯ä¿å­˜åˆ°Redisä¸­</li> <li>åŸºäºLuaè„šæœ¬ï¼Œåˆ¤æ–­ç§’æ€åº“å­˜ã€ä¸€äººä¸€å•ï¼Œå†³å®šç”¨æˆ·æ˜¯å¦æŠ¢è´­æˆåŠŸ</li> <li>å¦‚æœæŠ¢è´­æˆåŠŸï¼Œå°†ä¼˜æƒ åˆ¸idå’Œç”¨æˆ·idå°è£…åå­˜å…¥é˜»å¡é˜Ÿåˆ—</li> <li>å¼€å¯çº¿ç¨‹ä»»åŠ¡ï¼Œä¸æ–­ä»é˜»å¡é˜Ÿåˆ—ä¸­è·å–ä¿¡æ¯ï¼Œå®ç°å¼‚æ­¥ä¸‹å•åŠŸèƒ½</li></ol> <h3 id="_6-1-ç§’æ€èµ„æ ¼åˆ¤æ–­"><a href="#_6-1-ç§’æ€èµ„æ ¼åˆ¤æ–­" class="header-anchor">#</a> 6.1 ç§’æ€èµ„æ ¼åˆ¤æ–­</h3> <div class="spinner" style="background:rgb(66, 185, 131);" data-v-1bbcb91a></div><div class="language-lua extra-class"><pre class="language-lua"><code><span class="token comment">-- ä¼˜æƒ åˆ¸id</span>
<span class="token keyword">local</span> voucherId <span class="token operator">=</span> ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token comment">-- ç”¨æˆ·id</span>
<span class="token keyword">local</span> userId <span class="token operator">=</span> ARGV<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>

<span class="token comment">-- åº“å­˜key</span>
<span class="token keyword">local</span> stockKey <span class="token operator">=</span> <span class="token string">'seckill:stock:'</span><span class="token punctuation">...</span>voucherId
<span class="token comment">-- è®¢å•key</span>
<span class="token keyword">local</span> orderKey <span class="token operator">=</span> <span class="token string">'seckill:order:'</span><span class="token punctuation">...</span>voucherId

<span class="token comment">-- åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tonumber</span><span class="token punctuation">(</span>redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'GET'</span><span class="token punctuation">,</span> stockKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">then</span>
    <span class="token keyword">return</span> <span class="token number">3</span>
<span class="token keyword">end</span>
<span class="token comment">-- åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å·²ç»ä¸‹å•</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'SISMEMBER'</span><span class="token punctuation">,</span> orderKey<span class="token punctuation">,</span> userId<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">then</span>
    <span class="token keyword">return</span> <span class="token number">2</span>
<span class="token keyword">end</span>

<span class="token comment">-- ç”¨æˆ·æœªä¸‹å•</span>
<span class="token comment">-- æ‰£åº“å­˜</span>
redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'INCRBY'</span><span class="token punctuation">,</span> stockKey<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment">-- ä¸‹å•</span>
<span class="token keyword">return</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'SADD'</span><span class="token punctuation">,</span> orderKey<span class="token punctuation">,</span> userId<span class="token punctuation">)</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>hmdp<span class="token punctuation">.</span>service<span class="token punctuation">.</span>impl</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>core<span class="token punctuation">.</span>toolkit<span class="token punctuation">.</span></span><span class="token class-name">Wrappers</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>hmdp<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">SeckillVoucher</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>hmdp<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">VoucherOrder</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>hmdp<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span></span><span class="token class-name">VoucherOrderMapper</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>hmdp<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">ISeckillVoucherService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>hmdp<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">IVoucherOrderService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>extension<span class="token punctuation">.</span>service<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span><span class="token class-name">ServiceImpl</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>hmdp<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">RedisIdWorker</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>hmdp<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">UserHolder</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>redisson<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">RLock</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>redisson<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">RedissonClient</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>aop<span class="token punctuation">.</span>framework<span class="token punctuation">.</span></span><span class="token class-name">AopContext</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Lazy</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>core<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ClassPathResource</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">StringRedisTemplate</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>core<span class="token punctuation">.</span>script<span class="token punctuation">.</span></span><span class="token class-name">DefaultRedisScript</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Transactional</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PostConstruct</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collections</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ArrayBlockingQueue</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">BlockingQueue</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ExecutorService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">Executors</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * &lt;p&gt;
 *  æœåŠ¡å®ç°ç±»
 * &lt;/p&gt;
 *
 * @author è™å“¥
 * @since 2021-12-22
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">VoucherOrderServiceImpl</span> <span class="token keyword">extends</span> <span class="token class-name">ServiceImpl</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">VoucherOrderMapper</span><span class="token punctuation">,</span> <span class="token class-name">VoucherOrder</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">IVoucherOrderService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">ISeckillVoucherService</span> seckillVoucherService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisIdWorker</span> idWorker<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RedissonClient</span> redissonClient<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token annotation punctuation">@Lazy</span>
    <span class="token keyword">private</span> <span class="token class-name">IVoucherOrderService</span> voucherOrderService<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">DefaultRedisScript</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> SECKILL_SCRIPT<span class="token punctuation">;</span>

    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        SECKILL_SCRIPT <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultRedisScript</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        SECKILL_SCRIPT<span class="token punctuation">.</span><span class="token function">setLocation</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClassPathResource</span><span class="token punctuation">(</span><span class="token string">&quot;lua/seckill.lua&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        SECKILL_SCRIPT<span class="token punctuation">.</span><span class="token function">setResultType</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * é˜»å¡é˜Ÿåˆ—
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">VoucherOrder</span><span class="token punctuation">&gt;</span></span> orderQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * çº¿ç¨‹æ± 
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">ExecutorService</span> executors <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newSingleThreadExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        executors<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
           <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token comment">// 1. è·å–é˜Ÿåˆ—ä¸­çš„è®¢å•ä¿¡æ¯</span>
               <span class="token class-name">VoucherOrder</span> voucherOrder <span class="token operator">=</span> orderQueue<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token comment">// 2. åˆ›å»ºè®¢å•</span>
                <span class="token class-name">RLock</span> lock <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">&quot;order:&quot;</span> <span class="token operator">+</span> voucherOrder<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">boolean</span> success <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token number">5L</span><span class="token punctuation">,</span> <span class="token number">10L</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;è·å–é”å¤±è´¥&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    voucherOrderService<span class="token punctuation">.</span><span class="token function">createOrder</span><span class="token punctuation">(</span>voucherOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
           <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">seckillVoucher</span><span class="token punctuation">(</span><span class="token class-name">Long</span> voucherId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1. æ‰§è¡Œluaè„šæœ¬</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Long</span> execute <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>
                SECKILL_SCRIPT<span class="token punctuation">,</span>
                <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                voucherId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">int</span> r <span class="token operator">=</span> execute<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;åº“å­˜ä¸è¶³&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;ä½ å·²æ‹¥æœ‰æ­¤åˆ¸,è¯·ä¸è¦é‡å¤ä¸‹å•&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;æœªçŸ¥é”™è¯¯&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">long</span> orderId <span class="token operator">=</span> idWorker<span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token string">&quot;order&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">VoucherOrder</span> voucherOrder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VoucherOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        voucherOrder<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        voucherOrder<span class="token punctuation">.</span><span class="token function">setVoucherId</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        voucherOrder<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// è®¢å•å­˜å…¥é˜»å¡é˜Ÿåˆ—</span>
        orderQueue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>voucherOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> orderId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createOrder</span><span class="token punctuation">(</span><span class="token class-name">VoucherOrder</span> voucherOrder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> voucherOrder<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 1. åˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯å¦å·²ç»æœ‰åˆ¸</span>
        <span class="token class-name">Integer</span> count <span class="token operator">=</span> baseMapper<span class="token punctuation">.</span><span class="token function">selectCount</span><span class="token punctuation">(</span>
                <span class="token class-name">Wrappers</span><span class="token punctuation">.</span><span class="token function">lambdaQuery</span><span class="token punctuation">(</span><span class="token class-name">VoucherOrder</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">VoucherOrder</span><span class="token operator">::</span><span class="token function">getVoucherId</span><span class="token punctuation">,</span> voucherOrder<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">VoucherOrder</span><span class="token operator">::</span><span class="token function">getUserId</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;ä½ å·²æŠ¢è¿‡æ­¤åˆ¸&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 2. æ‰£å‡åº“å­˜</span>
        <span class="token keyword">boolean</span> success <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">lambdaUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setSql</span><span class="token punctuation">(</span><span class="token string">&quot;stock = stock - 1&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">SeckillVoucher</span><span class="token operator">::</span><span class="token function">getVoucherId</span><span class="token punctuation">,</span> voucherOrder<span class="token punctuation">.</span><span class="token function">getVoucherId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">gt</span><span class="token punctuation">(</span><span class="token class-name">SeckillVoucher</span><span class="token operator">::</span><span class="token function">getStock</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;æœåŠ¡å™¨å¼‚å¸¸&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 3. æ’å…¥è®¢å•</span>
        baseMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>voucherOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ç§’æ€ä¸šåŠ¡çš„ä¼˜åŒ–æ€è·¯</p> <ol><li>å…ˆåˆ©ç”¨Rediså®Œæˆåº“å­˜ä½™é‡ã€ä¸€äººä¸€å•åˆ¤æ–­ï¼Œå®ŒæˆæŠ¢å•ä¸šåŠ¡</li> <li>å†å°†ä¸‹å•ä¸šåŠ¡æ”¾å…¥é˜»å¡é˜Ÿåˆ—ï¼Œåˆ©ç”¨ç‹¬ç«‹çº¿ç¨‹å¼‚æ­¥ä¸‹å•</li></ol> <p>å­˜åœ¨çš„é—®é¢˜</p> <ul><li>å†…å­˜é™åˆ¶é—®é¢˜</li> <li>æ•°æ®å®‰å…¨é—®é¢˜</li></ul> <h3 id="_6-2-æ¶ˆæ¯é˜Ÿåˆ—"><a href="#_6-2-æ¶ˆæ¯é˜Ÿåˆ—" class="header-anchor">#</a> 6.2 æ¶ˆæ¯é˜Ÿåˆ—</h3> <p>æœ€ç®€å•çš„æ¶ˆæ¯é˜Ÿåˆ—æ¨¡å‹åŒ…æ‹¬ä¸‰ä¸ªè§’è‰²</p> <ul><li>æ¶ˆæ¯é˜Ÿåˆ—ï¼šå­˜å‚¨å’Œç®¡ç†æ¶ˆæ¯ï¼Œä¹Ÿè¢«ç§°ä¸ºæ¶ˆæ¯ä»£ç†(Message Broker)</li> <li>ç”Ÿäº§è€…ï¼šå‘é€æ¶ˆæ¯åˆ°æ¶ˆæ¯é˜Ÿåˆ—</li> <li>æ¶ˆè´¹è€…ï¼šä»æ¶ˆæ¯é˜Ÿåˆ—è·å–æ¶ˆæ¯å¹¶å¤„ç†æ¶ˆæ¯</li></ul> <div class="spinner" style="background:rgb(66, 185, 131);" data-v-1bbcb91a></div><p>Redisæä¾›äº†ä¸‰ç§ä¸åŒçš„æ–¹å¼æ¥å®ç°æ¶ˆæ¯é˜Ÿåˆ—</p> <ul><li>listç»“æ„ï¼šåŸºäºListç»“æ„æ¨¡æ‹Ÿæ¶ˆæ¯é˜Ÿåˆ—</li> <li>PubSubï¼šåŸºæœ¬çš„ç‚¹å¯¹ç‚¹æ¶ˆæ¯æ¨¡å‹</li> <li>Streamï¼šæ¯”è¾ƒå®Œå–„çš„æ¶ˆæ¯é˜Ÿåˆ—æ¨¡å‹</li></ul> <h4 id="_6-2-1-åŸºäºlistç»“æ„"><a href="#_6-2-1-åŸºäºlistç»“æ„" class="header-anchor">#</a> 6.2.1 åŸºäºLIstç»“æ„</h4> <p>Redisçš„Listæ•°æ®ç»“æ„æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œå¾ˆå®¹æ˜“æ¨¡æ‹Ÿå‡ºé˜Ÿåˆ—æ•ˆæœ</p> <p>é˜Ÿåˆ—æ˜¯å…¥å£å’Œå‡ºå£ä¸åœ¨ä¸€èµ·ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ï¼šLPUSHç»“åˆRPOPã€æˆ–è€…RPUSHç»“åˆLPOPæ¥å®ç°</p> <p>ä¸è¿‡è¦æ³¨æ„çš„æ˜¯ï¼Œå½“é˜Ÿåˆ—ä¸­æ²¡æœ‰æ¶ˆæ¯æ—¶RPOPæˆ–LPOPæ“ä½œä¼šè¿”å›nullï¼Œå¹¶ä¸ä¼šåƒJVMçš„é˜»å¡é˜Ÿåˆ—é‚£æ ·ä¼šé˜»å¡å¹¶ç­‰å¾…æ¶ˆæ¯ï¼Œå› æ­¤è¿™é‡Œåº”è¯¥ä½¿ç”¨BRPOPæˆ–è€…BLPOPæ¥å®ç°é˜»å¡æ•ˆæœ</p> <p>åŸºäºListçš„æ¶ˆæ¯é˜Ÿåˆ—æœ‰å“ªäº›ä¼˜ç¼ºç‚¹</p> <p>ä¼˜ç‚¹ï¼š</p> <ul><li>åˆ©ç”¨Rediså­˜å‚¨ï¼Œä¸å—é™äºJVMå†…å­˜ä¸Šé™</li> <li>åŸºäºRedisçš„æŒä¹…åŒ–æœºåˆ¶ï¼Œæ•°æ®å®‰å…¨æ€§æœ‰ä¿è¯</li> <li>å¯ä»¥æ»¡è¶³æ¶ˆæ¯æœ‰åºæ€§</li></ul> <p>ç¼ºç‚¹ï¼š</p> <ul><li>æ— æ³•é¿å…æ¶ˆæ¯ä¸¢å¤±</li> <li>åªæ”¯æŒå•æ¶ˆè´¹è€…</li></ul> <h4 id="_6-2-2-åŸºäºpubsub"><a href="#_6-2-2-åŸºäºpubsub" class="header-anchor">#</a> 6.2.2 åŸºäºPubSub</h4> <p>PubSub(å‘å¸ƒè®¢é˜…)æ˜¯Redis2.0ç‰ˆæœ¬å¼•å…¥çš„æ¶ˆæ¯ä¼ é€’æ¨¡å‹ã€‚æ¶ˆè´¹è€…å¯ä»¥è®¢é˜…ä¸€ä¸ªæˆ–è€…å¤šä¸ªChannelï¼Œç”Ÿäº§è€…å‘å¯¹åº”channelå‘é€æ¶ˆæ¯åï¼Œæ‰€æœ‰è®¢é˜…è€…éƒ½èƒ½æ”¶åˆ°ç›¸å…³æ¶ˆæ¯</p> <ul><li><p>è®¢é˜…ä¸€ä¸ªæˆ–å¤šä¸ªé¢‘é“</p> <div class="language-redis extra-class"><pre class="language-text"><code>SUBSCRIBE channel [channel]
</code></pre></div></li> <li><p>å‘ä¸€ä¸ªé¢‘é“å‘é€æ¶ˆæ¯</p> <div class="language-redis extra-class"><pre class="language-text"><code>PUBLISH channel msg
</code></pre></div></li> <li><p>è®¢é˜…ä¸patternæ ¼å¼åŒ¹é…çš„æ‰€æœ‰é¢‘é“</p> <div class="language-redis extra-class"><pre class="language-text"><code>PSUBSCRIBE pattern [pattern]
</code></pre></div></li></ul> <div class="spinner" style="background:rgb(66, 185, 131);" data-v-1bbcb91a></div><p>åŸºäºPubSubçš„æ¶ˆæ¯é˜Ÿåˆ—æœ‰å“ªäº›ä¼˜ç¼ºç‚¹</p> <p>ä¼˜ç‚¹ï¼š</p> <ul><li>é‡‡ç”¨å‘å¸ƒè®¢é˜…æ¨¡å‹ï¼Œæ”¯æŒå¤šç”Ÿäº§ã€å¤šæ¶ˆè´¹</li></ul> <p>ç¼ºç‚¹ï¼š</p> <ul><li>ä¸æ”¯æŒæ•°æ®æŒä¹…åŒ–</li> <li>æ— æ³•é¿å…æ¶ˆæ¯ä¸¢å¤±</li> <li>æ¶ˆæ¯å †ç§¯æœ‰ä¸Šé™ï¼Œè¶…å‡ºæ—¶æ•°æ®ä¸¢å¤±</li></ul> <h4 id="_6-2-3-åŸºäºstream"><a href="#_6-2-3-åŸºäºstream" class="header-anchor">#</a> 6.2.3 åŸºäºStream</h4> <p>Streamæ—¶Redis5.0å¼•å…¥çš„ä¸€ç§æ–°çš„æ•°æ®ç±»å‹ã€‚å¯ä»¥å®ç°ä¸€ä¸ªåŠŸèƒ½éå¸¸å®Œå–„çš„æ¶ˆæ¯é˜Ÿåˆ—</p> <p>ä¾‹å¦‚ï¼šåˆ›å»ºåä¸ºusersçš„é˜Ÿåˆ—ï¼Œå¹¶å‘å…¶ä¸­å‘é€ä¸€ä¸ªæ¶ˆæ¯ï¼Œå†…å®¹ï¼š{name=jack,age=21}ï¼Œå¹¶ä¸”ä½¿ç”¨Redisè‡ªåŠ¨ç”ŸæˆID</p> <div class="language- extra-class"><pre class="language-text"><code>XADD users * name jack age 21
</code></pre></div><p>è¯»å–ï¼š<code>$</code>ä»£è¡¨è¯»å–æœ€æ–°çš„æ¶ˆæ¯ï¼Œ</p> <div class="language- extra-class"><pre class="language-text"><code>XREAD COUNT 1 BLOCK 1000 STREAMS users $
</code></pre></div><p>æ³¨æ„ï¼šå½“æˆ‘ä»¬æŒ‡å®šèµ·å§‹IDä¸º$æ—¶ï¼Œä»£è¡¨è¯»å–æœ€æ–°çš„æ¶ˆæ¯ï¼Œå¦‚æœæˆ‘ä»¬å¤„ç†ä¸€æ¡æ¶ˆæ¯çš„è¿‡ç¨‹ä¸­ï¼Œåˆæœ‰è¶…è¿‡1æ¡ä»¥ä¸Šçš„æ¶ˆæ¯åˆ°è¾¾é˜Ÿåˆ—ï¼Œåˆ™ä¸‹æ¬¡è·å–æ—¶ä¹Ÿåªèƒ½è·å–åˆ°æœ€æ–°çš„ä¸€æ¡ï¼Œä¼šå‡ºç°æ¼å¯¹æ¶ˆæ¯çš„é—®é¢˜</p> <p>STREAMç±»å‹æ¶ˆæ¯é˜Ÿåˆ—çš„XREADå‘½ä»¤ç‰¹ç‚¹ï¼š</p> <ul><li>æ¶ˆæ¯å¯å›æº¯</li> <li>ä¸€ä¸ªæ¶ˆæ¯å¯ä»¥è¢«å¤šä¸ªæ¶ˆè´¹è€…è¯»å–</li> <li>å¯ä»¥é˜»å¡è¯»å–</li> <li>æœ‰æ¶ˆæ¯æ¼è¯»çš„é£é™©</li></ul> <h4 id="_6-2-4-streamæ¶ˆè´¹è€…ç»„"><a href="#_6-2-4-streamæ¶ˆè´¹è€…ç»„" class="header-anchor">#</a> 6.2.4 Streamæ¶ˆè´¹è€…ç»„</h4> <p>æ¶ˆè´¹è€…ç»„(Consumer Group)ï¼šå°†å¤šä¸ªæ¶ˆè´¹è€…åˆ’åˆ†åˆ°ä¸€ä¸ªç»„ä¸­ï¼Œç›‘å¬åŒä¸€ä¸ªé˜Ÿåˆ—ã€‚å…·å¤‡ä¸‹åˆ—ç‰¹ç‚¹ï¼š</p> <ol><li><p>æ¶ˆæ¯åˆ†æµ</p> <p>é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ä¼šåˆ†æµç»™ç»„å†…çš„ä¸åŒæ¶ˆè´¹è€…ï¼Œè€Œä¸æ˜¯é‡å¤æ¶ˆè´¹ï¼Œä»è€ŒåŠ å¿«æ¶ˆæ¯å¤„ç†çš„é€Ÿåº¦</p></li> <li><p>æ¶ˆæ¯æ ‡ç¤º</p> <p>æ¶ˆè´¹è€…ç»„ä¼šç»´æŠ¤ä¸€ä¸ªæ ‡ç¤ºï¼Œè®°å½•æœ€åä¸€ä¸ªè¢«å¤„ç†çš„æ¶ˆæ¯ï¼Œå“ªæ€•æ¶ˆè´¹è€…å®•æœºé‡å¯ï¼Œè¿˜ä¼šä»æ ‡ç¤ºä¹‹åè¯»å–æ¶ˆæ¯ã€‚ç¡®ä¿æ¯ä¸€ä¸ªæ¶ˆæ¯éƒ½ä¼šè¢«æ¶ˆè´¹</p></li> <li><p>æ¶ˆæ¯ç¡®è®¤</p> <p>æ¶ˆè´¹è€…è·å–æ¶ˆæ¯åï¼Œæ¶ˆæ¯å¤„äºpendingçŠ¶æ€ï¼Œå¹¶å­˜å…¥ä¸€ä¸ªpending-listã€‚å½“å¤„ç†å®Œæˆåéœ€è¦é€šè¿‡XACKæ¥ç¡®è®¤æ¶ˆæ¯ï¼Œæ ‡è®°æ¶ˆæ¯ä¸ºå·²å¤„ç†ï¼Œæ‰ä¼šä»pending-listç§»é™¤</p></li></ol> <p>åˆ›å»ºæ¶ˆè´¹è€…ç»„ï¼š</p> <div class="language-redis extra-class"><pre class="language-text"><code>XGROUP CREATE key groupName ID [MKSTREAM]
</code></pre></div><ul><li>keyï¼šé˜Ÿåˆ—åç§°</li> <li>groupNameï¼šæ¶ˆè´¹è€…ç»„åç§°</li> <li>IDï¼šèµ·å§‹IDæ ‡ç¤ºï¼Œ$ä»£è¡¨é˜Ÿåˆ—ä¸­æœ€åä¸€ä¸ªæ¶ˆæ¯ï¼Œ0åˆ™ä»£è¡¨é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªæ¶ˆæ¯</li> <li>MKSTREAMï¼šé˜Ÿåˆ—ä¸å­˜åœ¨æ—¶è‡ªåŠ¨åˆ›å»ºé˜Ÿåˆ—</li></ul> <p>å…¶ä»–å¸¸è§å‘½ä»¤ï¼š</p> <ol><li><p>åˆ é™¤æŒ‡å®šçš„æ¶ˆè´¹è€…ç»„</p> <div class="language-redis extra-class"><pre class="language-text"><code>XGROUP DESTORY key groupName
</code></pre></div></li> <li><p>ç»™æŒ‡å®šçš„æ¶ˆè´¹è€…ç»„æ·»åŠ æ¶ˆè´¹è€…</p> <div class="language-redis extra-class"><pre class="language-text"><code>XGROUP CREATECONSUMER key groupName consumerName
</code></pre></div></li> <li><p>åˆ é™¤æ¶ˆè´¹è€…ç»„ä¸­çš„æŒ‡å®šæ¶ˆè´¹è€…</p> <div class="language- extra-class"><pre class="language-text"><code>XGROUP DELCONSUMER key groupName consumerName
</code></pre></div></li></ol> <p>ä»æ¶ˆè´¹è€…ç»„è¯»å–æ¶ˆæ¯ï¼š</p> <div class="language-redis extra-class"><pre class="language-text"><code>XREADGROUP GROUP group consumer [COUNT count] [BLOCK milliseconds] [NOACK] STREAMS key [key ...] ID [ID ...]
</code></pre></div><ul><li><p>groupï¼šæ¶ˆè´¹ç»„åç§°</p></li> <li><p>consumerï¼šæ¶ˆè´¹è€…åç§°ï¼Œå¦‚æœæ¶ˆè´¹è€…ä¸å­˜åœ¨ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªæ¶ˆè´¹è€…</p></li> <li><p>countï¼šæœ¬æ¬¡æŸ¥è¯¢çš„æœ€å¤§æ•°é‡</p></li> <li><p>BLOCK millisecondsï¼šå½“æ²¡æœ‰æ¶ˆæ¯æ—¶æœ€é•¿ç­‰å¾…æ—¶é—´</p></li> <li><p>NOACKï¼šæ— éœ€æ‰‹åŠ¨ACKï¼Œè·å–åˆ°æ¶ˆæ¯åè‡ªåŠ¨ç¡®è®¤</p></li> <li><p>STREAMS keyï¼šæŒ‡å®šé˜Ÿåˆ—åç§°</p></li> <li><p>IDï¼šè·å–æ¶ˆæ¯çš„èµ·å§‹ID</p> <p>&quot;&gt;&quot;ï¼šä»ä¸‹ä¸€ä¸ªæœªæ¶ˆè´¹çš„æ¶ˆæ¯å¼€å§‹</p> <p>å…¶ä»–ï¼šæ ¹æ®æŒ‡å®šidä»pending-listä¸­è·å–å·²æ¶ˆè´¹ä½†æœªç¡®è®¤çš„æ¶ˆæ¯ï¼Œä¾‹å¦‚0ï¼Œæ˜¯ä»pending-listä¸­çš„ç¬¬ä¸€ä¸ªæ¶ˆæ¯å¼€å§‹</p></li></ul> <p>STREAMç±»å‹æ¶ˆæ¯é˜Ÿåˆ—çš„XREADGROUPå‘½ä»¤ç‰¹ç‚¹ï¼š</p> <ul><li>æ¶ˆæ¯å¯å›æº¯</li> <li>å¯ä»¥å¤šæ¶ˆè´¹è€…äº‰æŠ¢æ¶ˆæ¯ï¼ŒåŠ å¿«æ¶ˆè´¹é€Ÿåº¦</li> <li>å¯ä»¥é˜»å¡è¯»å–</li> <li>æ²¡æœ‰æ¶ˆæ¯æ¼è¯»çš„é£é™©</li> <li>æœ‰æ¶ˆæ¯ç¡®è®¤æœºåˆ¶ï¼Œä¿è¯æ¶ˆæ¯è‡³å°‘è¢«æ¶ˆè´¹ä¸€æ¬¡</li></ul> <h3 id="_6-3-åŸºäºstreamæ¶ˆæ¯é˜Ÿåˆ—-ç§’æ€ä¸‹å•"><a href="#_6-3-åŸºäºstreamæ¶ˆæ¯é˜Ÿåˆ—-ç§’æ€ä¸‹å•" class="header-anchor">#</a> 6.3 åŸºäºStreamæ¶ˆæ¯é˜Ÿåˆ—ï¼Œç§’æ€ä¸‹å•</h3> <ol><li><p>åˆ›å»ºStreamå’Œç»„</p> <div class="language-redis extra-class"><pre class="language-text"><code>XGROUP CREATE stream.orders g1 0 MKSTREAM
</code></pre></div></li> <li><p>ä¿®æ”¹ä¹‹å‰çš„ç§’æ€ä¸‹å•Luaè„šæœ¬ï¼Œåœ¨è®¤å®šæœ‰æŠ¢è´­èµ„æ ¼åï¼Œç›´æ¥å‘stream.ordersä¸­æ·»åŠ æ¶ˆæ¯ï¼Œå†…å®¹åŒ…å«voucherIdã€userIdã€orderId</p> <div class="language-lua extra-class"><pre class="language-lua"><code><span class="token comment">-- ç”¨æˆ·æŠ¢è´­ä¼˜æƒ åˆ¸</span>

<span class="token comment">-- ä¼˜æƒ åˆ¸id</span>
<span class="token keyword">local</span> voucherId <span class="token operator">=</span> ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token comment">-- ç”¨æˆ·id</span>
<span class="token keyword">local</span> userId <span class="token operator">=</span> ARGV<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
<span class="token comment">-- ç”¨æˆ·id</span>
<span class="token keyword">local</span> orderId <span class="token operator">=</span> ARGV<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>

<span class="token comment">-- åº“å­˜key</span>
<span class="token keyword">local</span> stockKey <span class="token operator">=</span> <span class="token string">'seckill:stock:'</span><span class="token operator">..</span>voucherId
<span class="token comment">-- è®¢å•key</span>
<span class="token keyword">local</span> orderKey <span class="token operator">=</span> <span class="token string">'seckill:order:'</span><span class="token operator">..</span>voucherId

<span class="token comment">-- åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tonumber</span><span class="token punctuation">(</span>redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'GET'</span><span class="token punctuation">,</span> stockKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">then</span>
    <span class="token keyword">return</span> <span class="token number">3</span>
<span class="token keyword">end</span>
<span class="token comment">-- åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å·²ç»ä¸‹å•</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'SISMEMBER'</span><span class="token punctuation">,</span> orderKey<span class="token punctuation">,</span> userId<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">then</span>
    <span class="token keyword">return</span> <span class="token number">2</span>
<span class="token keyword">end</span>

<span class="token comment">-- ç”¨æˆ·æœªä¸‹å•</span>
<span class="token comment">-- æ‰£åº“å­˜</span>
redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'INCRBY'</span><span class="token punctuation">,</span> stockKey<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment">-- ä¸‹å•</span>
redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'SADD'</span><span class="token punctuation">,</span> orderKey<span class="token punctuation">,</span> userId<span class="token punctuation">)</span>
<span class="token comment">-- å‘é€æ¶ˆæ¯åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­</span>
redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'XADD'</span><span class="token punctuation">,</span> <span class="token string">'stream.orders'</span><span class="token punctuation">,</span> <span class="token string">'*'</span><span class="token punctuation">,</span> <span class="token string">'voucherId'</span><span class="token punctuation">,</span> voucherId<span class="token punctuation">,</span> <span class="token string">'userId'</span><span class="token punctuation">,</span> userId<span class="token punctuation">,</span> <span class="token string">'id'</span><span class="token punctuation">,</span> orderId<span class="token punctuation">)</span>
<span class="token keyword">return</span> <span class="token number">1</span>
</code></pre></div></li> <li><p>é¡¹ç›®å¯åŠ¨æ—¶ï¼Œå¼€å¯ä¸€ä¸ªçº¿ç¨‹ä»»åŠ¡ï¼Œå°è¯•è·å–stream.ordersä¸­çš„æ¶ˆæ¯ï¼Œå®Œæˆä¸‹å•</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">VoucherOrderServiceImpl</span> <span class="token keyword">extends</span> <span class="token class-name">ServiceImpl</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">VoucherOrderMapper</span><span class="token punctuation">,</span> <span class="token class-name">VoucherOrder</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">IVoucherOrderService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">ISeckillVoucherService</span> seckillVoucherService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisIdWorker</span> idWorker<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RedissonClient</span> redissonClient<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token annotation punctuation">@Lazy</span>
    <span class="token keyword">private</span> <span class="token class-name">IVoucherOrderService</span> voucherOrderService<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">DefaultRedisScript</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> SECKILL_SCRIPT<span class="token punctuation">;</span>

    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        SECKILL_SCRIPT <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultRedisScript</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        SECKILL_SCRIPT<span class="token punctuation">.</span><span class="token function">setLocation</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClassPathResource</span><span class="token punctuation">(</span><span class="token string">&quot;lua/seckill.lua&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        SECKILL_SCRIPT<span class="token punctuation">.</span><span class="token function">setResultType</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * é˜»å¡é˜Ÿåˆ—
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">VoucherOrder</span><span class="token punctuation">&gt;</span></span> orderQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * çº¿ç¨‹æ± 
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">ExecutorService</span> executors <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newSingleThreadExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        executors<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment">// è·å–æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯</span>
                    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MapRecord</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> recordList <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>
                            <span class="token class-name">Consumer</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;g1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;c1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token class-name">StreamReadOptions</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">block</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token class-name">StreamOffset</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">&quot;stream.orders&quot;</span><span class="token punctuation">,</span> <span class="token class-name">ReadOffset</span><span class="token punctuation">.</span><span class="token function">lastConsumed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>recordList<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// è·å–å¤±è´¥ï¼Œç»§ç»­ä¸‹ä¸€æ¬¡å¾ªç¯</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token comment">// è§£ææ¶ˆæ¯</span>
                    <span class="token class-name">MapRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">record</span> <span class="token operator">=</span> recordList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">VoucherOrder</span> voucherOrder <span class="token operator">=</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">fillBeanWithMap</span><span class="token punctuation">(</span><span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">VoucherOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">// ä¸‹å•</span>
                    <span class="token function">createOrder</span><span class="token punctuation">(</span>voucherOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">// ç¡®è®¤æ¶ˆæ¯</span>
                    redisTemplate<span class="token punctuation">.</span><span class="token function">opsForStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">acknowledge</span><span class="token punctuation">(</span><span class="token string">&quot;stream.orders&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;g1&quot;</span><span class="token punctuation">,</span> <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;å¤„ç†å¼‚å¸¸æ¶ˆæ¯&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">handlePendingList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handlePendingList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// è·å–pending-listä¸­çš„æ¶ˆæ¯</span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MapRecord</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> recordList <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>
                        <span class="token class-name">Consumer</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;g1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;c1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token class-name">StreamReadOptions</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token class-name">StreamOffset</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">&quot;stream.orders&quot;</span><span class="token punctuation">,</span> <span class="token class-name">ReadOffset</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>recordList<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// pending-list ä¸­æ²¡æœ‰å¼‚å¸¸æ¶ˆæ¯ è·³å‡ºå¾ªç¯</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// è§£ææ¶ˆæ¯</span>
                <span class="token class-name">MapRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">record</span> <span class="token operator">=</span> recordList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">VoucherOrder</span> voucherOrder <span class="token operator">=</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">fillBeanWithMap</span><span class="token punctuation">(</span><span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">VoucherOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// ä¸‹å•</span>
                <span class="token function">createOrder</span><span class="token punctuation">(</span>voucherOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// ç¡®è®¤æ¶ˆæ¯</span>
                redisTemplate<span class="token punctuation">.</span><span class="token function">opsForStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">acknowledge</span><span class="token punctuation">(</span><span class="token string">&quot;stream.orders&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;g1&quot;</span><span class="token punctuation">,</span> <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;å¤„ç†pending-listè®¢å•å¼‚å¸¸&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">seckillVoucher</span><span class="token punctuation">(</span><span class="token class-name">Long</span> voucherId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1. æ‰§è¡Œluaè„šæœ¬</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> orderId <span class="token operator">=</span> idWorker<span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token string">&quot;order&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Long</span> execute <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>
                SECKILL_SCRIPT<span class="token punctuation">,</span>
                <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                voucherId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">int</span> r <span class="token operator">=</span> execute<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;åº“å­˜ä¸è¶³&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;ä½ å·²æ‹¥æœ‰æ­¤åˆ¸,è¯·ä¸è¦é‡å¤ä¸‹å•&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;æœªçŸ¥é”™è¯¯&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> orderId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createOrder</span><span class="token punctuation">(</span><span class="token class-name">VoucherOrder</span> voucherOrder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> voucherOrder<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 1. åˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯å¦å·²ç»æœ‰åˆ¸</span>
        <span class="token class-name">Integer</span> count <span class="token operator">=</span> baseMapper<span class="token punctuation">.</span><span class="token function">selectCount</span><span class="token punctuation">(</span>
                <span class="token class-name">Wrappers</span><span class="token punctuation">.</span><span class="token function">lambdaQuery</span><span class="token punctuation">(</span><span class="token class-name">VoucherOrder</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">VoucherOrder</span><span class="token operator">::</span><span class="token function">getVoucherId</span><span class="token punctuation">,</span> voucherOrder<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">VoucherOrder</span><span class="token operator">::</span><span class="token function">getUserId</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;ä½ å·²æŠ¢è¿‡æ­¤åˆ¸&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 2. æ‰£å‡åº“å­˜</span>
        <span class="token keyword">boolean</span> success <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">lambdaUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setSql</span><span class="token punctuation">(</span><span class="token string">&quot;stock = stock - 1&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">SeckillVoucher</span><span class="token operator">::</span><span class="token function">getVoucherId</span><span class="token punctuation">,</span> voucherOrder<span class="token punctuation">.</span><span class="token function">getVoucherId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">gt</span><span class="token punctuation">(</span><span class="token class-name">SeckillVoucher</span><span class="token operator">::</span><span class="token function">getStock</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;æœåŠ¡å™¨å¼‚å¸¸&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 3. æ’å…¥è®¢å•</span>
        baseMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>voucherOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div></li></ol> <h2 id="_7-è¾¾äººæ¢åº—"><a href="#_7-è¾¾äººæ¢åº—" class="header-anchor">#</a> 7. è¾¾äººæ¢åº—</h2> <h3 id="_7-1-ç‚¹èµåŠŸèƒ½"><a href="#_7-1-ç‚¹èµåŠŸèƒ½" class="header-anchor">#</a> 7.1 ç‚¹èµåŠŸèƒ½</h3> <p>éœ€æ±‚ï¼š</p> <ul><li>ç”¨ä¸€ä¸ªç”¨æˆ·åªèƒ½ç‚¹èµä¸€æ¬¡ï¼Œå†æ¬¡ç‚¹å‡»åˆ™å–æ¶ˆç‚¹èµ</li> <li>å¦‚æœå½“å‰ç”¨æˆ·å·²ç»ç‚¹èµï¼Œåˆ™ç‚¹èµæŒ‰é’®é«˜äº®æ˜¾ç¤º</li></ul> <p>å®ç°æ­¥éª¤ï¼š</p> <ol><li>ç»™Blogç±»ä¸­æ·»åŠ ä¸€ä¸ªisLikeå­—æ®µï¼Œæ ‡ç¤ºæ˜¯å¦è¢«å½“å‰ç”¨æˆ·ç‚¹èµ</li> <li>ä¿®æ”¹ç‚¹èµåŠŸèƒ½ï¼Œåˆ©ç”¨Redisçš„seté›†åˆåˆ¤æ–­æ˜¯å¦ç‚¹èµè¿‡ï¼Œæœªç‚¹èµç‚¹èµæ•°+1ï¼Œå·²ç‚¹èµç‚¹èµæ•°-1</li> <li>ä¿®æ”¹æ ¹æ®idæŸ¥è¯¢Blogä¸šåŠ¡ï¼Œåˆ¤æ–­å½“å‰ç™»å½•ç”¨æˆ·æ˜¯å¦ç‚¹èµè¿‡ï¼Œèµ‹å€¼ç»™isLikeå­—æ®µ</li></ol></div></section> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">æœ€åä¿®æ”¹æ—¶é—´: </span> <span class="time">5 minutes ago</span></div></footer> <!----> <div class="comments-wrapper"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:0;" data-v-70334359></ul></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div><div id="live2d-widget" class="live2d-widget-container" style="position:fixed;left:50px;bottom:0px;width:135px;height:300px;z-index:99999;opacity:0.8;pointer-events:none;"><canvas id="live2d_canvas" width="135" height="300" class="live2d_canvas" style="position:absolute;left:0px;top:0px;width:135px;height:300px;"></canvas></div></div></div>
    <script src="/assets/js/app.b2a9dced.js" defer></script><script src="/assets/js/3.7270c5c5.js" defer></script><script src="/assets/js/1.86f97011.js" defer></script><script src="/assets/js/26.046385b9.js" defer></script>
  </body>
</html>
