<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>SpringCloud | 薛定谔see猫</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/2.10.0/github-markdown.min.css">
    <meta name="description" content="">
    <meta charset="UTF-8" version="1">
    <meta name="baidu-site-verification" content="code-E5pfjV93p5">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <meta name="Keywords" content="个人博客, 薛定谔see猫,程序员,java">
    
    <link rel="preload" href="/assets/css/0.styles.aea1a24b.css" as="style"><link rel="preload" href="/assets/js/app.e924ca4b.js" as="script"><link rel="preload" href="/assets/js/3.7270c5c5.js" as="script"><link rel="preload" href="/assets/js/1.86f97011.js" as="script"><link rel="preload" href="/assets/js/38.7146353c.js" as="script"><link rel="prefetch" href="/assets/js/10.16fcb61e.js"><link rel="prefetch" href="/assets/js/11.2ec9a72a.js"><link rel="prefetch" href="/assets/js/12.8fb983b5.js"><link rel="prefetch" href="/assets/js/13.5d002133.js"><link rel="prefetch" href="/assets/js/14.91b6073d.js"><link rel="prefetch" href="/assets/js/15.f93d51ef.js"><link rel="prefetch" href="/assets/js/16.80841806.js"><link rel="prefetch" href="/assets/js/17.9d240430.js"><link rel="prefetch" href="/assets/js/18.dbf5741d.js"><link rel="prefetch" href="/assets/js/19.33261f48.js"><link rel="prefetch" href="/assets/js/20.1a2b089f.js"><link rel="prefetch" href="/assets/js/21.90f20f01.js"><link rel="prefetch" href="/assets/js/22.5c25122d.js"><link rel="prefetch" href="/assets/js/23.4a3aad1b.js"><link rel="prefetch" href="/assets/js/24.175084c4.js"><link rel="prefetch" href="/assets/js/25.dc05cf49.js"><link rel="prefetch" href="/assets/js/26.bc93cd13.js"><link rel="prefetch" href="/assets/js/27.cd0fe4e3.js"><link rel="prefetch" href="/assets/js/28.5b4d981c.js"><link rel="prefetch" href="/assets/js/29.2a330377.js"><link rel="prefetch" href="/assets/js/30.6b03d99f.js"><link rel="prefetch" href="/assets/js/31.a00ce280.js"><link rel="prefetch" href="/assets/js/32.e9a49b16.js"><link rel="prefetch" href="/assets/js/33.40fd4b0b.js"><link rel="prefetch" href="/assets/js/34.6c257a59.js"><link rel="prefetch" href="/assets/js/35.8eba0b11.js"><link rel="prefetch" href="/assets/js/36.5475bbfd.js"><link rel="prefetch" href="/assets/js/37.f97d75d8.js"><link rel="prefetch" href="/assets/js/39.d7102738.js"><link rel="prefetch" href="/assets/js/4.e4abacbc.js"><link rel="prefetch" href="/assets/js/40.f11cb939.js"><link rel="prefetch" href="/assets/js/41.bf5d2538.js"><link rel="prefetch" href="/assets/js/42.ec8c06f7.js"><link rel="prefetch" href="/assets/js/43.050b755c.js"><link rel="prefetch" href="/assets/js/44.d72eadd7.js"><link rel="prefetch" href="/assets/js/45.5697c757.js"><link rel="prefetch" href="/assets/js/46.24e26ed2.js"><link rel="prefetch" href="/assets/js/47.34010df3.js"><link rel="prefetch" href="/assets/js/48.ff881805.js"><link rel="prefetch" href="/assets/js/49.82c3b973.js"><link rel="prefetch" href="/assets/js/5.248a317b.js"><link rel="prefetch" href="/assets/js/50.9f0ad11a.js"><link rel="prefetch" href="/assets/js/51.6cdc5c17.js"><link rel="prefetch" href="/assets/js/52.5cf9725a.js"><link rel="prefetch" href="/assets/js/53.b2369f03.js"><link rel="prefetch" href="/assets/js/54.0c624743.js"><link rel="prefetch" href="/assets/js/55.06320103.js"><link rel="prefetch" href="/assets/js/56.ded1f3eb.js"><link rel="prefetch" href="/assets/js/57.6457cff3.js"><link rel="prefetch" href="/assets/js/58.bece4936.js"><link rel="prefetch" href="/assets/js/6.ab70a287.js"><link rel="prefetch" href="/assets/js/7.5d305417.js"><link rel="prefetch" href="/assets/js/8.b250e2dd.js"><link rel="prefetch" href="/assets/js/9.aa723625.js">
    <link rel="stylesheet" href="/assets/css/0.styles.aea1a24b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-1156296a><div data-v-1156296a><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-1156296a data-v-1156296a><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-4e82dffc data-v-1156296a data-v-1156296a><h3 class="title" data-v-4e82dffc data-v-4e82dffc>薛定谔see猫</h3> <p class="description" data-v-4e82dffc data-v-4e82dffc></p> <label id="box" class="inputBox" data-v-4e82dffc data-v-4e82dffc><input type="password" value="" data-v-4e82dffc> <span data-v-4e82dffc>Konck! Knock!</span> <button data-v-4e82dffc>OK</button></label> <div class="footer" data-v-4e82dffc data-v-4e82dffc><span data-v-4e82dffc><i class="iconfont reco-theme" data-v-4e82dffc></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4e82dffc>vuePress-theme-reco</a></span> <span data-v-4e82dffc><i class="iconfont reco-copyright" data-v-4e82dffc></i> <a data-v-4e82dffc><span data-v-4e82dffc>薛定谔see猫</span>
            
          <!---->
          2022
        </a></span></div></div> <div class="hide" data-v-1156296a><header class="navbar" data-v-1156296a><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/assets/img/logo.jpg" alt="薛定谔see猫" class="logo"> <span class="site-name">薛定谔see猫</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-1156296a></div> <aside class="sidebar" data-v-1156296a><div class="personal-info-wrapper" data-v-828910c6 data-v-1156296a><img src="/assets/img/logo.jpg" alt="author-avatar" class="personal-img" data-v-828910c6> <h3 class="name" data-v-828910c6>
    薛定谔see猫
  </h3> <div class="num" data-v-828910c6><div data-v-828910c6><h3 data-v-828910c6>46</h3> <h6 data-v-828910c6>Articles</h6></div> <div data-v-828910c6><h3 data-v-828910c6>27</h3> <h6 data-v-828910c6>Tags</h6></div></div> <ul class="social-links" data-v-828910c6><li class="social-item" data-v-828910c6><i class="iconfont reco-github" style="color:#e15b64;" data-v-828910c6></i></li><li class="social-item" data-v-828910c6><i class="iconfont reco-bilibili" style="color:#e15b64;" data-v-828910c6></i></li></ul> <hr data-v-828910c6></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-4e82dffc data-v-1156296a><h3 class="title" data-v-4e82dffc data-v-4e82dffc>SpringCloud</h3> <!----> <label id="box" class="inputBox" data-v-4e82dffc data-v-4e82dffc><input type="password" value="" data-v-4e82dffc> <span data-v-4e82dffc>Konck! Knock!</span> <button data-v-4e82dffc>OK</button></label> <div class="footer" data-v-4e82dffc data-v-4e82dffc><span data-v-4e82dffc><i class="iconfont reco-theme" data-v-4e82dffc></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4e82dffc>vuePress-theme-reco</a></span> <span data-v-4e82dffc><i class="iconfont reco-copyright" data-v-4e82dffc></i> <a data-v-4e82dffc><span data-v-4e82dffc>薛定谔see猫</span>
            
          <!---->
          2022
        </a></span></div></div> <div data-v-1156296a><main class="page"><section><div class="page-title"><h1 class="title">SpringCloud</h1> <div data-v-1ff7123e><i class="iconfont reco-account" data-v-1ff7123e><span data-v-1ff7123e>薛定谔see猫</span></i> <i class="iconfont reco-date" data-v-1ff7123e><span data-v-1ff7123e>2022/3/24</span></i> <!----> <i class="tags iconfont reco-tag" data-v-1ff7123e><span class="tag-item" data-v-1ff7123e>java</span><span class="tag-item" data-v-1ff7123e>框架</span></i></div></div> <div class="theme-reco-content content__default"><p>SpringCloud组件预览</p> <img src="https://gitee.com/dingwanli/picture/raw/master/SpringCloud/202203112248312.png" style="zoom:80%;"> <h2 id="_1-快速入门"><a href="#_1-快速入门" class="header-anchor">#</a> 1. 快速入门</h2> <h3 id="_1-1-需求分析"><a href="#_1-1-需求分析" class="header-anchor">#</a> 1.1 需求分析</h3> <p>现在有两个模块一个支付模块一个订单模块，需求为订单模块要去调用支付模块的接口完成支付</p> <div class="spinner" style="background:rgb(66, 185, 131);" data-v-1bbcb91a></div><p><code>cloud-provider-payment8001</code>提供的接口</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/payment&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PaymentController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">PaymentServcie</span> paymentServcie<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/create&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Payment</span><span class="token punctuation">&gt;</span></span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">Payment</span> payment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> paymentServcie<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>payment<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;插入结果: &quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> i <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token string">&quot;插入成功&quot;</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token string">&quot;插入失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/get/{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Payment</span><span class="token punctuation">&gt;</span></span> <span class="token function">getPaymentById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Payment</span> payment <span class="token operator">=</span> paymentServcie<span class="token punctuation">.</span><span class="token function">getPaymentById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> payment <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token string">&quot;查询成功&quot;</span><span class="token punctuation">,</span> payment<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token string">&quot;查询失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_1-2-远程调用"><a href="#_1-2-远程调用" class="header-anchor">#</a> 1.2 远程调用</h3> <ol><li><p>订单模块中在容器中放入<code>RestTemplate</code>实例</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApplicationContextConfig</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RestTemplate</span> <span class="token function">restTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>订单模块<code>controller</code>使用<code>restTemplate</code>进行调用</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/consumer&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderController</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> PAYMENT_URL <span class="token operator">=</span> <span class="token string">&quot;http://localhost:8001&quot;</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RestTemplate</span> restTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/payment/create&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Payment</span><span class="token punctuation">&gt;</span></span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">Payment</span> payment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> restTemplate<span class="token punctuation">.</span><span class="token function">postForObject</span><span class="token punctuation">(</span>PAYMENT_URL <span class="token operator">+</span> <span class="token string">&quot;/payment/create&quot;</span><span class="token punctuation">,</span> payment<span class="token punctuation">,</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/payment/get/{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Payment</span><span class="token punctuation">&gt;</span></span> <span class="token function">getPayment</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span>PAYMENT_URL <span class="token operator">+</span> <span class="token string">&quot;/payment/get/&quot;</span> <span class="token operator">+</span> id<span class="token punctuation">,</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ol> <h2 id="_2-eureka"><a href="#_2-eureka" class="header-anchor">#</a> 2. Eureka</h2> <p><code>Eureka</code>包含两个组件：<code>Eureka Server</code>和<code>Eureka Client</code></p> <p><code>Eureak Server</code>提供服务注册服务，各个微服务节点通过配置启动后，会在<code>EurekaServer</code>中进行注册，这样<code>EurekaServer</code>中的服务注册表中存储所有可用的服务节点的信息，服务节点的信息可以在界面中直观看到。</p> <p><code>Eureka Client</code>通过注册中心进行访问，它是一个<code>java</code>客户端，用于简化<code>Eureka Server</code>的交互，客户端同时也具备一个内置的、使用轮询<code>round-robin</code>负载算法的负载均衡器。在应用启动后，将会向<code>Eureka Server</code>发送心跳(默认周期为30秒)。如果<code>Eureak Server</code>在多个心跳周期内没有接受到某个节点的心跳，<code>Eureka Server</code>将会从服务注册表中把这个服务节点移除(默认90秒)。</p> <h3 id="_2-1-eureka-server配置"><a href="#_2-1-eureka-server配置" class="header-anchor">#</a> 2.1 Eureka Server配置</h3> <ol><li><p>新建一个<code>maven</code>工程并引入如下依赖(目前工程名为<code>cloud-eureka-server7001</code>)</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-eureka-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li> <li><p><code>application.yaml</code>配置</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">7001</span>
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
    <span class="token key atrule">instance</span><span class="token punctuation">:</span>
        <span class="token comment"># eureka服务端实例名称</span>
        <span class="token key atrule">hostname</span><span class="token punctuation">:</span> localhost
    <span class="token key atrule">client</span><span class="token punctuation">:</span>
        <span class="token comment"># 不向注册中心注册自己</span>
        <span class="token key atrule">register-with-eureka</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
        <span class="token comment"># 表示自己是注册中心,不需要去检索服务</span>
        <span class="token key atrule">fetch-registry</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
        <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
            <span class="token comment"># 注册中心地址</span>
            <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//$<span class="token punctuation">{</span>eureka.instance.hostname<span class="token punctuation">}</span><span class="token punctuation">:</span>$<span class="token punctuation">{</span>server.port<span class="token punctuation">}</span>/eureka/
</code></pre></div></li> <li><p>启动类配置</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@EnableEurekaServer</span>
<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EurekaApplication</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">EurekaApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ol> <h3 id="_2-2-eureka-client配置"><a href="#_2-2-eureka-client配置" class="header-anchor">#</a> 2.2 Eureka Client配置</h3> <ol><li><p>在需要注册进<code>Eureka Server</code>的项目中添加依赖</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-eureka-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li> <li><p>并在启动类上添加注解</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@EnableEurekaClient</span>
</code></pre></div></li> <li><p>配置文件中填写<code>Eureka Server</code>的地址</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">eureka</span><span class="token punctuation">:</span>
    <span class="token key atrule">client</span><span class="token punctuation">:</span>
        <span class="token comment"># 注册EurekaServer</span>
        <span class="token key atrule">register-with-eureka</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token comment"># 抓取已在EurekaServer的注册信息,默认为true。单节点无所谓，集群必须设置为true才能配合ribbon使用负载均衡</span>
        <span class="token key atrule">fetch-registry</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
            <span class="token comment"># 注册中心地址</span>
            <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>7001/eureka/
</code></pre></div></li></ol> <h3 id="_2-2-eureka-集群"><a href="#_2-2-eureka-集群" class="header-anchor">#</a> 2.2 Eureka 集群</h3> <ol><li><p>修改<code>Eureka Server</code>配置文件</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">7001</span>
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
    <span class="token key atrule">instance</span><span class="token punctuation">:</span>
        <span class="token comment"># eureka服务端实例名称</span>
        <span class="token key atrule">hostname</span><span class="token punctuation">:</span> eureka7001.com
    <span class="token key atrule">client</span><span class="token punctuation">:</span>
        <span class="token comment"># 不向注册中心注册自己</span>
        <span class="token key atrule">register-with-eureka</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
        <span class="token comment"># 表示自己是注册中心,不需要去检索服务</span>
        <span class="token key atrule">fetch-registry</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
        <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
            <span class="token comment"># 注册中心地址</span>
            <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//eureka7002.com<span class="token punctuation">:</span>7002/eureka/
</code></pre></div><div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">7002</span>
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
    <span class="token key atrule">instance</span><span class="token punctuation">:</span>
        <span class="token comment"># eureka服务端实例名称</span>
        <span class="token key atrule">hostname</span><span class="token punctuation">:</span> eureka7002.com
    <span class="token key atrule">client</span><span class="token punctuation">:</span>
        <span class="token comment"># 不向注册中心注册自己</span>
        <span class="token key atrule">register-with-eureka</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
        <span class="token comment"># 表示自己是注册中心,不需要去检索服务</span>
        <span class="token key atrule">fetch-registry</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
        <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
            <span class="token comment"># 注册中心地址</span>
            <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//eureka7001.com<span class="token punctuation">:</span>7001/eureka/
</code></pre></div></li> <li><p>修改<code>Eureka Client</code>配置文件</p> <div class="language-java extra-class"><pre class="language-java"><code>eureka<span class="token operator">:</span>
    client<span class="token operator">:</span>
        # 注册<span class="token class-name">EurekaServer</span>
        register<span class="token operator">-</span><span class="token keyword">with</span><span class="token operator">-</span>eureka<span class="token operator">:</span> <span class="token boolean">true</span>
        # 抓取已在<span class="token class-name">EurekaServer</span>的注册信息<span class="token punctuation">,</span>默认为<span class="token boolean">true</span>。单节点无所谓，集群必须设置为<span class="token boolean">true</span>才能配合ribbon使用负载均衡
        fetch<span class="token operator">-</span>registry<span class="token operator">:</span> <span class="token boolean">true</span>
        service<span class="token operator">-</span>url<span class="token operator">:</span>
            # 注册中心地址，多个注册中心以逗号隔开或者注册任一地址即可
            defaultZone<span class="token operator">:</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>eureka7001<span class="token punctuation">.</span>com<span class="token operator">:</span><span class="token number">7001</span><span class="token operator">/</span>eureka<span class="token operator">/</span><span class="token punctuation">,</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>eureka7002<span class="token punctuation">.</span>com<span class="token operator">:</span><span class="token number">7002</span><span class="token operator">/</span>eureka<span class="token operator">/</span>
</code></pre></div></li> <li><p><code>cloud-consumer-order80</code>模块的<code>restTemplate</code>开启负载均衡功能</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApplicationContextConfig</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@LoadBalanced</span>
    <span class="token keyword">public</span> <span class="token class-name">RestTemplate</span> <span class="token function">restTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>修改<code>controller</code>的默认远程调用地址为服务名称</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/consumer&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderController</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> PAYMENT_URL <span class="token operator">=</span> <span class="token string">&quot;http://COUD-PAYMENT-SERVICE&quot;</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RestTemplate</span> restTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/payment/create&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Payment</span><span class="token punctuation">&gt;</span></span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">Payment</span> payment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> restTemplate<span class="token punctuation">.</span><span class="token function">postForObject</span><span class="token punctuation">(</span>PAYMENT_URL <span class="token operator">+</span> <span class="token string">&quot;/payment/create&quot;</span><span class="token punctuation">,</span> payment<span class="token punctuation">,</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/payment/get/{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Payment</span><span class="token punctuation">&gt;</span></span> <span class="token function">getPayment</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span>PAYMENT_URL <span class="token operator">+</span> <span class="token string">&quot;/payment/get/&quot;</span> <span class="token operator">+</span> id<span class="token punctuation">,</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>(可选)修改<code>Eureka</code>显示的主机名称</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">eureka</span><span class="token punctuation">:</span>
    <span class="token key atrule">instance</span><span class="token punctuation">:</span>
        <span class="token comment"># 实例名称</span>
        <span class="token key atrule">instance-id</span><span class="token punctuation">:</span> payment8001
        <span class="token comment"># 是否显示ip</span>
        <span class="token key atrule">prefer-ip-address</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre></div></li> <li><p>(可选)获取<code>Eureka</code>上的服务信息</p> <p>所有的信息都封装在一个<code>DiscoveryClient</code>实例中</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">DiscoveryClient</span> discoveryClient<span class="token punctuation">;</span>
</code></pre></div><p>启动类上需要添加注解</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@EnableDiscoveryClient</span>
</code></pre></div></li></ol> <h3 id="_2-3-eureka保护模式"><a href="#_2-3-eureka保护模式" class="header-anchor">#</a> 2.3 Eureka保护模式</h3> <p>保护模式主(<code>Eureka Server</code>独有)要用于一组客户端和<code>Eureka Server</code>之间存在网络分区场景下的保护。一旦进入保护模式，<code>Eureka Server</code>将会尝试保护其服务注册表中的信息，不再删除服务注册表中的信息，也就是不会注销任何服务</p> <p><code>server</code>配置</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">eureka</span><span class="token punctuation">:</span>
    <span class="token key atrule">server</span><span class="token punctuation">:</span>
        <span class="token comment"># 关闭自我保护默认开启</span>
        <span class="token key atrule">enable-self-preservation</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
        <span class="token comment"># 心跳包时间默认30s</span>
        <span class="token key atrule">eviction-interval-timer-in-ms</span><span class="token punctuation">:</span> <span class="token number">2000</span>
</code></pre></div><p><code>client</code>的配置</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">eureka</span><span class="token punctuation">:</span>
    <span class="token key atrule">instance</span><span class="token punctuation">:</span>
        <span class="token comment"># 客户端向服务端发送心跳的时间间隔：单位秒(默认30s)</span>
        <span class="token key atrule">lease-renewal-interval-in-seconds</span><span class="token punctuation">:</span> <span class="token number">1</span>
        <span class="token comment"># Eureka服务端在收到最后一次心跳后等待时间上限，单位为秒(默认90s)，超时将删除服务</span>
        <span class="token key atrule">lease-expiration-duration-in-seconds</span><span class="token punctuation">:</span> <span class="token number">2</span>
</code></pre></div><h2 id="_3-zookeeper"><a href="#_3-zookeeper" class="header-anchor">#</a> 3. Zookeeper</h2> <ol><li><p>安装，<code>Zookeeper Server</code>需要单独安装</p> <div class="language-shell extra-class"><pre class="language-shell"><code>docker run --name zookeeper -d -e <span class="token assign-left variable">TZ</span><span class="token operator">=</span><span class="token string">&quot;Asia/Shanghai&quot;</span> -p <span class="token number">2181</span>:2181 -v ~/zookeeper:/data zookeeper:3.5.9
</code></pre></div></li> <li><p><code>client</code>，在上述的例子中将<code>Eureka</code>的依赖换成<code>zookeeper</code>的依赖即可</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-zookeeper-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li> <li><p>启动类上需要添加注解</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@EnableDiscoveryClient</span>
</code></pre></div></li> <li><p>配置文件</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
    <span class="token key atrule">application</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> cloud<span class="token punctuation">-</span>provider<span class="token punctuation">-</span>payment
    <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
        <span class="token key atrule">zookeeper</span><span class="token punctuation">:</span>
            <span class="token key atrule">connect-string</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">2181</span>
</code></pre></div></li> <li><p>远程调用的方式与[上述相同](#2.2 Eureka 集群)</p></li></ol> <h2 id="_4-consul"><a href="#_4-consul" class="header-anchor">#</a> 4. Consul</h2> <h3 id="_4-1-安装"><a href="#_4-1-安装" class="header-anchor">#</a> 4.1 安装</h3> <ol><li><p>安装，<a href="https://www.consul.io/" target="_blank" rel="noopener noreferrer">官网<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p>开发者方式启动</p> <div class="language-shell extra-class"><pre class="language-shell"><code>consul agent -dev
</code></pre></div></li> <li><p>默认有一个<code>http://localhost:8500/</code>的访问地址</p></li></ol> <h3 id="_4-2-客户端"><a href="#_4-2-客户端" class="header-anchor">#</a> 4.2 客户端</h3> <ol><li><p>导入依赖</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-consul-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li> <li><p><code>application.yaml</code>配置文件</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
    <span class="token key atrule">application</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> consul<span class="token punctuation">-</span>provider<span class="token punctuation">-</span>payment
    <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
        <span class="token key atrule">consul</span><span class="token punctuation">:</span>
            <span class="token key atrule">host</span><span class="token punctuation">:</span> localhost
            <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8500</span>
            <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
                <span class="token key atrule">service-name</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>spring.application.name<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>启动类需要添加注解</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@EnableDiscoveryClient</span>
</code></pre></div></li> <li><p>远程调用的方式与[上述相同](#2.2 Eureka 集群)</p></li></ol> <h2 id="_5-ribbon"><a href="#_5-ribbon" class="header-anchor">#</a> 5. Ribbon</h2> <p><code>Spring Cloud Ribbon</code>是<code>Netflix Ribbon</code>提供的一套客户端负载均衡的工具</p> <p>简单来说，<code>Ribbon</code>是<code>Netflix</code>发布的开源项目，主要功能是提供客户端的软件负载均衡算法和服务调用。<code>Ribbon</code>客户端组件提供一系列完善的配置项如连接超时，重试等。简单来说，就是在配置文件中列出<code>Load Balancer</code>后面所有的机器，<code>Ribbon</code>会自动的帮助你基于某种规则(如简单轮询，随机连接等)去连接这些机器。我们很容易使用<code>Ribbon</code>自定义负载均衡算法</p> <p><code>LB</code>负载均衡<code>Load Balance</code>：简单的说就是将用户的请求平摊的分配到多个服务上，从而达到系统的<code>HA</code>(高可用)。常见的负载均衡有软件<code>Nginx</code>，<code>LVS</code>、硬件<code>F5</code>等</p> <p><code>Ribbon</code>本地负载均衡，在调用微服务接口的时候，会在注册中心上获取注册信息服务列表之后缓存到<code>JVM</code>本地，从而在本地实现<code>RPC</code>远程调用技术</p> <p><code>eureka</code>已经自带了<code>ribbon</code>的依赖，无需引入过多的依赖</p> <h3 id="_5-1-负载均衡算法"><a href="#_5-1-负载均衡算法" class="header-anchor">#</a> 5.1 负载均衡算法</h3> <p><code>ribbon</code>默认负载均衡算法为轮询，它自己提供了几种常用的负载均衡策略，也提供了相应的方法自定义负载均衡策略(注意所有针对负载均衡算法的改动都是针对调用端而言的)</p> <p>常用策略</p> <ol><li><code>RoundRobinRule</code>：轮询</li> <li><code>Random</code>：随机</li> <li><code>RetryRule</code>：先按照<code>RoundRobinRule</code>的策略获取服务，如果获取服务失败则在指定时间内会进行重试，获取可用的服务</li> <li><code>WeightedResponseTimeRule</code>：对<code>RoundRobinRule</code>的扩展，响应速度越快的实例选择权重越大，越容易被选择</li> <li><code>BestAvailableRule</code>：会先过滤掉由于多次访问故障而处于短路器跳闸状态的服务，然后选择一个并发量最小的服务</li> <li><code>AvailabilityFilteringRule</code>：先过滤掉故障实例，再选择并发较小的实例</li> <li><code>ZoneAvoidanceRule</code>：默认规则，复合判断<code>server</code>所在区域的性能和<code>server</code>的可用性选择服务器</li></ol> <h3 id="_5-2-修改负载均衡算法"><a href="#_5-2-修改负载均衡算法" class="header-anchor">#</a> 5.2 修改负载均衡算法</h3> <p>修改负载均衡是相当于调用端来说的</p> <ol><li><p>在调用端注入想要使用的<code>Bean</code>，注意这个类不能在<code>@ComponentScan</code>所扫描的包及其子包下</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MySelfRule</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">IRule</span> <span class="token function">mySelfRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RandomRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>在启动类上添加注解</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// name 要调用的服务名称</span>
<span class="token comment">// configuration 负载均衡算法</span>
<span class="token annotation punctuation">@RibbonClient</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;COUD-PAYMENT-SERVICE&quot;</span><span class="token punctuation">,</span> configuration <span class="token operator">=</span> <span class="token class-name">RandomRule</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
</code></pre></div></li></ol> <h3 id="_5-3-自定义负载均衡算法"><a href="#_5-3-自定义负载均衡算法" class="header-anchor">#</a> 5.3 自定义负载均衡算法</h3> <ol><li><p>修改<code>restTemplate</code>，去掉<code>@LoadBalanced</code>注解</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApplicationContextConfig</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RestTemplate</span> <span class="token function">restTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>自定义算法实现</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">LoadBalancer</span> <span class="token punctuation">{</span>
    <span class="token class-name">ServiceInstance</span> <span class="token function">instances</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">&gt;</span></span> serviceInstances<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyLB</span> <span class="token keyword">implements</span> <span class="token class-name">LoadBalancer</span><span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">AtomicInteger</span> atomicInteger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> current<span class="token punctuation">;</span>
        <span class="token keyword">int</span> next<span class="token punctuation">;</span>
        <span class="token keyword">do</span> <span class="token punctuation">{</span>
            current <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>atomicInteger<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            next <span class="token operator">=</span> current <span class="token operator">&gt;=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span>MAX_VALUE <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> current <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>atomicInteger<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> next<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ServiceInstance</span> <span class="token function">instances</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">&gt;</span></span> serviceInstances<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> index <span class="token operator">=</span>  <span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> serviceInstances<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> serviceInstances<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>使用</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/consumer&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RestTemplate</span> restTemplate<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">DiscoveryClient</span> discoveryClient<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">LoadBalancer</span> loadBalancer<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/payment/lb&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getPaymentLb</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">&gt;</span></span> instances <span class="token operator">=</span> discoveryClient<span class="token punctuation">.</span><span class="token function">getInstances</span><span class="token punctuation">(</span><span class="token string">&quot;COUD-PAYMENT-SERVICE&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>instances <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> instances<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">ServiceInstance</span> instance <span class="token operator">=</span> loadBalancer<span class="token punctuation">.</span><span class="token function">instances</span><span class="token punctuation">(</span>instances<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">URI</span> uri <span class="token operator">=</span> instance<span class="token punctuation">.</span><span class="token function">getUri</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span>uri <span class="token operator">+</span> <span class="token string">&quot;/payment/lb&quot;</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ol> <h2 id="_6-openfeign"><a href="#_6-openfeign" class="header-anchor">#</a> 6. OpenFeign</h2> <p><code>OpenFeign</code>是<code>Spring Cloud</code>在<code>Feign</code>的基础上支持了<code>SpringMVC</code>的注解，如<code>@RequestMapping</code>等，<code>OpenFeign</code>的<code>@FeignClient</code>注解可以解析<code>SpringMVC</code>的<code>@RequestMapping</code>注解下的接口，并通过动态代理的方式产生实现类，实现类中做负载均衡并调用其他服务(⭐️<code>Feign</code>针对调用端而言)</p> <h3 id="_6-1-服务调用"><a href="#_6-1-服务调用" class="header-anchor">#</a> 6.1 服务调用</h3> <ol><li><p>导入依赖</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-openfeign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li> <li><p>编写服务调用接口</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;COUD-PAYMENT-SERVICE&quot;</span><span class="token punctuation">)</span>	<span class="token comment">// name为要调用的服务名称</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">PaymentClient</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/payment/get/{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Payment</span><span class="token punctuation">&gt;</span></span> <span class="token function">getPaymentById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>主启动类上添加注解</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@EnableFeignClients</span>
</code></pre></div></li> <li><p>使用</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/consumer&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderFeignController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">PaymentClient</span> paymentClient<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/payment/get/{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Payment</span><span class="token punctuation">&gt;</span></span> <span class="token function">getPayment</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> paymentClient<span class="token punctuation">.</span><span class="token function">getPaymentById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ol> <h3 id="_6-2-超时控制"><a href="#_6-2-超时控制" class="header-anchor">#</a> 6.2 超时控制</h3> <p>默认<code>Feign</code>客户端只等待一秒钟，但是服务端处理需要超过1秒钟，导致<code>Feign</code>客户端不想等待了，直接返回报错。为了避免这样的情况，有时候我们需要设置<code>Feign</code>客户端的超时控制。</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">ribbon</span><span class="token punctuation">:</span>
    <span class="token comment"># 建立连接后从服务器读取到可用资源所能够使用的最大时间</span>
    <span class="token key atrule">ReadTimeout</span><span class="token punctuation">:</span> <span class="token number">5000</span>
    <span class="token comment"># 两端建立连接所能够使用的最大时间</span>
    <span class="token key atrule">ConnectTimeout</span><span class="token punctuation">:</span> <span class="token number">5000</span>
</code></pre></div><h3 id="_6-3-日志增强"><a href="#_6-3-日志增强" class="header-anchor">#</a> 6.3 日志增强</h3> <p><code>Feign</code>提供了日志打印功能，我们可以通过配置来调整日志级别，从而了解<code>Feign</code>中<code>Http</code>请求的细节</p> <p>总共提供了四个日志级别</p> <ol><li><code>NONE</code>：默认的，不显示任何日志</li> <li><code>BASIC</code>：仅记录请求方法、<code>URL</code>、响应状态码及执行时间</li> <li><code>HEADERS</code>：除了<code>BASIC</code>中定义的信息之外，还有请求和响应的头信息</li> <li><code>FULL</code>：除了<code>HEADERS</code>中定义的信息之外，还有请求和响应的正文及元数据</li></ol> <p>修改配置文件</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">logging</span><span class="token punctuation">:</span>
    <span class="token key atrule">level</span><span class="token punctuation">:</span>
        <span class="token comment"># 指定具体的类的日志等级</span>
        <span class="token key atrule">com.meinil.springcloud.client.PaymentClient</span><span class="token punctuation">:</span> debug
</code></pre></div><p>编写配置类</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FeignConfig</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Logger<span class="token punctuation">.</span>Level</span> <span class="token function">feignLoggerLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Logger<span class="token punctuation">.</span>Level</span><span class="token punctuation">.</span>FULL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_7-hystrix"><a href="#_7-hystrix" class="header-anchor">#</a> 7. Hystrix</h2> <p>服务雪崩</p> <p>多个微服务之间调用的时候，假设微服务A调用微服务B和微服务C，微服务B和微服务C又调用其他的微服务，这就是所谓的&quot;扇出&quot;。如果扇出的链路上某个微服务的调用响应时间过长或者不可用，对微服务A的调用就会占用越来越多的系统资源，进而引起系统崩溃，即&quot;雪崩效应&quot;</p> <p>对于高流量的应用来说，单一的后端依赖可能会导致所有服务器上的所有资源在几秒钟之内饱和。比失败更糟糕的是，这些应用程序还可能导致服务之间的延迟增加，备份队列，线程和其他系统资源紧张，导致整个系统发生更多的级联故障。这些都表示需要对故障和延迟进行隔离和管理，以便单个依赖关系的失败，不能取消整个应用程序或系统。</p> <p><code>Hystrix</code>是一个用于分布式系统的延迟和容错的开源库，在分布式系统里，许多依赖不可避免的会调用失败，比如超时、异常等，<code>Hystrix</code>能够保证在一个依赖出问题的情况下，不会导致整体服务徐失败，避免级联故障，以提高分布式系统的弹性。</p> <p>&quot;断路器&quot;本身是一种开关，当某个服务单元发生故障之后，通过断路器的故障监控(类似熔断保险丝)，向调用方返回一个符合预期的、可处理的备选响应(<code>FallBack</code>)，而不是长时间的等待或者抛出调用方无法处理的异常，这样就保证了服务调用方的线程不会被长时间、不必要地占用，从而避免了故障在分布式系统中的蔓延，乃至雪崩</p> <h3 id="_7-1-重要概念"><a href="#_7-1-重要概念" class="header-anchor">#</a> 7.1 重要概念</h3> <ol><li><p>服务降级<code>fallback</code>：当服务端出错时，不会让客户端无限等待下去，而是会立刻返回一个友好提示</p> <p>触发服务降级的情况</p> <ul><li>程序运行异常</li> <li>超时</li> <li>服务熔断触发服务降级</li> <li>线程池/信号量满载</li></ul></li> <li><p>服务熔断<code>break</code>：服务端达到最大访问量，调用服务降级的方法处理</p></li> <li><p>服务限流<code>flowlimit</code>：维持高并发操作的有序进行</p></li></ol> <h3 id="_7-2-服务降级"><a href="#_7-2-服务降级" class="header-anchor">#</a> 7.2 服务降级</h3> <p>降级分为客户端降级可服务端降级，两者所用依赖相同</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-hystrix<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h4 id="_7-2-1-服务端降级"><a href="#_7-2-1-服务端降级" class="header-anchor">#</a> 7.2.1 服务端降级</h4> <ol><li><p><code>Controller</code>层</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/payment/hystrix&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PaymentHystrixController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">PaymentHystrixService</span> paymentService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/timeout/{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">paymentError</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> paymentService<span class="token punctuation">.</span><span class="token function">paymentError</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p><code>service</code>层</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PaymentHystrixService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${server.port}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> serverPort<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@HystrixCommand</span><span class="token punctuation">(</span>fallbackMethod <span class="token operator">=</span> <span class="token string">&quot;timeoutHandler&quot;</span><span class="token punctuation">,</span> commandProperties <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@HystrixProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span><span class="token string">&quot;execution.isolation.thread.timeoutInMilliseconds&quot;</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">&quot;3000&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">paymentError</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token string">&quot;paymentError: \tThread: &quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\tserverPort: &quot;</span> <span class="token operator">+</span> serverPort <span class="token operator">+</span> <span class="token string">&quot;\tid: &quot;</span> <span class="token operator">+</span> id<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">timeoutHandler</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;paymentTimeoutHandler: \tThread: &quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\tserverPort: &quot;</span> <span class="token operator">+</span> serverPort <span class="token operator">+</span> <span class="token string">&quot;\tid: &quot;</span> <span class="token operator">+</span> id<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>HystrixCommand</code>指定了超时或者异常处理的方法<code>timeoutHandler</code></p></li> <li><p>启动类上需要添加注解</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@EnableCircuitBreaker</span>
</code></pre></div></li></ol> <h4 id="_7-2-2-客户端降级"><a href="#_7-2-2-客户端降级" class="header-anchor">#</a> 7.2.2 客户端降级</h4> <p>降级一般是客户端做⭐️</p> <ol><li><p>依赖与上述相同</p></li> <li><p>修改配置文件，开启熔断器</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">feign</span><span class="token punctuation">:</span>
    <span class="token key atrule">hystrix</span><span class="token punctuation">:</span>
        <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre></div></li> <li><p>启动类上需要添加注解</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@EnableHystrix</span>
</code></pre></div></li> <li><p>远程调用</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;CLOUD-PROVIDER-HYSTRIX-PAYMENT&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">PaymentHystrixClient</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/payment/hystrix/timeout/{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">paymentError</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p><code>Controller</code>层</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/consumer&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PaymentHystrixController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">PaymentHystrixClient</span> paymentHystrixClient<span class="token punctuation">;</span>
   
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/payment/hystrix/timeout/{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@HystrixCommand</span><span class="token punctuation">(</span>fallbackMethod <span class="token operator">=</span> <span class="token string">&quot;timeoutHandler&quot;</span><span class="token punctuation">,</span> commandProperties <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@HystrixProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span><span class="token string">&quot;execution.isolation.thread.timeoutInMilliseconds&quot;</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">&quot;1500&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">paymentError</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> paymentHystrixClient<span class="token punctuation">.</span><span class="token function">paymentError</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">timeoutHandler</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;客户端降级: \tThread: &quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\tid: &quot;</span> <span class="token operator">+</span> id<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ol> <h4 id="_7-2-3-全局统一降级"><a href="#_7-2-3-全局统一降级" class="header-anchor">#</a> 7.2.3 全局统一降级</h4> <p>以客户端为例</p> <ol><li><p>默认降级方法</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/consumer&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@DefaultProperties</span><span class="token punctuation">(</span>defaultFallback <span class="token operator">=</span> <span class="token string">&quot;globalHandler&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PaymentHystrixController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">PaymentHystrixClient</span> paymentHystrixClient<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@HystrixCommand</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/payment/hystrix/timeout/{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">paymentError</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> paymentHystrixClient<span class="token punctuation">.</span><span class="token function">paymentError</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">globalHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;全局统一降级处理&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>远程调用实现类降级</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;CLOUD-PROVIDER-HYSTRIX-PAYMENT&quot;</span><span class="token punctuation">,</span> fallback <span class="token operator">=</span> <span class="token class-name">PaymentHystrixClientFallback</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">PaymentHystrixClient</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/payment/hystrix/timeout/{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">paymentError</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PaymentHystrixClientFallback</span> <span class="token keyword">implements</span> <span class="token class-name">PaymentHystrixClient</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">paymentError</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;实现类降级&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ol> <h3 id="_7-3-服务熔断"><a href="#_7-3-服务熔断" class="header-anchor">#</a> 7.3 服务熔断</h3> <p>熔断机制是应对雪崩效应的一种微服务链路保护机制。当扇出链路的某个微服务出错不可用或者响应时间太长时，会进行服务的降级，进而熔断该节点微服务的调用，快速返回错误的响应信息。</p> <p>当检测到该节点微服务调用响应正常后，恢复调用链路。也就是熔断会直接断开服务连接，使得请求无法到达服务端，进而保护服务端，防止过载。而降级不会</p> <p>在<code>SpringCloud</code>框架里，熔断机制通过<code>Hystrix</code>实现。<code>Hystrix</code>会监视微服务调用的状况，当失败的调用到达一定阈值时，缺省是5s内20次失败，就会启动熔断机制。熔断机制的注解是<code>@HystrixCommand</code></p> <p>熔断器一般包含三个部分</p> <ul><li><p>Closed：熔断关闭不会对服务进行熔断</p></li> <li><p>Open：请求不再调用当前服务，内部设置时钟一般为<code>MTTR</code>(平均故障处理时间)，当打开时长达到所设时钟进入半熔断状态</p></li> <li><p>Half-Open：部分请求根据规则调用当前服务，如果请求成功且符合规则，则认为当前服务状态恢复正常，关闭熔断</p></li></ul> <h4 id="_7-3-1-实例演示"><a href="#_7-3-1-实例演示" class="header-anchor">#</a> 7.3.1 实例演示</h4> <ol><li><p>服务层</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PaymentHystrixService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@HystrixCommand</span><span class="token punctuation">(</span>fallbackMethod <span class="token operator">=</span> <span class="token string">&quot;paymentCircuitBreakerFallback&quot;</span><span class="token punctuation">,</span> commandProperties <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@HystrixProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;circuitBreaker.enabled&quot;</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                      <span class="token comment">// 是否开启断路器</span>
            <span class="token annotation punctuation">@HystrixProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;circuitBreaker.requestVolumeThreshold&quot;</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">&quot;10&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>         <span class="token comment">// 请求次数</span>
            <span class="token annotation punctuation">@HystrixProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;circuitBreaker.sleepWindowInMilliseconds&quot;</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">&quot;10000&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token comment">// 时间窗口期</span>
            <span class="token annotation punctuation">@HystrixProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;circuitBreaker.errorThresholdPercentage&quot;</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">&quot;60&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>       <span class="token comment">// 失败率达到多少熔断</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">paymentCircuitBreaker</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;*******id不能为负数&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token string">&quot;id: &quot;</span> <span class="token operator">+</span> id <span class="token operator">+</span> <span class="token string">&quot;\tThread: &quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\tUUID: &quot;</span> <span class="token operator">+</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">paymentCircuitBreakerFallback</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;id不能为负数,请稍后再试\tid: &quot;</span> <span class="token operator">+</span> id<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p><code>controller</code>层</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/payment/hystrix&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PaymentHystrixController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">PaymentHystrixService</span> paymentService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/breaker/{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">breaker</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Integer</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> paymentService<span class="token punctuation">.</span><span class="token function">paymentCircuitBreaker</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ol> <h3 id="_7-4-服务监控"><a href="#_7-4-服务监控" class="header-anchor">#</a> 7.4 服务监控</h3> <p>除了隔离依赖服务的调用 意外，<code>Hystrix</code>还提供了准实时的调用监控<code>Hystrix Dashboard</code>，<code>Hystrix</code>会持续地记录素哟偶通过<code>Hystrix</code>发起的请求的执行信息，并以统计报表和图形的形式展示给用户，包括每秒执行多少请求、多少成功、多少失败等。<code>Netflix</code>通过<code>hystrix-metrics-event-stream</code>项目实现了对以上指标的监控。<code>Spring Cloud</code>也提供了<code>Hystrix Dashboard</code>的整合，对监控内容转化成可视化界面</p> <ol><li><p>新建模块<code>cloud-consumer-hystrix-dashboard9001</code></p></li> <li><p>导入依赖</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-actuator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-hystrix-dashboard<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li> <li><p>启动类</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableHystrixDashboard</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HystrixDashboardApplication9001</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">HystrixDashboardApplication9001</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>被监控的项目配置</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 此配置是为了服务监控为配置，与服务容错本身无关，SpringCloud升级后的bug
 * ServletRegistrationBean因为springboot的默认路径不是&quot;/hystrix.stream&quot;
 * z只要在自己的项目中配置如下的servlet即可
 */</span>
<span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">ServletRegistrationBean</span> <span class="token function">getServlet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">HystrixMetricsStreamServlet</span> streamServlet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HystrixMetricsStreamServlet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">ServletRegistrationBean</span> registrationBean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServletRegistrationBean</span><span class="token punctuation">(</span>streamServlet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    registrationBean<span class="token punctuation">.</span><span class="token function">setLoadOnStartup</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    registrationBean<span class="token punctuation">.</span><span class="token function">addUrlMappings</span><span class="token punctuation">(</span><span class="token string">&quot;/hystrix.stream&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    registrationBean<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;HystrixMetricsStreamServlet&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> registrationBean<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>被监控的项目需要有如下的依赖</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-actuator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li> <li><p>访问测试</p> <div class="language- extra-class"><pre class="language-text"><code>http://localhost:9001/hystrix
</code></pre></div><p>输入监控的项目地址</p> <div class="language- extra-class"><pre class="language-text"><code>http://localhost:8001/hystrix.stream
</code></pre></div></li></ol> <h2 id="_8-gateway"><a href="#_8-gateway" class="header-anchor">#</a> 8. Gateway</h2> <p><code>SprngCloud Gateway</code>是<code>SpringCloud</code>的一个全新项目，基于<code>Spring5.0</code>、<code>SprngBoot2.0</code>和<code>Project Reator</code>等技术开发的网关，它旨在为微服务架构提供一种简单有效的统一的<code>API</code>路由管理方式。</p> <p><code>SpringCloud Gateway</code>作为<code>Spring Cloud</code>生态系统中的网关，目标是替代<code>Zuul</code>，在<code>Spring Cloud 2.0</code>以上版本中，没有对新版本的<code>Zuul 2.0</code>以上最新高性能版本进行集成，仍然还是使用的<code>Zuul 1.x</code>非<code>Reactor</code>模式的老版本。而为了提升网关的性能，<code>SpringCloud Gateway</code>是基于<code>WebFlux</code>框架实现的，而<code>WebFlux</code>框架底层则使用了高性能的<code>Reactor</code>模式通信框架<code>Netty</code>。</p> <p><code>Spring Cloud Gateway</code>的目标提供统一的路由方式且基于<code>Filter</code>链的方式提供了网关的基本功能，例如：安全，监控/指标和限流</p> <div class="spinner" style="background:rgb(66, 185, 131);" data-v-1bbcb91a></div><h3 id="_8-1-基本概念"><a href="#_8-1-基本概念" class="header-anchor">#</a> 8.1 基本概念</h3> <p>路由<code>Route</code>：路由是构建网关的基本模块，它由<code>ID</code>，目标<code>URI</code>，一系列的断言和过滤器组成，如果断言为<code>true</code>则匹配该路由</p> <p>断言<code>Predicate</code>：开发人员可以匹配请求中的所有内容(例如请求头或请求参数)，如果请求与断言相匹配则进行路由</p> <p>过滤<code>Filter</code>：指的是<code>Spring</code>框架中的<code>GatewayFilter</code>的实例，使用过滤器，可以在请求被路由前或者之后进行修改</p> <h3 id="_8-2-案例"><a href="#_8-2-案例" class="header-anchor">#</a> 8.2 案例</h3> <ol><li><p>新建模块<code>cloud-gateway-gateway9527</code></p></li> <li><p>导入依赖，注意：网关不能引入<code>web</code>的依赖</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-gateway<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li> <li><p>配置文件</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9527</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
    <span class="token key atrule">application</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> cloud<span class="token punctuation">-</span>gateway
    <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
        <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
            <span class="token key atrule">routes</span><span class="token punctuation">:</span>
                <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> cloud<span class="token punctuation">-</span>provider<span class="token punctuation">-</span>payment1   <span class="token comment"># 路由的id,没有固定规则但要求唯一,建议配合服务名使用</span>
                  <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token number">8001</span>    <span class="token comment"># 匹配后提供服务的路由地址</span>
                  <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
                      <span class="token punctuation">-</span> Path=/payment/get/<span class="token important">**</span>    <span class="token comment"># 断言,路径相匹配的进行路由</span>

                <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> cloud<span class="token punctuation">-</span>provider<span class="token punctuation">-</span>payment2   <span class="token comment"># 路由的id,没有固定规则但要求唯一,建议配合服务名使用</span>
                  <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token number">8001</span>    <span class="token comment"># 匹配后提供服务的路由地址</span>
                  <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
                      <span class="token punctuation">-</span> Path=/payment/lb/<span class="token important">**</span>     <span class="token comment"># 断言,路径相匹配的进行路由</span>
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
    <span class="token key atrule">client</span><span class="token punctuation">:</span>
        <span class="token key atrule">register-with-eureka</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">fetch-registry</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
            <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//eureka7001.com<span class="token punctuation">:</span>7001/eureka/<span class="token punctuation">,</span> http<span class="token punctuation">:</span>//eureka7002.com<span class="token punctuation">:</span>7002/eureka/
</code></pre></div></li> <li><p>代码方式配置</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GatewayConfig</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RouteLocator</span> <span class="token function">routes</span><span class="token punctuation">(</span><span class="token class-name">RouteLocatorBuilder</span> builder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> builder
                <span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span>
                        <span class="token string">&quot;path&quot;</span><span class="token punctuation">,</span>
                        r <span class="token operator">-&gt;</span> r<span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span><span class="token string">&quot;/guonei&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">uri</span><span class="token punctuation">(</span><span class="token string">&quot;http://news.baidu.com/guonei&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ol> <h3 id="_8-3-动态路由"><a href="#_8-3-动态路由" class="header-anchor">#</a> 8.3 动态路由</h3> <p>修改配置文件即可</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9527</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
    <span class="token key atrule">application</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> cloud<span class="token punctuation">-</span>gateway
    <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
        <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
        	<span class="token key atrule">discovery</span><span class="token punctuation">:</span>
                <span class="token key atrule">locator</span><span class="token punctuation">:</span>
                    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>               <span class="token comment"># 开启从注册中心动态创建路由的功能,利用微服务名进行路由</span>
            <span class="token key atrule">routes</span><span class="token punctuation">:</span>
                <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> cloud<span class="token punctuation">-</span>provider<span class="token punctuation">-</span>payment1   <span class="token comment"># 路由的id,没有固定规则但要求唯一,建议配合服务名使用</span>
                  <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//cloud<span class="token punctuation">-</span>provider<span class="token punctuation">-</span>payment
                  <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
                      <span class="token punctuation">-</span> Path=/payment/get/<span class="token important">**</span>    <span class="token comment"># 断言,路径相匹配的进行路由</span>

                <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> cloud<span class="token punctuation">-</span>provider<span class="token punctuation">-</span>payment2   <span class="token comment"># 路由的id,没有固定规则但要求唯一,建议配合服务名使用</span>
                  <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//cloud<span class="token punctuation">-</span>provider<span class="token punctuation">-</span>payment
                  <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
                      <span class="token punctuation">-</span> Path=/payment/lb/<span class="token important">**</span>     <span class="token comment"># 断言,路径相匹配的进行路由</span>

<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
    <span class="token key atrule">client</span><span class="token punctuation">:</span>
        <span class="token key atrule">register-with-eureka</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">fetch-registry</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
            <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//eureka7001.com<span class="token punctuation">:</span>7001/eureka/<span class="token punctuation">,</span> http<span class="token punctuation">:</span>//eureka7002.com<span class="token punctuation">:</span>7002/eureka/
</code></pre></div><h3 id="_8-4-断言"><a href="#_8-4-断言" class="header-anchor">#</a> 8.4 断言</h3> <p><code>Spring Cloud Gateway</code>将路由匹配作为<code>Spring WebFlux HandlerMapping</code>基础架构的一部分。<code>Spring Cloud GateWay</code>包括许多内置的<code>Route Predicate</code>工厂。素有这些<code>Predicate</code>都与<code>HTTP</code>请求的不同属性匹配。多个<code>Route Predicate</code>工厂可以进行组合</p> <p><code>Spring Cloud Gateway</code>创建<code>Route</code>对象时，使用<code>RoutePredicateFactory</code>创建<code>Predicate</code>对象，<code>Predicate</code>对象可以赋值给<code>Route</code>。<code>Spring Cloud Gateway</code>包含许多内置的<code>Route Predicate Factories</code></p> <p>所有这些谓词都匹配<code>HTTP</code>请求的不同属性。多种谓词工厂可以组合，并通过逻辑<code>and</code></p> <ol><li><p>在什么时间之后有效</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">predicates</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> Path=/payment/lb/<span class="token important">**</span>     
    <span class="token punctuation">-</span> After=2022<span class="token punctuation">-</span>03<span class="token punctuation">-</span>13T22<span class="token punctuation">:</span>40<span class="token punctuation">:</span>32.588+08<span class="token punctuation">:</span>00<span class="token punctuation">[</span>Asia/Shanghai<span class="token punctuation">]</span>
</code></pre></div></li> <li><p>在什么时间之前有效</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">predicates</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> Path=/payment/lb/<span class="token important">**</span>     
    <span class="token punctuation">-</span> Before=2022<span class="token punctuation">-</span>03<span class="token punctuation">-</span>13T22<span class="token punctuation">:</span>40<span class="token punctuation">:</span>32.588+08<span class="token punctuation">:</span>00<span class="token punctuation">[</span>Asia/Shanghai<span class="token punctuation">]</span>
</code></pre></div></li> <li><p>在什么时间之间有效</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">predicates</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> Path=/payment/lb/<span class="token important">**</span> 
    <span class="token punctuation">-</span> Between=2022<span class="token punctuation">-</span>03<span class="token punctuation">-</span>13T22<span class="token punctuation">:</span>40<span class="token punctuation">:</span>32.588+08<span class="token punctuation">:</span>00<span class="token punctuation">[</span>Asia/Shanghai<span class="token punctuation">]</span><span class="token punctuation">,</span> 2022<span class="token punctuation">-</span>03<span class="token punctuation">-</span>13T22<span class="token punctuation">:</span>50<span class="token punctuation">:</span>32.588+08<span class="token punctuation">:</span>00<span class="token punctuation">[</span>Asia/Shanghai<span class="token punctuation">]</span>
</code></pre></div></li> <li><p><code>cookie</code></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">predicates</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> Path=/payment/lb/<span class="token important">**</span> 
    <span class="token punctuation">-</span> Cookie=cookieName<span class="token punctuation">,</span> RegExp
</code></pre></div><p>第一个参数为cookie名称，第二个为正则表达式</p></li> <li><p>请求头</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">predicates</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> Path=/payment/lb/<span class="token important">**</span> 
    <span class="token punctuation">-</span> Header=Authorization<span class="token punctuation">,</span> \d+
</code></pre></div></li> <li><p>限制主机请求</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">predicates</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> Path=/payment/lb/<span class="token important">**</span> 
	<span class="token punctuation">-</span> Host=<span class="token important">**.example.com</span>
</code></pre></div></li> <li><p>限定请求方法</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">predicates</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> Path=/payment/lb/<span class="token important">**</span> 
	<span class="token punctuation">-</span> Method=GET<span class="token punctuation">,</span>POST
</code></pre></div></li> <li><p>请求参数</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">predicates</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> Path=/payment/lb/<span class="token important">**</span> 
    <span class="token punctuation">-</span> Query=username<span class="token punctuation">,</span> \d+
</code></pre></div></li></ol> <h3 id="_8-5-filter"><a href="#_8-5-filter" class="header-anchor">#</a> 8.5 Filter</h3> <p>路由过滤器可用与修改进入的<code>HTTP</code>请求和返回的<code>HTTP</code>响应，路由过滤器只指定路由进行使用。<code>Spring Cloud Gateway</code>内置了多种路由过滤器，它们都由<code>GatewayFilter</code>的工厂类产生</p> <p>过滤器的配置与断言相似，<a href="https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#gatewayfilter-factories" target="_blank" rel="noopener noreferrer">过滤器配置参考<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">filters</span><span class="token punctuation">:</span>
	<span class="token punctuation">-</span> AddRequestHeader=X<span class="token punctuation">-</span>Request<span class="token punctuation">-</span>red<span class="token punctuation">,</span> blue
</code></pre></div><p>这个配置会在所有的请求上添加一个请求头</p> <p>自定义过滤器</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LogGlobalFilter</span> <span class="token keyword">implements</span> <span class="token class-name">GlobalFilter</span><span class="token punctuation">,</span> <span class="token class-name">Ordered</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">GatewayFilterChain</span> chain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;===========拦截请求=============&quot;</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> uname <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getQueryParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFirst</span><span class="token punctuation">(</span><span class="token string">&quot;uname&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>uname <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> uname<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;===========非法用户===========&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 不通过返回</span>
            <span class="token keyword">return</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 验证通过放行</span>
        <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_9-config"><a href="#_9-config" class="header-anchor">#</a> 9. Config</h2> <div class="spinner" style="background:rgb(66, 185, 131);" data-v-1bbcb91a></div><h3 id="_9-1-理论知识"><a href="#_9-1-理论知识" class="header-anchor">#</a> 9.1 理论知识</h3> <p><code>SpringCloud Config</code>为微服务架构中的微服务提供集中化的外部配置支持，配置服务器为各个不同微服务应用的所有环境提供了一个中心化的外部配置</p> <p><code>SpringCloud Config</code>分为服务端和客户端两部分。</p> <p>服务端也称为分布式配置中心，它是一个独立的微服务应用，用来连接服务器并为客户端提供获取配置信息，加密/解密信息等访问接口</p> <p>客户端则通过指定的配置中心来管理应用资源，以及与业务相关的配置内容，并在启动的时候从配置中心获取和加载配置信息配置服务器默认采用git来存储配置信息，这样就有助于对环境进行版本管理，并且可以通过git客户端工具来方便的管理和访问配置内容</p> <h3 id="_9-2-服务端搭建"><a href="#_9-2-服务端搭建" class="header-anchor">#</a> 9.2 服务端搭建</h3> <ol><li><p>在<a href="https://github.com" target="_blank" rel="noopener noreferrer">github<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>上新建一个仓库，有如下目录结构</p> <div class="language- extra-class"><pre class="language-text"><code>config-dev.yaml
config-test.yaml
config-prod.yaml
</code></pre></div></li> <li><p>新建模块<code>cloud-config-center3344</code></p></li> <li><p>导入依赖</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-config-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li> <li><p>配置文件</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3344</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
    <span class="token key atrule">application</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> cloud<span class="token punctuation">-</span>config<span class="token punctuation">-</span>center
    <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
        <span class="token key atrule">config</span><span class="token punctuation">:</span>
            <span class="token key atrule">server</span><span class="token punctuation">:</span>
                <span class="token key atrule">git</span><span class="token punctuation">:</span>
                    <span class="token key atrule">uri</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//github.com/xxx/springcloud<span class="token punctuation">-</span>config.git       <span class="token comment"># 远程仓库地址</span>
                    <span class="token key atrule">search-paths</span><span class="token punctuation">:</span> springcloud<span class="token punctuation">-</span>config                         <span class="token comment"># 配置文件所在目录</span>
            <span class="token key atrule">label</span><span class="token punctuation">:</span> main                                                  	 <span class="token comment"># 分支名</span>
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
    <span class="token key atrule">client</span><span class="token punctuation">:</span>
        <span class="token key atrule">register-with-eureka</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">fetch-registry</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
            <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//eureka7001.com<span class="token punctuation">:</span>7001/eureka/
</code></pre></div></li> <li><p>启动类</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@EnableConfigServer</span>
<span class="token annotation punctuation">@EnableEurekaClient</span>
<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConfigCenterApplication3344</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">ConfigCenterApplication3344</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>测试</p> <div class="language- extra-class"><pre class="language-text"><code>http://localhost:3344/main/config-dev.yaml
http://localhost:3344/main/config-test.yaml
http://localhost:3344/main/config-prod.yaml
</code></pre></div></li></ol> <h3 id="_9-3-客户端搭建"><a href="#_9-3-客户端搭建" class="header-anchor">#</a> 9.3 客户端搭建</h3> <ol><li><p>新建模块<code>cloud-config-client3355</code></p></li> <li><p>导入依赖</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-config-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li> <li><p>新建一个<code>bootstrap.yaml</code></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3355</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
    <span class="token key atrule">application</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> cloud<span class="token punctuation">-</span>config<span class="token punctuation">-</span>client
    <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
        <span class="token key atrule">config</span><span class="token punctuation">:</span>
            <span class="token key atrule">label</span><span class="token punctuation">:</span> main                 <span class="token comment"># 分支名称</span>
            <span class="token key atrule">name</span><span class="token punctuation">:</span> config                <span class="token comment"># 配置文件名称</span>
            <span class="token key atrule">profile</span><span class="token punctuation">:</span> dev                <span class="token comment"># 环境</span>
            <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token number">3344</span>  <span class="token comment"># 配置中心地址</span>
            <span class="token comment"># 自动拼接为 http://localhost:3344/main/config-dev.yaml</span>
</code></pre></div></li></ol> <p>这样会存在一个问题，虽然我们能够读取配置中心的文件，但是它不会动态刷新，每次修改配置文件都要重启客户端(服务端无影响)</p> <p>需要如下配置</p> <ol><li><p>导入依赖</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-actuator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li> <li><p>修改<code>bootstrap.yaml</code></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">management</span><span class="token punctuation">:</span>
    <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>
        <span class="token key atrule">web</span><span class="token punctuation">:</span>
            <span class="token key atrule">exposure</span><span class="token punctuation">:</span>
                <span class="token key atrule">include</span><span class="token punctuation">:</span> <span class="token string">&quot;*&quot;</span>
</code></pre></div></li> <li><p>在需要动态刷新的组件上添加注解</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RefreshScope</span>
</code></pre></div></li> <li><p>向客户端发送一个<code>POST</code>请求</p> <div class="language- extra-class"><pre class="language-text"><code>curl -X POST &quot;http://localhost:3355/actuator/refresh&quot;
</code></pre></div></li></ol> <h2 id="_10-bus"><a href="#_10-bus" class="header-anchor">#</a> 10. BUS</h2> <p><code>SpringCloud Bus</code>配合<code>Spring Cloud Config</code>使用可以实现配置的动态刷新</p> <p><code>SpringCloud Bus</code>是用来将分布式系统的节点与轻量级消息系统连接起来的框架，它整合了<code>Java</code>时间处理机制和消息中间件的功能。<code>SpringCloud Bus</code>目前支持<code>RabbitMQ</code>和<code>Kafka</code></p> <h3 id="_10-1-基本概念"><a href="#_10-1-基本概念" class="header-anchor">#</a> 10.1 基本概念</h3> <p>总线：在微服务架构的系统中，通常会使用轻量级的消息代理来构建一个共用的消息主题，并让系统中素有微服务实例都连接上来。由于该主题中产生的消息会被所有实例监听和浪费，所以称为消息总线。在总线上的各个实例，都可以方便地广播一些需要让其他连接在该主题上的实例都知道的消息</p> <p>基本原理：<code>ConfigClient</code>实例都监听<code>MQ</code>中同一个<code>topic</code>(默认是<code>SpringCloudBus</code>).当一个服务刷新数据的时候，它会把这个信息放入到<code>Topic</code>中，这样其他监听同一个<code>Topic</code>的服务就能得到通知，然后更新自身的配置</p> <p>两种不同的方式触发</p> <ol><li>客户端变动，导致整体变动</li></ol> <img src="https://gitee.com/dingwanli/picture/raw/master/SpringCloud/202203141615782.png" style="zoom:80%;"> <ol start="2"><li>配置中心变动，导致整体变动</li></ol> <img src="https://gitee.com/dingwanli/picture/raw/master/SpringCloud/202203141617217.png" style="zoom:80%;"> <p>显然第二种架构更为合适</p> <h3 id="_10-2-rabbitmq"><a href="#_10-2-rabbitmq" class="header-anchor">#</a> 10.2 RabbitMQ</h3> <ol><li><p>安装<a href="https://www.erlang.org/downloads" target="_blank" rel="noopener noreferrer">Erlang<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，<code>RabbitMQ</code>依赖<code>Erlang</code>，记得配置<code>ERLANG_HOME</code></p></li> <li><p>安装<a href="https://github.com/rabbitmq/rabbitmq-server/releases/" target="_blank" rel="noopener noreferrer">RabbitMQ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p>进入安装目录的<code>sbin</code>，执行如下命令</p> <div class="language-shell extra-class"><pre class="language-shell"><code>rabbitmq-plugins <span class="token builtin class-name">enable</span> rabbitmq_management
</code></pre></div></li> <li><p>启动<code>RabbitMQ</code></p> <div class="language-shell extra-class"><pre class="language-shell"><code>rabbitmq-server.bat
</code></pre></div></li> <li><p>访问测试</p> <div class="language- extra-class"><pre class="language-text"><code>http://localhost:15672/
</code></pre></div><p>默认用户名密码为<code>guest</code></p></li></ol> <h3 id="_10-3-案例演示"><a href="#_10-3-案例演示" class="header-anchor">#</a> 10.3 案例演示</h3> <p>目前需要完成的功能</p> <div class="spinner" style="background:rgb(66, 185, 131);" data-v-1bbcb91a></div><ol><li><p>配置中心以及被推送的模块都需要此依赖</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-bus-amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-actuator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li> <li><p>添加相关配置</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
    <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> localhost
        <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5672</span>
        <span class="token key atrule">username</span><span class="token punctuation">:</span> guest
        <span class="token key atrule">password</span><span class="token punctuation">:</span> guest
<span class="token comment"># 这个仅需配置中心配置</span>
<span class="token key atrule">management</span><span class="token punctuation">:</span>
    <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>
        <span class="token key atrule">web</span><span class="token punctuation">:</span>
            <span class="token key atrule">exposure</span><span class="token punctuation">:</span>
                <span class="token key atrule">include</span><span class="token punctuation">:</span> <span class="token string">&quot;bus-refresh&quot;</span>
</code></pre></div></li> <li><p>给配置中心发送一次<code>POST</code>请求，便会通知所有的客户端</p> <div class="language- extra-class"><pre class="language-text"><code>curl -X POST http://localhost:3344/actuator/bus-refresh
</code></pre></div></li> <li><p>定点通知，仅通知某一个客户端</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">curl</span> -X POST http://localhost:3344/actuator/bus-refresh/<span class="token punctuation">{</span>destination<span class="token punctuation">}</span>
</code></pre></div><p><code>destination</code>为</p> <div class="language- extra-class"><pre class="language-text"><code>服务名:端口号
</code></pre></div></li></ol> <h2 id="_11-stream"><a href="#_11-stream" class="header-anchor">#</a> 11. Stream</h2> <p>消息驱动：屏蔽底层消息中间件的差异，降低切换成本，统一消息的编程模型</p> <p>应用程序通过<code>inputs</code>或者<code>outputs</code>来与<code>Spring Cloud Stream</code>中<code>binder</code>对象交互。通过我们配置来绑定<code>binding</code>，而<code>Spring Cloud Stream</code>的<code>binder</code>对象负责与消息中间件交互。所以，我们只需要搞清楚如何与<code>Spring Cloud Stream</code>交互就可以方便使用消息驱动方式</p> <p>通过使用<code>Spring Integration</code>来连接消息代理中间件以实现消息事件驱动。<code>Spring Cloud Stream</code>为一些供应商的消息中间件产品提供了个性化的自动化配置实现，引用了发布-订阅、消费组、分区的三个核心概念。</p> <p>目前仅支持<code>RabbitMQ</code>、<code>Kafka</code></p> <h3 id="_11-1-常用概念"><a href="#_11-1-常用概念" class="header-anchor">#</a> 11.1 常用概念</h3> <center><img src="https://gitee.com/dingwanli/picture/raw/master/SpringCloud/202203151618257.png" style="border-radius:0.3125em;box-shadow:0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);"> <br> <div style="color:#999;border-bottom:1px solid #d9d9d9;display:inline-block;padding:2px;zoom:80%;">
        流程图	   
    </div></center> <ol><li><code>Binder</code>：用于连接各种中间件，屏蔽差异</li> <li><code>Channel</code>：通道，是队列<code>Queue</code>的一种抽象，在消息通讯系统中就是实现存储和转发的媒介，通过<code>Channel</code>对队列进行配置</li> <li><code>Source</code>和<code>Sink</code>：简单的可理解为参照对象是<code>Spring Cloud Stream</code>自身，从<code>Stream</code>发布消息就是输出，接受消息就是输入</li></ol> <center><img src="https://gitee.com/dingwanli/picture/raw/master/SpringCloud/202203151626406.png" style="border-radius:0.3125em;box-shadow:0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);"> <br> <div style="color:#999;border-bottom:1px solid #d9d9d9;display:inline-block;padding:2px;">
        架构图	   
    </div></center> <table><thead><tr><th>组成</th> <th>说明</th></tr></thead> <tbody><tr><td>Middleware</td> <td>中间件,目前仅支持Kafka</td></tr> <tr><td>Binder</td> <td>Binder是应用与消息中间件之间的封装，目前实现了Kafka和RabbitMQ的Binder，通过Binder可以很方便的连接中间件，可以动态的改变消息类型(对应于Kafka的topic，RabbitMQ的exchange)，这些都可以通过配置文件来实现</td></tr> <tr><td>@Input</td> <td>注解标识输入通道，通过该输入通道接受到的消息进入应用程序</td></tr> <tr><td>@Output</td> <td>注解标识输出通道，发布的消息将通过该通道离开应用程序</td></tr> <tr><td>@StreamListener</td> <td>监听队列，用于消费者的队列的消息接受</td></tr> <tr><td>@EnableBinding</td> <td>指信道和exchange绑定在一起</td></tr></tbody></table> <h3 id="_11-2-生产者"><a href="#_11-2-生产者" class="header-anchor">#</a> 11.2 生产者</h3> <p>此次案例采用<code>rabbitmq</code></p> <ol><li><p>新建模块<code>cloud-stream-rabbitmq-provider8801</code></p></li> <li><p>导入依赖</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-actuator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-eureka-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-stream-rabbit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li> <li><p>配置文件</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8801</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
    <span class="token key atrule">application</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> cloud<span class="token punctuation">-</span>stream<span class="token punctuation">-</span>provider
    <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
        <span class="token key atrule">stream</span><span class="token punctuation">:</span>
            <span class="token key atrule">binders</span><span class="token punctuation">:</span>                <span class="token comment"># 此处配置要绑定的rabbitmq的服务信息</span>
                <span class="token key atrule">defaultRabbit</span><span class="token punctuation">:</span>      <span class="token comment"># 表示定义的名称,用于binding整合</span>
                    <span class="token key atrule">type</span><span class="token punctuation">:</span> rabbit    <span class="token comment"># 消息组件类型</span>
                    <span class="token key atrule">environment</span><span class="token punctuation">:</span>    <span class="token comment"># rabbitmq的相关环境配置</span>
                        <span class="token key atrule">spring</span><span class="token punctuation">:</span>
                            <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span>
                                <span class="token key atrule">host</span><span class="token punctuation">:</span> localhost
                                <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5672</span>
                                <span class="token key atrule">username</span><span class="token punctuation">:</span> guest
                                <span class="token key atrule">password</span><span class="token punctuation">:</span> guest
            <span class="token key atrule">bindings</span><span class="token punctuation">:</span>                               <span class="token comment"># 服务的整合处理</span>
                <span class="token key atrule">output</span><span class="token punctuation">:</span>                             <span class="token comment"># 一个通道的名称</span>
                    <span class="token key atrule">destination</span><span class="token punctuation">:</span> studyExchange      <span class="token comment"># 要使用的Exchange名称定义</span>
                    <span class="token key atrule">content-type</span><span class="token punctuation">:</span> application/json  <span class="token comment"># 设置消息类型,本次为json,文本则设置为 text/plain</span>
                    <span class="token key atrule">binder</span><span class="token punctuation">:</span> defaultRabbit           <span class="token comment"># 设置要绑定的消息服务的具体配置</span>
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
    <span class="token key atrule">client</span><span class="token punctuation">:</span>
        <span class="token key atrule">register-with-eureka</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">fetch-registry</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
            <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//eureka7001.com<span class="token punctuation">:</span>7001/eureka/
</code></pre></div></li> <li><p><code>service</code>层</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MessageProvider</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@EnableBinding</span><span class="token punctuation">(</span><span class="token class-name">Source</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>        <span class="token comment">// 消息推送的管道</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MessageProviderImpl</span> <span class="token keyword">implements</span> <span class="token class-name">MessageProvider</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">MessageChannel</span> output<span class="token punctuation">;</span>  <span class="token comment">// 消息发送管道</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> content <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        output<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">MessageBuilder</span><span class="token punctuation">.</span><span class="token function">withPayload</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p><code>controller</code>层</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SendMessageController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">MessageProvider</span> provider<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/sendMessage&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> provider<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ol> <h3 id="_11-3-消费者"><a href="#_11-3-消费者" class="header-anchor">#</a> 11.3 消费者</h3> <ol><li><p>新建模块<code>cloud-stream-rabbitmq-consumer8802</code></p></li> <li><p>导入依赖</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-actuator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-eureka-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-stream-rabbit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li> <li><p>配置文件</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code> <span class="token key atrule">server</span><span class="token punctuation">:</span>
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8802</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
    <span class="token key atrule">application</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> cloud<span class="token punctuation">-</span>stream<span class="token punctuation">-</span>consumer
    <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
        <span class="token key atrule">stream</span><span class="token punctuation">:</span>
            <span class="token key atrule">binders</span><span class="token punctuation">:</span>                <span class="token comment"># 此处配置要绑定的rabbitmq的服务信息</span>
                <span class="token key atrule">defaultRabbit</span><span class="token punctuation">:</span>      <span class="token comment"># 表示定义的名称,用于binding整合</span>
                    <span class="token key atrule">type</span><span class="token punctuation">:</span> rabbit    <span class="token comment"># 消息组件类型</span>
                    <span class="token key atrule">environment</span><span class="token punctuation">:</span>    <span class="token comment"># rabbitmq的相关环境配置</span>
                        <span class="token key atrule">spring</span><span class="token punctuation">:</span>
                            <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span>
                                <span class="token key atrule">host</span><span class="token punctuation">:</span> localhost
                                <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5672</span>
                                <span class="token key atrule">username</span><span class="token punctuation">:</span> guest
                                <span class="token key atrule">password</span><span class="token punctuation">:</span> guest
            <span class="token key atrule">bindings</span><span class="token punctuation">:</span>                               <span class="token comment"># 服务的整合处理</span>
                <span class="token key atrule">input</span><span class="token punctuation">:</span>                             	<span class="token comment"># 一个通道的名称</span>
                    <span class="token key atrule">destination</span><span class="token punctuation">:</span> studyExchange      <span class="token comment"># 要使用的Exchange名称定义</span>
                    <span class="token key atrule">content-type</span><span class="token punctuation">:</span> application/json  <span class="token comment"># 设置消息类型,本次为json,文本则设置为 text/plain</span>
                    <span class="token key atrule">binder</span><span class="token punctuation">:</span> defaultRabbit           <span class="token comment"># 设置要绑定的消息服务的具体配置</span>
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
    <span class="token key atrule">client</span><span class="token punctuation">:</span>
        <span class="token key atrule">register-with-eureka</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">fetch-registry</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
            <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//eureka7001.com<span class="token punctuation">:</span>7001/eureka/
</code></pre></div></li> <li><p>接受消息</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@EnableBinding</span><span class="token punctuation">(</span><span class="token class-name">Sink</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MessageReceiverController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${server.port}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> serverPort<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@StreamListener</span><span class="token punctuation">(</span><span class="token class-name">Sink</span><span class="token punctuation">.</span>INPUT<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">input</span><span class="token punctuation">(</span><span class="token class-name">Message</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;消费者%s, 接受到的消息为: %s\n&quot;</span><span class="token punctuation">,</span> serverPort<span class="token punctuation">,</span> message<span class="token punctuation">.</span><span class="token function">getPayload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果在生产者侧推送消息，则该组件会接收到推送的消息</p></li></ol> <h3 id="_11-4-分组"><a href="#_11-4-分组" class="header-anchor">#</a> 11.4 分组</h3> <p>上述的案例中，如果消费者是集群部署的话，则会出现生产者推送一个消息，被所有消费者接收到，实际情况中我们需要避免这个问题</p> <p>在<code>Stream</code>中处于同一个<code>group</code>中的多个消费者是竞争关系，就够保证消息只会被其中一个应用消费一次</p> <p>分组只需在配置文件中修改</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8803</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
    <span class="token key atrule">application</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> cloud<span class="token punctuation">-</span>stream<span class="token punctuation">-</span>consumer
    <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
        <span class="token key atrule">stream</span><span class="token punctuation">:</span>
            <span class="token key atrule">binders</span><span class="token punctuation">:</span>                <span class="token comment"># 此处配置要绑定的rabbitmq的服务信息</span>
                <span class="token key atrule">defaultRabbit</span><span class="token punctuation">:</span>      <span class="token comment"># 表示定义的名称,用于binding整合</span>
                    <span class="token key atrule">type</span><span class="token punctuation">:</span> rabbit    <span class="token comment"># 消息组件类型</span>
                    <span class="token key atrule">environment</span><span class="token punctuation">:</span>    <span class="token comment"># rabbitmq的相关环境配置</span>
                        <span class="token key atrule">spring</span><span class="token punctuation">:</span>
                            <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span>
                                <span class="token key atrule">host</span><span class="token punctuation">:</span> localhost
                                <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5672</span>
                                <span class="token key atrule">username</span><span class="token punctuation">:</span> guest
                                <span class="token key atrule">password</span><span class="token punctuation">:</span> guest
            <span class="token key atrule">bindings</span><span class="token punctuation">:</span>                               <span class="token comment"># 服务的整合处理</span>
                <span class="token key atrule">input</span><span class="token punctuation">:</span>                             <span class="token comment"># 一个通道的名称</span>
                    <span class="token key atrule">destination</span><span class="token punctuation">:</span> studyExchange      <span class="token comment"># 要使用的Exchange名称定义</span>
                    <span class="token key atrule">content-type</span><span class="token punctuation">:</span> application/json  <span class="token comment"># 设置消息类型,本次为json,文本则设置为 text/plain</span>
                    <span class="token key atrule">binder</span><span class="token punctuation">:</span> defaultRabbit           <span class="token comment"># 设置要绑定的消息服务的具体配置</span>
                    <span class="token key atrule">group</span><span class="token punctuation">:</span> MessageA                 <span class="token comment"># 分组</span>
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
    <span class="token key atrule">client</span><span class="token punctuation">:</span>
        <span class="token key atrule">register-with-eureka</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">fetch-registry</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
            <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//eureka7001.com<span class="token punctuation">:</span>7001/eureka/
</code></pre></div><p>添加分组后，消息会自动持久化，即如果服务重启，在服务重启期间生产者的消息会在服务上线之后继续推送</p> <h2 id="_12-sleuth"><a href="#_12-sleuth" class="header-anchor">#</a> 12. Sleuth</h2> <p>分布式请求链路追踪：在微服务框架中，一个由客户端发起的请求在后端系统中会多个不同的服务节点调用来协同产生最后的请求结果，每一个前段请求都会形成一条复杂的分布式服务调用链路，链路中的任何一环出现高延时或错误都会引起整个请求最后的失败</p> <ol><li><p>下载<a href="https://repo1.maven.org/maven2/io/zipkin/zipkin-server/" target="_blank" rel="noopener noreferrer">zipkin-server<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p><code>zipkin-server</code>是一个可执行<code>jar</code>包，直接执行即可</p></li> <li><p>访问测试</p> <div class="language- extra-class"><pre class="language-text"><code>http://127.0.0.1:9411/
</code></pre></div></li> <li><p>被监控的服务需要引入依赖</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-zipkin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>配置文件修改</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
    <span class="token key atrule">zipkin</span><span class="token punctuation">:</span>
        <span class="token key atrule">base-url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token number">9411</span>
    <span class="token key atrule">sleuth</span><span class="token punctuation">:</span>
      <span class="token key atrule">sampler</span><span class="token punctuation">:</span>
          <span class="token key atrule">probability</span><span class="token punctuation">:</span> <span class="token number">1</span>    <span class="token comment"># 采样率值介于0到1之间，1表示全部采集</span>
</code></pre></div></li></ol> <h2 id="_13-nacos"><a href="#_13-nacos" class="header-anchor">#</a> 13. Nacos</h2> <p><a href="https://nacos.io/zh-cn/" target="_blank" rel="noopener noreferrer">官方网站<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><code>Nacos</code>支持<code>AP</code>和<code>CP</code>模式的切换</p> <p><code>C</code>代表所有节点在同一时间看到的数据是一致的；而<code>A</code>的定义是所有的请求都会收到响应</p> <p>一般来说如果不需要存储服务级别的信息且服务实例是通过<code>nacos-client</code>注册，并能够保持心跳上报，那么就可以选择<code>AP</code>模式。当前主流的服务如<code>Spring Cloud</code>和<code>Dubbo</code>服务，都适用于<code>AP</code>模式，<code>AP</code>模式为了服务的可能性而减弱了一致性，因此<code>AP</code>模式下只支持注册临时实例。</p> <p>如果需要在服务级别编辑或者存储配置信息，那么<code>CP</code>是必须的，<code>K8S</code>和<code>DNS</code>服务则适用于<code>CP</code>模式。</p> <p><code>CP</code>模式下支持注册持久化实例，此时则以<code>Raft</code>协议为集群运行模式，该模式下注册实例之前必须先注册服务，如果服务不存在，则会返回错误</p> <h3 id="_13-1-注册中心"><a href="#_13-1-注册中心" class="header-anchor">#</a> 13.1 注册中心</h3> <ol><li><p>父工程中导入依赖</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.2.2.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li> <li><p>新建一个模块<code>cloud-alibaba-provider-payment9001</code></p></li> <li><p>导入依赖</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li> <li><p>修改配置文件</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9001</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
    <span class="token key atrule">application</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>provider<span class="token punctuation">-</span>payment
    <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
        <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
            <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
                <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span>	<span class="token comment"># nacos的地址</span>
</code></pre></div></li></ol> <p>提示：远程调用可以使用<code>OpenFeign</code></p> <h3 id="_13-2-配置中心"><a href="#_13-2-配置中心" class="header-anchor">#</a> 13.2 配置中心</h3> <ol><li><p>新建一个模块<code>cloud-alibaba-config-nacos-client3377</code></p></li> <li><p>导入依赖</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-config<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li> <li><p>编写配置文件</p> <p><code>bootstrap.yaml</code></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3377</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
    <span class="token key atrule">application</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>config<span class="token punctuation">-</span>client
    <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
        <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
            <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
                <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span>     <span class="token comment"># nacos服务注册中心</span>
            <span class="token key atrule">config</span><span class="token punctuation">:</span>
                <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span>     <span class="token comment"># nacos作为配置中心地址</span>
                <span class="token key atrule">file-extension</span><span class="token punctuation">:</span> yaml            <span class="token comment"># 指定yaml格式的配置</span>
</code></pre></div><p><code>application.yaml</code>：需要指定配置文件环境</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
    <span class="token key atrule">profiles</span><span class="token punctuation">:</span>
        <span class="token key atrule">active</span><span class="token punctuation">:</span> dev
</code></pre></div></li> <li><p><code>Nacos</code>的配置文件的格式为</p> <div class="language- extra-class"><pre class="language-text"><code>${prefix}-${spring.profiles.active}.${file-extension}
# 一般配置为服务名
</code></pre></div><p>以上面的配置为例，这个文件需要建在<code>nacos</code>的配置中心中</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token comment"># nacos-config-client-dev.yaml</span>

<span class="token key atrule">config</span><span class="token punctuation">:</span>
    <span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token number">1</span>
</code></pre></div></li> <li><p>新建一个<code>controller</code></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RefreshScope</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NacosConfigController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${config.version}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> version<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/config&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> version<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>测试已经可以动态修改了</p></li></ol> <h3 id="_13-3-基本概念"><a href="#_13-3-基本概念" class="header-anchor">#</a> 13.3 基本概念</h3> <p><img src="https://gitee.com/dingwanli/picture/raw/master/SpringCloud/202203162034183.png" alt=""></p> <p>默认情况：</p> <div class="language- extra-class"><pre class="language-text"><code>Namespace=public
Group=DEFAULT_GROUP
Cluster=DEFAULT
</code></pre></div><ol><li><p><code>Namespace</code>命名空间，主要用来实现隔离。</p> <p>比方说我们现在有三个环境：开发、测试、生产环境，我们可以创建三个<code>Namespace</code>，不同的<code>Namespace</code>之间是隔离的。</p></li> <li><p><code>Group</code>默认是<code>DEFAULT_GROUP</code>，<code>Group</code>可以把不同的微服务划分到同一个分组里面去</p></li> <li><p><code>Service</code>就是微服务；一个<code>Service</code>可以包含多个<code>Cluster</code>(集群)，<code>Nacos</code>默认<code>Cluster</code>是对指定微服务的一个虚拟划分。比方说为了容灾，将<code>Service</code>微服务分别部署在了杭州机房和广州机房，这时候就可以给杭州机房的<code>Service</code>微服务起一个集群名称<code>HZ</code>，给广州机房的<code>Service</code>微服务起一个集权名称<code>HZ</code>，还可以尽量让同一个机房的微服务相互调用，以提升性能</p></li> <li><p>最后就是<code>instance</code>，就是微服务的实例</p></li></ol> <h3 id="_13-4-使用详解"><a href="#_13-4-使用详解" class="header-anchor">#</a> 13.4 使用详解</h3> <ol><li><p>DataId</p> <p><code>dataId</code>就是在配置中心的文件名，可以根据<code>spring.profiles.active</code>更换不同的文件</p></li> <li><p>group如果要更换组的话，直接在<code>config</code>下更换即可</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3377</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
    <span class="token key atrule">application</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>config<span class="token punctuation">-</span>client
    <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
        <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
            <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
                <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span>     <span class="token comment"># nacos服务注册中心</span>
            <span class="token key atrule">config</span><span class="token punctuation">:</span>
                <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span>     <span class="token comment"># nacos作为配置中心地址</span>
                <span class="token key atrule">file-extension</span><span class="token punctuation">:</span> yaml            <span class="token comment"># 指定yaml格式的配置</span>
                <span class="token key atrule">group</span><span class="token punctuation">:</span> DEV_GROUP                <span class="token comment"># 指定分组</span>
</code></pre></div></li> <li><p><code>namespace</code>，更换命名空间</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3377</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
    <span class="token key atrule">application</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>config<span class="token punctuation">-</span>client
    <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
        <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
            <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
                <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span>     <span class="token comment"># nacos服务注册中心</span>
            <span class="token key atrule">config</span><span class="token punctuation">:</span>
                <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span>     <span class="token comment"># nacos作为配置中心地址</span>
                <span class="token key atrule">file-extension</span><span class="token punctuation">:</span> yaml            <span class="token comment"># 指定yaml格式的配置</span>
                <span class="token key atrule">group</span><span class="token punctuation">:</span> DEV_GROUP                <span class="token comment"># 指定分组</span>
                <span class="token key atrule">namespace</span><span class="token punctuation">:</span> c0553a5e<span class="token punctuation">-</span>ce37<span class="token punctuation">-</span>4b9c<span class="token punctuation">-</span>ad18<span class="token punctuation">-</span>b8a4ad97fcee <span class="token comment"># 指定命名空间</span>
</code></pre></div></li></ol> <h3 id="_13-5-持久化"><a href="#_13-5-持久化" class="header-anchor">#</a> 13.5 持久化</h3> <p>默认<code>Nacos</code>使用嵌入式数据库实现数据的存储。所以，如果启动多个默认配置下的<code>Nacos</code>节点，数据存储是存在一致性问题的。为了解决这个问题，<code>Nacos</code>采用了集中式存储的方式来支持集群化部署，目前仅支持<code>MySQL</code>存储。</p> <ol><li><p>在<code>nacos</code>的安装目录下，会有一个<code>conf</code>的文件夹，找到<code>nacos-mysql.sql</code>将其导入</p></li> <li><p>修改<code>conf/application.properties</code></p> <div class="language-properties extra-class"><pre class="language-properties"><code><span class="token attr-name">spring.datasource.platform</span><span class="token punctuation">=</span><span class="token attr-value">mysql</span>
<span class="token attr-name">db.num</span><span class="token punctuation">=</span><span class="token attr-value">1</span>
<span class="token attr-name">db.url.0</span><span class="token punctuation">=</span><span class="token attr-value">jdbc:mysql://127.0.0.1:3306/nacos?characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true&amp;useUnicode=true&amp;useSSL=false&amp;serverTimezone=UTC</span>
<span class="token attr-name">db.user.0</span><span class="token punctuation">=</span><span class="token attr-value">nacos</span>
<span class="token attr-name">db.password.0</span><span class="token punctuation">=</span><span class="token attr-value">nacos</span>
</code></pre></div></li></ol> <h3 id="_13-6-集群部署"><a href="#_13-6-集群部署" class="header-anchor">#</a> 13.6 集群部署</h3> <div class="spinner" style="background:rgb(66, 185, 131);" data-v-1bbcb91a></div><ol><li><p>请确保持久化工作已经完成</p></li> <li><p>将<code>conf/cluster.conf.example</code>拷贝一份</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">sudo</span> <span class="token function">cp</span> cluster.conf.example cluster.conf
</code></pre></div></li> <li><p>修改<code>cluster.conf</code>为自己的集群节点地址</p> <div class="language-conf extra-class"><pre class="language-text"><code>192.168.0.1:3344
192.168.0.1:4444
192.168.0.1:5555
</code></pre></div><p>注：不能填写<code>127.0.0.1</code></p></li> <li><p>修改nginx配置文件</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">upstream</span> cluster <span class="token punctuation">{</span>
    <span class="token keyword">server</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">3333</span><span class="token punctuation">;</span>
    <span class="token keyword">server</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">4444</span><span class="token punctuation">;</span>
    <span class="token keyword">server</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">5555</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">server</span> <span class="token punctuation">{</span>
    <span class="token keyword">listen</span>      <span class="token number">1111</span><span class="token punctuation">;</span>
    <span class="token keyword">server_name</span> localhost<span class="token punctuation">;</span>
    <span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>
        <span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>cluster<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>分别启动三个<code>nacos</code>，对应端口号为<code>3333</code>、<code>4444</code>、<code>5555</code></p></li> <li><p>访问<code>1111</code>测试</p></li></ol> <h2 id="_14-sentinel"><a href="#_14-sentinel" class="header-anchor">#</a> 14 Sentinel</h2> <p><a href="https://github.com/alibaba/Sentinel/releases/" target="_blank" rel="noopener noreferrer">下载<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>下来是一个<code>jar</code>包，直接使用<code>java -jar</code>启动即可。注意：请使用<code>java8</code>启动</p> <p>启动后访问http://localhost:8080/，用户名密码默认为<code>sentinel</code></p> <h3 id="_14-1-实例演示"><a href="#_14-1-实例演示" class="header-anchor">#</a> 14.1 实例演示</h3> <ol><li><p>新建模块<code>cloud-alibaba-sentinel-service8401</code></p></li> <li><p>导入依赖</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-sentinel<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li> <li><p>由于<code>sentinel</code>使用懒加载机制，即服务需要被请求一次后才能在控制台监控到</p></li></ol> <h3 id="_14-2-流控规则"><a href="#_14-2-流控规则" class="header-anchor">#</a> 14.2 流控规则</h3> <p>资源名：唯一名称，默认请求路径</p> <p>针对来源：<code>Sentinel</code>可以针对调用者进行限流，填写微服务名，默认<code>default</code>(不区分来源)</p> <p>阈值类型/单机阈值：</p> <ul><li><p><code>QPS</code>(每秒钟的请求数量)：当调用该<code>api</code>的<code>QPS</code>达到阈值时，进行限流</p></li> <li><p>线程数：当调用该<code>api</code>的线程数达到阈值时，进行限流</p> <p><img src="https://gitee.com/dingwanli/picture/raw/master/SpringCloud/202203171434562.png" alt=""></p></li></ul> <p>是否集群：不需要集群</p> <p>流控模式：</p> <ul><li><p>直接：<code>api</code>达到限流条件时，直接限流</p></li> <li><p>关联：当关联的资源达到阈值时，就限流自己</p></li> <li><p>链路：只记录指定链路上的流量(指定资源从入口资源进来的流量，如果达到阈值，就进行限流)【<code>api</code>级别的针对来源】</p> <p><img src="https://gitee.com/dingwanli/picture/raw/master/SpringCloud/202203171459890.png" alt=""></p> <p>当B达到1时，会限制A的访问，应用场景：A为订单接口，B为支付接口，B因为流量过载，可以限制A的请求</p></li></ul> <p>流控效果：</p> <ul><li><p>快速失败：直接失败，抛异常</p></li> <li><p><code>Warm up</code>：根据<code>codeFactory</code>(冷加载因子， 默认是3)的值，从阈值<code>/codeFactor</code>，经过预热时长，才达到设置的<code>QPS</code>阈值</p></li> <li><p>排队等待：匀速排队，让请求以匀速的速度通过，阈值类型必须设置<code>QPS</code>，否则无效</p> <p><img src="https://gitee.com/dingwanli/picture/raw/master/SpringCloud/202203171513451.png" alt=""></p> <p>冷启动，在预热时长内仅能达到单机阈值/codeFactor(默认3)，预热时长之后QPS应为单机阈值</p> <p><img src="https://gitee.com/dingwanli/picture/raw/master/SpringCloud/202203171518740.png" alt=""></p></li></ul> <p>排队等待，控制请求以相同的时间间隔处理</p> <h3 id="_14-3-熔断规则"><a href="#_14-3-熔断规则" class="header-anchor">#</a> 14.3 熔断规则</h3> <p><img src="https://gitee.com/dingwanli/picture/raw/master/SpringCloud/202203171626443.png" alt=""></p> <p>配置相应规则即可</p> <h3 id="_14-4-热点key"><a href="#_14-4-热点key" class="header-anchor">#</a> 14.4 热点key</h3> <p>编写<code>controller</code></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/testHotKey&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;testHotKey&quot;</span><span class="token punctuation">,</span> blockHandler <span class="token operator">=</span> <span class="token string">&quot;consumerHandler&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">testHostKey</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;p1&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> p1<span class="token punctuation">,</span>
                          <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;p2&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> p2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">&quot;-------TestHotKey&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">consumerHandler</span><span class="token punctuation">(</span><span class="token class-name">String</span> p1<span class="token punctuation">,</span>
                              <span class="token class-name">String</span> p2<span class="token punctuation">,</span>
                              <span class="token class-name">BlockException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">&quot;--------降级方法&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>SentinelResource</code>指定的<code>value</code>值就是需要在<code>sentinel</code>中配置的资源名，<code>blockHandler</code>为降级方法</p> <p><img src="https://gitee.com/dingwanli/picture/raw/master/SpringCloud/202203171642742.png" alt=""></p> <p><img src="https://gitee.com/dingwanli/picture/raw/master/SpringCloud/202203171651878.png" alt=""></p> <p>也可以对于特定的值进行特定的限定</p> <h3 id="_14-5-降级方法"><a href="#_14-5-降级方法" class="header-anchor">#</a> 14.5 降级方法</h3> <ol><li><p>自定义降级方法</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomerBlockHandler</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">handlerException</span><span class="token punctuation">(</span><span class="token class-name">BlockException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;全局异常处理: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p><code>controller</code>层</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RateLimitController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/byResource&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span>
            value <span class="token operator">=</span> <span class="token string">&quot;byResource&quot;</span><span class="token punctuation">,</span>
            blockHandlerClass <span class="token operator">=</span> <span class="token class-name">CustomerBlockHandler</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
            blockHandler <span class="token operator">=</span> <span class="token string">&quot;handlerException&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">byResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;按资源名称名称限流测试OK&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ol> <h3 id="_14-6-异常处理"><a href="#_14-6-异常处理" class="header-anchor">#</a> 14.6 异常处理</h3> <p>直接在<code>SentinelResource</code>注解中指定<code>fallback</code>的参数即可</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SentinelConsumerController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">SentinelPaymentClient</span> client<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${server.port}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> serverPort<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/consumer/payment/{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;fallback&quot;</span><span class="token punctuation">,</span> fallback <span class="token operator">=</span> <span class="token string">&quot;handlerPayment&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getPayment</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;抛出异常&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> client<span class="token punctuation">.</span><span class="token function">getPayment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">handlerPayment</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;serverPort: %s异常处理界面&quot;</span><span class="token punctuation">,</span> serverPort<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果<code>fallback</code>与<code>blockHandler</code>都配置的情况下，且达到流控的情况下，优先<code>blockHandler</code></p> <h3 id="_14-5-规则持久化"><a href="#_14-5-规则持久化" class="header-anchor">#</a> 14.5 规则持久化</h3> <p>默认的流控的规则是跟随服务的生命周期</p> <ol><li><p>在需要持久化的服务里导入依赖</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.csp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>sentinel-datasource-nacos<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li> <li><p>配置文件</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
    <span class="token key atrule">application</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> cloud<span class="token punctuation">-</span>alibaba<span class="token punctuation">-</span>sentinel<span class="token punctuation">-</span>service
    <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
        <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
            <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
                <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span>
        <span class="token key atrule">sentinel</span><span class="token punctuation">:</span>
            <span class="token key atrule">transport</span><span class="token punctuation">:</span>
                <span class="token comment"># sentinel dashboard的地址</span>
                <span class="token key atrule">dashboard</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8080</span>
                <span class="token comment"># 如果8080被占用,会自动从8719开始查找未被占用的端口</span>
                <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8719</span>
            <span class="token comment"># 持久化</span>
            <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
                <span class="token key atrule">ds1</span><span class="token punctuation">:</span>
                    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
                        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>spring.cloud.nacos.discovery.server<span class="token punctuation">-</span>addr<span class="token punctuation">}</span>
                        <span class="token key atrule">dataId</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>spring.application.name<span class="token punctuation">}</span>
                        <span class="token key atrule">groupId</span><span class="token punctuation">:</span> DEFAULT_GROUP
                        <span class="token key atrule">data-type</span><span class="token punctuation">:</span> json
                        <span class="token key atrule">rule-type</span><span class="token punctuation">:</span> flow
</code></pre></div></li> <li><p><code>nacos</code>中新建一个<code>cloud-alibaba-sentinel-service</code></p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
        <span class="token property">&quot;resource&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/testA&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;limitApp&quot;</span><span class="token operator">:</span> <span class="token string">&quot;default&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;grade&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token property">&quot;count&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token property">&quot;strategy&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token property">&quot;controlBehavior&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token property">&quot;clusterMode&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre></div><p><code>resource</code>：资源名称</p> <p><code>limitApp</code>：来源应用</p> <p><code>grade</code>：阈值类型，<code>0</code>表示线程数，<code>1</code>表示<code>QPS</code></p> <p><code>count</code>：单机阈值</p> <p><code>strategy</code>：流控模式，<code>0</code>表示直接，<code>1</code>表示关联，<code>2</code>表示链路</p> <p><code>controlBehavior</code>：流控效果，<code>0</code>表示快速失败，<code>1</code>表示<code>Warm Up</code>，<code>2</code>表示排毒等待</p> <p><code>clusterMode</code>：是否集群</p></li></ol> <h2 id="_15-seata"><a href="#_15-seata" class="header-anchor">#</a> 15. Seata</h2> <p>分布式事务：一次业务需要跨多个数据源或需要跨多个系统进行远程调用，就会产生分布式事务问题。</p> <p><code>Seata</code>是一款开源的分布式事务解决方案，致力于提供高性能和简单易用的分布式事务服务</p> <h3 id="_15-1-基本概念"><a href="#_15-1-基本概念" class="header-anchor">#</a> 15.1 基本概念</h3> <p><code>Transaction ID</code>：全局唯一的事务<code>ID</code></p> <p><code>Transaction Coordinator(TC)</code>：事务协调器，维护全局事务的运行状态，负责协调并驱动全局事务的提交或回滚</p> <p><code>Transaction Manager(TM)</code>：控制全局事务的边界，负责开启一个全局事务，并最终发起全局提交或全局回滚的决议</p> <p><code>Transaction Manager(RM)</code>：控制分支事务，负责分支注册、状态汇报，并接受事务协调器的指令，驱动分支(本地)事务的提交和回滚</p> <img src="https://gitee.com/dingwanli/picture/raw/master/SpringCloud/202203171958516.png" style="zoom:80%;"> <ol><li><code>TM</code>向<code>TC</code>申请开启一个全局事务，全局事务创建成功并生成一个全局唯一的<code>XID</code>;</li> <li><code>XID</code>在微服务调用链路的上下文中传播</li> <li><code>RM</code>向<code>TC</code>注册分支事务，将其纳入<code>XID</code>对应全局事务的管辖</li> <li><code>TM</code>向<code>TC</code> 发起针对<code>XID</code>的全局提交或回滚决议</li> <li><code>TC</code>调度<code>XID</code>下管辖的全部分支事务完成提交或回滚请求</li></ol> <h3 id="_15-2-下载配置"><a href="#_15-2-下载配置" class="header-anchor">#</a> 15.2 下载配置</h3> <ol><li><p><a href="https://seata.io/zh-cn/blog/download.html" target="_blank" rel="noopener noreferrer">官网下载<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p>修改<code>conf/file.conf</code></p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token comment"># 更改为数据库存储</span>
store<span class="token punctuation">.</span>mode <span class="token operator">=</span> <span class="token string">&quot;db&quot;</span>

<span class="token comment"># 数据库配置</span>
store<span class="token punctuation">.</span>db
</code></pre></div></li> <li><p>新建一个<code>seata</code>数据库，导入<a href="https://github.com/seata/seata/tree/develop/script/server/db" target="_blank" rel="noopener noreferrer">sql<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p>修改<code>conf/registry.conf</code></p> <div class="language-nginx extra-class"><pre class="language-nginx"><code>type<span class="token operator">=</span><span class="token string">&quot;nacos&quot;</span>

<span class="token comment"># 修改nacos相关的配置</span>
nacos <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div></li> <li><p>先启动<code>Nacos</code>，在启动<code>Seata</code></p></li></ol> <h3 id="_15-3-数据库搭建"><a href="#_15-3-数据库搭建" class="header-anchor">#</a> 15.3 数据库搭建</h3> <div class="spinner" style="background:rgb(66, 185, 131);" data-v-1bbcb91a></div><ol><li><p>创建三个库</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> seata_order<span class="token punctuation">;</span>
<span class="token keyword">USE</span> seata_order<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> t_order<span class="token punctuation">(</span>
    id <span class="token keyword">BIGINT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">,</span>
    user_id <span class="token keyword">BIGINT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'用户id'</span><span class="token punctuation">,</span>
    product_id <span class="token keyword">BIGINT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'产品id'</span><span class="token punctuation">,</span>
    count <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'数量'</span><span class="token punctuation">,</span>
    money <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'金额'</span><span class="token punctuation">,</span>
    <span class="token keyword">status</span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单状态：0创建中，1已完结'</span>
<span class="token punctuation">)</span><span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">7</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> seata_storage<span class="token punctuation">;</span>
<span class="token keyword">USE</span> seata_storage<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> t_storage<span class="token punctuation">(</span>
    id <span class="token keyword">BIGINT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">,</span>
    product_id <span class="token keyword">BIGINT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'产品id'</span><span class="token punctuation">,</span>
    total <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'总库存'</span><span class="token punctuation">,</span>
    used <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'已用库存'</span><span class="token punctuation">,</span>
    residue <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'剩余库存'</span>
<span class="token punctuation">)</span><span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">7</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> t_storage<span class="token punctuation">(</span>id<span class="token punctuation">,</span> product_id<span class="token punctuation">,</span> total<span class="token punctuation">,</span> used<span class="token punctuation">,</span> residue<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> seata_account<span class="token punctuation">;</span>
<span class="token keyword">USE</span> seata_account<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> t_account<span class="token punctuation">(</span>
    id <span class="token keyword">BIGINT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">,</span>
    user_id <span class="token keyword">BIGINT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'用户id'</span><span class="token punctuation">,</span>
    total <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'总额度'</span><span class="token punctuation">,</span>
    used <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'已用额度'</span><span class="token punctuation">,</span>
    residue <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span> <span class="token keyword">COMMENT</span> <span class="token string">'剩余可用额度'</span>
<span class="token punctuation">)</span><span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">7</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> t_account<span class="token punctuation">(</span>id<span class="token punctuation">,</span> user_id<span class="token punctuation">,</span> total<span class="token punctuation">,</span> used<span class="token punctuation">,</span> residue<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>每个数据库下面都需要一张<a href="https://github.com/seata/seata/tree/develop/script/client/at/db" target="_blank" rel="noopener noreferrer">日志表<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li></ol></div></section> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后修改时间: </span> <span class="time">13 days ago</span></div></footer> <!----> <div class="comments-wrapper"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:12rem;" data-v-70334359><li class="level-2" data-v-70334359><a href="/java/SpringCloud.html#_1-快速入门" class="sidebar-link reco-side-_1-快速入门" data-v-70334359>1. 快速入门</a></li><li class="level-3" data-v-70334359><a href="/java/SpringCloud.html#_1-1-需求分析" class="sidebar-link reco-side-_1-1-需求分析" data-v-70334359>1.1 需求分析</a></li><li class="level-3" data-v-70334359><a href="/java/SpringCloud.html#_1-2-远程调用" class="sidebar-link reco-side-_1-2-远程调用" data-v-70334359>1.2 远程调用</a></li><li class="level-2" data-v-70334359><a href="/java/SpringCloud.html#_2-eureka" class="sidebar-link reco-side-_2-eureka" data-v-70334359>2. Eureka</a></li><li class="level-3" data-v-70334359><a href="/java/SpringCloud.html#_2-1-eureka-server配置" class="sidebar-link reco-side-_2-1-eureka-server配置" data-v-70334359>2.1 Eureka Server配置</a></li><li class="level-3" data-v-70334359><a href="/java/SpringCloud.html#_2-2-eureka-client配置" class="sidebar-link reco-side-_2-2-eureka-client配置" data-v-70334359>2.2 Eureka Client配置</a></li><li class="level-3" data-v-70334359><a href="/java/SpringCloud.html#_2-2-eureka-集群" class="sidebar-link reco-side-_2-2-eureka-集群" data-v-70334359>2.2 Eureka 集群</a></li><li class="level-3" data-v-70334359><a href="/java/SpringCloud.html#_2-3-eureka保护模式" class="sidebar-link reco-side-_2-3-eureka保护模式" data-v-70334359>2.3 Eureka保护模式</a></li><li class="level-2" data-v-70334359><a href="/java/SpringCloud.html#_3-zookeeper" class="sidebar-link reco-side-_3-zookeeper" data-v-70334359>3. Zookeeper</a></li><li class="level-2" data-v-70334359><a href="/java/SpringCloud.html#_4-consul" class="sidebar-link reco-side-_4-consul" data-v-70334359>4. Consul</a></li><li class="level-3" data-v-70334359><a href="/java/SpringCloud.html#_4-1-安装" class="sidebar-link reco-side-_4-1-安装" data-v-70334359>4.1 安装</a></li><li class="level-3" data-v-70334359><a href="/java/SpringCloud.html#_4-2-客户端" class="sidebar-link reco-side-_4-2-客户端" data-v-70334359>4.2 客户端</a></li><li class="level-2" data-v-70334359><a href="/java/SpringCloud.html#_5-ribbon" class="sidebar-link reco-side-_5-ribbon" data-v-70334359>5. Ribbon</a></li><li class="level-3" data-v-70334359><a href="/java/SpringCloud.html#_5-1-负载均衡算法" class="sidebar-link reco-side-_5-1-负载均衡算法" data-v-70334359>5.1 负载均衡算法</a></li><li class="level-3" data-v-70334359><a href="/java/SpringCloud.html#_5-2-修改负载均衡算法" class="sidebar-link reco-side-_5-2-修改负载均衡算法" data-v-70334359>5.2 修改负载均衡算法</a></li><li class="level-3" data-v-70334359><a href="/java/SpringCloud.html#_5-3-自定义负载均衡算法" class="sidebar-link reco-side-_5-3-自定义负载均衡算法" data-v-70334359>5.3 自定义负载均衡算法</a></li><li class="level-2" data-v-70334359><a href="/java/SpringCloud.html#_6-openfeign" class="sidebar-link reco-side-_6-openfeign" data-v-70334359>6. OpenFeign</a></li><li class="level-3" data-v-70334359><a href="/java/SpringCloud.html#_6-1-服务调用" class="sidebar-link reco-side-_6-1-服务调用" data-v-70334359>6.1 服务调用</a></li><li class="level-3" data-v-70334359><a href="/java/SpringCloud.html#_6-2-超时控制" class="sidebar-link reco-side-_6-2-超时控制" data-v-70334359>6.2 超时控制</a></li><li class="level-3" data-v-70334359><a href="/java/SpringCloud.html#_6-3-日志增强" class="sidebar-link reco-side-_6-3-日志增强" data-v-70334359>6.3 日志增强</a></li><li class="level-2" data-v-70334359><a href="/java/SpringCloud.html#_7-hystrix" class="sidebar-link reco-side-_7-hystrix" data-v-70334359>7. Hystrix</a></li><li class="level-3" data-v-70334359><a href="/java/SpringCloud.html#_7-1-重要概念" class="sidebar-link reco-side-_7-1-重要概念" data-v-70334359>7.1 重要概念</a></li><li class="level-3" data-v-70334359><a href="/java/SpringCloud.html#_7-2-服务降级" class="sidebar-link reco-side-_7-2-服务降级" data-v-70334359>7.2 服务降级</a></li><li class="level-3" data-v-70334359><a href="/java/SpringCloud.html#_7-3-服务熔断" class="sidebar-link reco-side-_7-3-服务熔断" data-v-70334359>7.3 服务熔断</a></li><li class="level-3" data-v-70334359><a href="/java/SpringCloud.html#_7-4-服务监控" class="sidebar-link reco-side-_7-4-服务监控" data-v-70334359>7.4 服务监控</a></li><li class="level-2" data-v-70334359><a href="/java/SpringCloud.html#_8-gateway" class="sidebar-link reco-side-_8-gateway" data-v-70334359>8. Gateway</a></li><li class="level-3" data-v-70334359><a href="/java/SpringCloud.html#_8-1-基本概念" class="sidebar-link reco-side-_8-1-基本概念" data-v-70334359>8.1 基本概念</a></li><li class="level-3" data-v-70334359><a href="/java/SpringCloud.html#_8-2-案例" class="sidebar-link reco-side-_8-2-案例" data-v-70334359>8.2 案例</a></li><li class="level-3" data-v-70334359><a href="/java/SpringCloud.html#_8-3-动态路由" class="sidebar-link reco-side-_8-3-动态路由" data-v-70334359>8.3 动态路由</a></li><li class="level-3" data-v-70334359><a href="/java/SpringCloud.html#_8-4-断言" class="sidebar-link reco-side-_8-4-断言" data-v-70334359>8.4 断言</a></li><li class="level-3" data-v-70334359><a href="/java/SpringCloud.html#_8-5-filter" class="sidebar-link reco-side-_8-5-filter" data-v-70334359>8.5 Filter</a></li><li class="level-2" data-v-70334359><a href="/java/SpringCloud.html#_9-config" class="sidebar-link reco-side-_9-config" data-v-70334359>9. Config</a></li><li class="level-3" data-v-70334359><a href="/java/SpringCloud.html#_9-1-理论知识" class="sidebar-link reco-side-_9-1-理论知识" data-v-70334359>9.1 理论知识</a></li><li class="level-3" data-v-70334359><a href="/java/SpringCloud.html#_9-2-服务端搭建" class="sidebar-link reco-side-_9-2-服务端搭建" data-v-70334359>9.2 服务端搭建</a></li><li class="level-3" data-v-70334359><a href="/java/SpringCloud.html#_9-3-客户端搭建" class="sidebar-link reco-side-_9-3-客户端搭建" data-v-70334359>9.3 客户端搭建</a></li><li class="level-2" data-v-70334359><a href="/java/SpringCloud.html#_10-bus" class="sidebar-link reco-side-_10-bus" data-v-70334359>10. BUS</a></li><li class="level-3" data-v-70334359><a href="/java/SpringCloud.html#_10-1-基本概念" class="sidebar-link reco-side-_10-1-基本概念" data-v-70334359>10.1 基本概念</a></li><li class="level-3" data-v-70334359><a href="/java/SpringCloud.html#_10-2-rabbitmq" class="sidebar-link reco-side-_10-2-rabbitmq" data-v-70334359>10.2 RabbitMQ</a></li><li class="level-3" data-v-70334359><a href="/java/SpringCloud.html#_10-3-案例演示" class="sidebar-link reco-side-_10-3-案例演示" data-v-70334359>10.3 案例演示</a></li><li class="level-2" data-v-70334359><a href="/java/SpringCloud.html#_11-stream" class="sidebar-link reco-side-_11-stream" data-v-70334359>11. Stream</a></li><li class="level-3" data-v-70334359><a href="/java/SpringCloud.html#_11-1-常用概念" class="sidebar-link reco-side-_11-1-常用概念" data-v-70334359>11.1 常用概念</a></li><li class="level-3" data-v-70334359><a href="/java/SpringCloud.html#_11-2-生产者" class="sidebar-link reco-side-_11-2-生产者" data-v-70334359>11.2 生产者</a></li><li class="level-3" data-v-70334359><a href="/java/SpringCloud.html#_11-3-消费者" class="sidebar-link reco-side-_11-3-消费者" data-v-70334359>11.3 消费者</a></li><li class="level-3" data-v-70334359><a href="/java/SpringCloud.html#_11-4-分组" class="sidebar-link reco-side-_11-4-分组" data-v-70334359>11.4 分组</a></li><li class="level-2" data-v-70334359><a href="/java/SpringCloud.html#_12-sleuth" class="sidebar-link reco-side-_12-sleuth" data-v-70334359>12. Sleuth</a></li><li class="level-2" data-v-70334359><a href="/java/SpringCloud.html#_13-nacos" class="sidebar-link reco-side-_13-nacos" data-v-70334359>13. Nacos</a></li><li class="level-3" data-v-70334359><a href="/java/SpringCloud.html#_13-1-注册中心" class="sidebar-link reco-side-_13-1-注册中心" data-v-70334359>13.1 注册中心</a></li><li class="level-3" data-v-70334359><a href="/java/SpringCloud.html#_13-2-配置中心" class="sidebar-link reco-side-_13-2-配置中心" data-v-70334359>13.2 配置中心</a></li><li class="level-3" data-v-70334359><a href="/java/SpringCloud.html#_13-3-基本概念" class="sidebar-link reco-side-_13-3-基本概念" data-v-70334359>13.3 基本概念</a></li><li class="level-3" data-v-70334359><a href="/java/SpringCloud.html#_13-4-使用详解" class="sidebar-link reco-side-_13-4-使用详解" data-v-70334359>13.4 使用详解</a></li><li class="level-3" data-v-70334359><a href="/java/SpringCloud.html#_13-5-持久化" class="sidebar-link reco-side-_13-5-持久化" data-v-70334359>13.5 持久化</a></li><li class="level-3" data-v-70334359><a href="/java/SpringCloud.html#_13-6-集群部署" class="sidebar-link reco-side-_13-6-集群部署" data-v-70334359>13.6 集群部署</a></li><li class="level-2" data-v-70334359><a href="/java/SpringCloud.html#_14-sentinel" class="sidebar-link reco-side-_14-sentinel" data-v-70334359>14 Sentinel</a></li><li class="level-3" data-v-70334359><a href="/java/SpringCloud.html#_14-1-实例演示" class="sidebar-link reco-side-_14-1-实例演示" data-v-70334359>14.1 实例演示</a></li><li class="level-3" data-v-70334359><a href="/java/SpringCloud.html#_14-2-流控规则" class="sidebar-link reco-side-_14-2-流控规则" data-v-70334359>14.2 流控规则</a></li><li class="level-3" data-v-70334359><a href="/java/SpringCloud.html#_14-3-熔断规则" class="sidebar-link reco-side-_14-3-熔断规则" data-v-70334359>14.3 熔断规则</a></li><li class="level-3" data-v-70334359><a href="/java/SpringCloud.html#_14-4-热点key" class="sidebar-link reco-side-_14-4-热点key" data-v-70334359>14.4 热点key</a></li><li class="level-3" data-v-70334359><a href="/java/SpringCloud.html#_14-5-降级方法" class="sidebar-link reco-side-_14-5-降级方法" data-v-70334359>14.5 降级方法</a></li><li class="level-3" data-v-70334359><a href="/java/SpringCloud.html#_14-6-异常处理" class="sidebar-link reco-side-_14-6-异常处理" data-v-70334359>14.6 异常处理</a></li><li class="level-3" data-v-70334359><a href="/java/SpringCloud.html#_14-5-规则持久化" class="sidebar-link reco-side-_14-5-规则持久化" data-v-70334359>14.5 规则持久化</a></li><li class="level-2" data-v-70334359><a href="/java/SpringCloud.html#_15-seata" class="sidebar-link reco-side-_15-seata" data-v-70334359>15. Seata</a></li><li class="level-3" data-v-70334359><a href="/java/SpringCloud.html#_15-1-基本概念" class="sidebar-link reco-side-_15-1-基本概念" data-v-70334359>15.1 基本概念</a></li><li class="level-3" data-v-70334359><a href="/java/SpringCloud.html#_15-2-下载配置" class="sidebar-link reco-side-_15-2-下载配置" data-v-70334359>15.2 下载配置</a></li><li class="level-3" data-v-70334359><a href="/java/SpringCloud.html#_15-3-数据库搭建" class="sidebar-link reco-side-_15-3-数据库搭建" data-v-70334359>15.3 数据库搭建</a></li></ul></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div><div id="live2d-widget" class="live2d-widget-container" style="position:fixed;left:50px;bottom:0px;width:135px;height:300px;z-index:99999;opacity:0.8;pointer-events:none;"><canvas id="live2d_canvas" width="135" height="300" class="live2d_canvas" style="position:absolute;left:0px;top:0px;width:135px;height:300px;"></canvas></div></div></div>
    <script src="/assets/js/app.e924ca4b.js" defer></script><script src="/assets/js/3.7270c5c5.js" defer></script><script src="/assets/js/1.86f97011.js" defer></script><script src="/assets/js/38.7146353c.js" defer></script>
  </body>
</html>
